# æƒ³è¦è®“ä»–è®ŠæˆPWAï¼Œæœ€å¥½ iOS ä¹Ÿèƒ½æ­£å¸¸

## [2026-02-07] ychsue é–‹å§‹è¨è«–

1. ç”±æ–¼ä½¿ç”¨GASä¾†æ“ç¸± Google Sheets å¯¦åœ¨æœ‰é»æ…¢ï¼Œå¶è€Œæœƒå¤±æ•—ï¼Œæ‰€ä»¥æƒ³èªªï¼Œè‹¥ä¹¾è„†å¯« SPAï¼Œç„¶å¾ŒåŒ…è£æˆPWAï¼Œç„¶å¾Œï¼Œå®šæ™‚èˆ‡Google Sheets åŒæ­¥ï¼Œç„¶å¾Œ iOS çš„æ·å¾‘è£¡çš„ URL æ”¹æˆé€™å€‹PWAçš„URL (ä»–çš„report å¯ä»¥ä»¥ POST çš„æ–¹å¼çµ¦æ·å¾‘åƒå—ï¼Ÿ) æ‚¨è¦ºå¾—å¯è¡Œå—ï¼Ÿ
2. ä¸€å€‹ç–‘å•ï¼ŒPWAæœ‰è¾¦æ³•åœ¨ä½¿ç”¨è€…åŒæ„å¾Œï¼ŒæŒçºŒ(é›¢é–‹è©²ç¶²é ä¸€æ®µæ™‚é–“æ‰å›ä¾†)èƒ½å­˜å–æŸå¼µ Google Sheets æª”æ¡ˆå—ï¼Ÿ
3. ç¨‹å¼ç¢¼éƒ½åœ¨ [gas/src](../gas/src/)è£¡é¢ï¼Œç¾åœ¨ï¼Œè‹¥è¦è®Šæˆä¹Ÿè¦ç”¨åœ¨ PWA ä¸Šé¢ï¼Œæˆ‘æ˜¯æƒ³èªªä»¥ `Dexie.js` ä¾†ç•¶ local è³‡æ–™åº«ï¼Œ`Material React Table` æˆ– `Tanstack Table` ç•¶ä½œ Sheets çµ¦ä½¿ç”¨è€…ç·¨è¼¯èˆ‡è§€çœ‹ç”¨
4. æ‰€ä»¥ï¼Œé€™å€‹å°ˆæ¡ˆå°±æœ‰å…©éƒ¨åˆ†ï¼Œä¸€å€‹ç¹¼çºŒæä¾› GAS ç‰ˆæœ¬ï¼Œå¦ä¸€å€‹å‰‡æ˜¯ SPA (PWA) ç‰ˆæœ¬
5. PWA ç‰ˆæœ¬ç°¡å–®è¬›å°±æ˜¯å°‡æœ¬ä¾†åœ¨ Google Sheets å’Œ GAS çš„æ±è¥¿éƒ½æ”¹åˆ°å‰ç«¯å®¢æˆ¶ç«¯åšï¼ŒiOS æ·å¾‘å‰‡æ”¹é€£çµåˆ°æ­¤URLï¼Œå®šæ™‚æˆ–æä¾›æŒ‰éˆ•èˆ‡ Google Sheets åŒæ­¥ (é€™å€‹åŒæ­¥å°±éœ€è¦æ€è€ƒäº†)

è«‹å•æ‚¨å¯ä»¥å…ˆå°±ä¸Šé¢äº”é»åœ¨æ­¤æª”è¨è«–ï¼Œç„¶å¾Œä»¥ [Mermaid Mind Map](/Discussion\8th_mind_map.md) ä¾†æ€è€ƒå—ï¼Ÿè¬è¬ã€‚

## [2026-02-10] æŠ€è¡“å¯è¡Œæ€§åˆ†æèˆ‡å»ºè­°

### å›ç­”ç¬¬1é»ï¼šSPA/PWA + å®šæ™‚åŒæ­¥çš„å¯è¡Œæ€§ âœ…

#### **çµè«–ï¼šå®Œå…¨å¯è¡Œï¼Œä¸”æ¯” GAS ç‰ˆæœ¬å„ªå‹¢æ˜é¡¯**

**å„ªå‹¢ï¼š**

**åŒæ­¥ç­–ç•¥å»ºè­°ï¼š**

```javascript
// æœ¬åœ°å„ªå…ˆæ¶æ§‹ï¼ˆLocal-First Architectureï¼‰
ä½¿ç”¨è€…æ“ä½œ â†’ ç«‹å³å¯«å…¥ Dexie.js (å³æ™‚åæ‡‰)
         â†’ æ¨™è¨˜ç‚º "å¾…åŒæ­¥" 
         â†’ Service Worker å®šæœŸï¼ˆå¦‚æ¯ 5 åˆ†é˜ï¼‰èˆ‡ Google Sheets åŒæ­¥
         â†’ è¡çªè§£æ±ºå„ªå…ˆæ¬Šï¼šæœ¬åœ°æ™‚é–“æˆ³ç‚ºä¸»
```

### å›ç­”ç¬¬2é»ï¼šPWA çš„ Google Sheets æŒçºŒè¨ªå•æ¬Š âš ï¸

çµè«–ï¼šå¯ä»¥ï¼Œä½†éœ€è¦ç‰¹æ®Šè¨­è¨ˆ

é—œéµï¼šGoogle OAuth çš„ Refresh Token æ©Ÿåˆ¶
// é¦–æ¬¡æˆæ¬Šæµç¨‹
ä½¿ç”¨è€…é»æ“Š "é€£æ¥ Google Sheets" â†’ é–‹å•Ÿ Google OAuth Dialog
  â†“
åŒæ„æˆæ¬Š â†’ å–å¾— Access Token + Refresh Token
  â†“
å°‡ Refresh Token å­˜å…¥ IndexedDBï¼ˆåŠ å¯†ï¼‰
  â†“
Access Token éæœŸ (1å°æ™‚) â†’ è‡ªå‹•ç”¨ Refresh Token æ›´æ–°

### å›ç­”ç¬¬3é»ï¼šé‡ç”¨ä»£ç¢¼èˆ‡æ¡†æ¶é¸æ“‡ âœ…

å®Œå…¨å¯ç§»æ¤çš„ä»£ç¢¼æ¨¡çµ„ï¼š

|æ–‡ä»¶|å…§å®¹|é‡ç”¨æ€§|å‚™è¨»|
|--|--|--|--|
|Utils.js|IDç”Ÿæˆã€æ™‚é–“è¨ˆç®—ã€Cronè§£æ|100% å¯ç§»æ¤|croner.min.js å·²åŒ…å«|
|Logic.js|æ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼ˆSTART/END/ADD_INBOX ç­‰ï¼‰|95% å¯ç§»æ¤|éœ€ç§»é™¤ Google Sheets ç›¸é—œèª¿ç”¨|
|Config.js|ç‹€æ…‹å¸¸é‡ã€å·¥ä½œè¡¨åç¨±|100% å¯ç§»æ¤|é©é…ç‚ºè³‡æ–™åº«è¡¨å|

æ¡†æ¶å»ºè­°å°æ¯”ï¼š

#### **Material React Table**

- âœ… æ›´æˆç†Ÿï¼Œæ–‡æª”å®Œæ•´
- âœ… èˆ‡ Material-UI æ·±åº¦é›†æˆ
- âœ… é©åˆä¼æ¥­ç´šæ‡‰ç”¨
- âŒ Bundle è¼ƒå¤§ï¼ˆ~150KBï¼‰

#### **TanStack Table (Headless UI)**

- âœ… æ›´è¼•é‡ï¼ˆ~13KBï¼‰ï¼Œé«˜åº¦è‡ªè¨‚
- âœ… æ¡†æ¶ç„¡é—œï¼ˆå¯ç”¨ Vue/Angularï¼‰
- âœ… æ•ˆèƒ½æ›´å¥½ï¼ˆè™›æ“¬åŒ–æ»¾å‹•å…§ç½®ï¼‰
- âŒ éœ€è¦è‡ªå·±å¯«æ¨£å¼
- å»ºè­°ï¼š è‹¥çµ¦ç”¨æˆ¶çš„ç³»çµ±ä¸è¶…é 100-200 å€‹ä»»å‹™ï¼Œç”¨ TanStack Table + TailwindCSSï¼›è‹¥éœ€è¦ä¼æ¥­ç´š UI å‰‡ç”¨ Material React Table

---

### å›ç­”ç¬¬4é»ï¼šé›™ç‰ˆæœ¬ä¸¦è¡Œç¶­è­·ç­–ç•¥ ğŸ“¦

æ¶æ§‹å»ºè­°ï¼š
NonBlockingLife/
â”œâ”€â”€ gas/                          # âœ… ä¿æŒç¾æœ‰ç‰ˆæœ¬
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ Logic.js              â† é‚è¼¯ã€ŒåŸä»¶ã€
â”‚       â”œâ”€â”€ Utils.js              â† å…±äº«å·¥å…·åº«
â”‚       â”œâ”€â”€ Config.js             â† å…±äº«çš„å¸¸æ•¸å®šç¾©
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ pwa/                          # æ–°å¢ PWA ç‰ˆæœ¬
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ core/                 # å…±äº«å±¤ï¼ˆLogic, Utils, Config çš„å‰ç«¯ç‰ˆæœ¬ï¼‰
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ db/                   # Dexie.js æ•¸æ“šå±¤
â”‚       â””â”€â”€ components/           # React UI
â”‚
â””â”€â”€ shared/                       # å¯é¸ï¼šæå–å…±äº«ä»£ç¢¼åˆ°çµ±ä¸€ä½ç½®
    â”œâ”€â”€ logic/
    â”œâ”€â”€ utils/
    â””â”€â”€ types/

// ç‰ˆæœ¬ç®¡ç†å»ºè­°
GAS ç‰ˆæœ¬ï¼šä¿æŒç‚ºã€Œç©©å®šã€ç·šï¼Œä¸»è¦ç”¨æ–¼å‚™ä»½å’Œ iOS æ·å¾‘ç›´é€£
PWA ç‰ˆæœ¬ï¼šç‚ºã€Œä¸»è¦ã€ç·šï¼Œå„ªå…ˆé–‹ç™¼æ–°åŠŸèƒ½å’Œæ”¹é€²

---

### å›ç­”ç¬¬5é»ï¼šåŒæ­¥è¨­è¨ˆçš„æ·±åº¦æ€è€ƒ ğŸ”„

ä¸‰å±¤åŒæ­¥æ¶æ§‹ï¼š

``` md
ç¬¬1å±¤ï¼šä½¿ç”¨è€…æ“ä½œå±¤ï¼ˆå³æ™‚ï¼‰
  â”œâ”€ ä½¿ç”¨è€…åœ¨è¡¨æ ¼ç·¨è¼¯ Task â†’ å¯«å…¥æœ¬åœ° Dexie.js
  â””â”€ UI ç«‹å³æ›´æ–°ï¼Œç„¡éœ€ç­‰å¾…ç¶²è·¯

ç¬¬2å±¤ï¼šè‡ªå‹•å¾Œå°åŒæ­¥å±¤ï¼ˆå®šæœŸï¼‰
  â”œâ”€ Service Worker æ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
  â”œâ”€ è‹¥æœ‰å¾…åŒæ­¥é …ç›® â†’ æ‰¹é‡ä¸Šå‚³åˆ° Google Sheets
  â””â”€ è‹¥ Google Sheets æœ‰æ›´æ–° â†’ ä¸‹è¼‰åˆä½µ

ç¬¬3å±¤ï¼šiOS æ·å¾‘å¿«é€Ÿå¯«å…¥å±¤ï¼ˆäº‹ä»¶é©…å‹•ï¼‰
  â”œâ”€ iOS æ·å¾‘ POST data åˆ° PWA URL  â† æ”¹å‹•é»
  â”œâ”€ PWA æ”¶å–è«‹æ±‚ â†’ å¯«å…¥ Dexie.js + æ¨™è¨˜åŒæ­¥
  â””â”€ åŒä¸€æ™‚åˆ»å›å‚³çµæœï¼ˆé GAS çš„ JSON è€Œæ˜¯ PWA æœ¬åœ°çµæœï¼‰
```

è¡çªè§£æ±ºç­–ç•¥ï¼š

```js
// å ´æ™¯ï¼šPWA æœ¬åœ° START äº† Task_Aï¼ŒåŒæ™‚ iOS æ·å¾‘ä¹Ÿ START äº† Task_A
// è§£æ±ºæ–¹å¼ï¼š
if (lastModified.local > lastModified.sheets) {
  // æœ¬åœ°æ›´æ–°æ™‚é–“è¼ƒæ–°ï¼Œä¿¡ä»»æœ¬åœ°ç‰ˆæœ¬
  uploadToSheets(localData)
} else {
  // Google Sheets æ›´æ–°è¼ƒæ–°ï¼Œä¸‹è¼‰ä¸¦è¦†è“‹
  mergeWithSheets(sheetsData)
  showConflictWarning()
}
```

åŒæ­¥å¤±æ•—çš„é™ç´šç­–ç•¥ï¼š

``` md
è‹¥ç„¡æ³•é€£æ¥ Google Sheets API
  â†“
PWA ç¹¼çºŒä»¥æœ¬åœ°ç‰ˆæœ¬é‹ä½œï¼ˆOffline-Firstï¼‰
  â†“
é¡¯ç¤º "å·²é›¢ç·šï¼Œç·¨è¼¯å·²ä¿å­˜åˆ°æœ¬æ©Ÿ" çš„é€šçŸ¥
  â†“
ç¶²è·¯æ¢å¾© â†’ è‡ªå‹•åŒæ­¥ï¼Œç„¡éœ€ä½¿ç”¨è€…å¹²é 
```

ğŸ“Š æŠ€è¡“æ£§åŠå¯é‡ç”¨ä»£ç¢¼æ¯”ä¾‹
æ ¹æ“šä»£ç¢¼åˆ†æï¼š

- Logic.jsï¼ˆ~400 è¡Œï¼‰ â†’ 95% å¯ç›´æ¥ç§»æ¤ âœ…
- Utils.jsï¼ˆ~300 è¡Œï¼‰ â†’ 100% å¯ç›´æ¥ç§»æ¤ âœ…
- SheetsService.jsï¼ˆ~250 è¡Œï¼‰ â†’ 0% å¯ç§»æ¤ï¼Œéœ€é‡æ–°å¯¦ç¾ Dexie ç‰ˆæœ¬ âŒ
- ç¸½è¨ˆå¯é‡ç”¨ï¼š~700 è¡Œ / ~950 è¡Œ = 73.7%

é€™æ„å‘³è‘— PWA ç‰ˆæœ¬å¤§ç´„å¯ä»¥ç¯€çœ 70% çš„æ¥­å‹™é‚è¼¯é–‹ç™¼æ™‚é–“ã€‚

---

## ğŸ“‹ å¾ŒçºŒè¨è«–å»ºè­°

æ ¹æ“šä¸Šè¿°åˆ†æï¼Œæˆ‘å»ºè­°æŒ‰ä»¥ä¸‹é †åºæ·±å…¥è¨è«–ï¼š

1. [ ] **åŒæ­¥è¡çªè§£æ±ºçš„è©³ç´°è¦å‰‡** - éœ€è¦å®šç¾©å„ªå…ˆç´šï¼ˆæœ¬åœ°/é ç«¯/äººå·¥ä»‹å…¥ï¼‰
2. [ ] **Google OAuth Token çš„æŒä¹…åŒ–å’Œå®‰å…¨** - æ¶‰åŠæ•æ„Ÿæ•¸æ“šï¼Œéœ€åŠ å¯†å­˜å„²
3. [ ] **iOS æ·å¾‘çš„ API è¨­è¨ˆ** - éœ€è¦æ±ºå®š POST çš„æ•¸æ“šæ ¼å¼æ˜¯å¦æ”¹è®Š
4. [x] **Dexie.js Schema è¨­è¨ˆ** - éœ€è¦å¾ Google Sheets çš„ 6 å€‹è¡¨æ˜ å°„åˆ°æœ¬åœ°çµæ§‹

æ‚¨æƒ³å…ˆæ·±å…¥è¨è«–å…¶ä¸­å“ªå€‹ä¸»é¡Œå‘¢ï¼Ÿ

================================================================

---

## [2026-02-10] ychsue é‚£éº¼ï¼Œè‹¥ä½¿ç”¨ Tanstack Start æœƒæ¯”è¼ƒå®¹æ˜“å¯«èˆ‡ç¶­è­·å—ï¼Ÿ

## [2026-02-10] é‡å°ã€ŒTanStack Start æ˜¯å¦æ›´å®¹æ˜“å¯«èˆ‡ç¶­è­·ã€

**çµè«–ï¼šä¸æ¨è–¦ï¼Œè‡³å°‘ç›®å‰ä¸é©åˆã€‚åŸå› å¦‚ä¸‹ï¼š**

### ç‚ºä»€éº¼ä¸é¸ TanStack Start

| å› ç´  | è©•ä¼° |
| ------ | ----- |
| ä¸€äººç¶­è­· | âŒ å­¸ç¿’æ›²ç·šå¤ªé™¡ï¼Œé‡åˆ°å•é¡Œç„¡äººå¹«åŠ© |
| ç´”å‰ç«¯ PWA | âŒ TanStack Start æ˜¯å…¨æ£§æ¡†æ¶ï¼ŒåŠŸèƒ½éå‰© |
| ç„¡å¾Œç«¯éœ€æ±‚ | âŒ å…¶æ ¸å¿ƒå„ªå‹¢ï¼ˆServer Componentsã€RPCï¼‰æ´¾ä¸ä¸Šç”¨ |
| ç¤¾å€æˆç†Ÿåº¦ | âš ï¸ ç›¸å°è¼ƒæ–°ï¼ˆ2024å¹´ï¼‰ï¼Œä¸å¤ ç©©å®š |
| PWA æ”¯æ´ | âŒ æ²’æœ‰å…§ç½® PWA æ”¯æ´ï¼Œéœ€æ‰‹å·¥é…ç½® |
| Bundle é«”ç© | âš ï¸ ç„¡å¾Œç«¯æƒ…æ³ä¸‹é«”ç©æ›´å¤§ï¼ˆ50-80KBï¼‰ |

### æ¨è–¦çš„æŠ€è¡“æ£§

React 18 + Vite
â”œâ”€ TanStack Table (è¡¨æ ¼)
â”œâ”€ TanStack Router (è·¯ç”±) âœ“ ä¿æŒç”Ÿæ…‹ä¸€è‡´æ€§
â”œâ”€ Dexie.js (æœ¬åœ° DB)
â”œâ”€ TailwindCSS (æ¨£å¼)
â””â”€ vite-plugin-pwa (PWA æ‰“åŒ…)

### ç‚ºä»€éº¼é€™å€‹çµ„åˆæ›´å¥½

1. **ç¶­è­·æˆæœ¬ä½**ï¼šä¸€äººå¯å®Œæ•´æŒæ¡ï¼Œç¤¾å€è³‡æºè±å¯Œ
2. **é–‹ç™¼é€Ÿåº¦å¿«**ï¼šVite å†·å•Ÿå‹• <100msï¼ŒHMR ç§’ç´š
3. **Bundle æ›´å°**ï¼šCore åªéœ€ ~30KBï¼Œç›¸æ¯” TanStack Start çš„ 50-80KB è¼• 40%
4. **PWA æˆç†Ÿ**ï¼švite-plugin-pwa æ˜¯æ¥­ç•Œæ¨™æº–ï¼Œæ–‡æª”å®Œæ•´
5. **é›¢ç·šå„ªå…ˆ**ï¼šèˆ‡ Dexie.js æ­é…æ˜¯è¡Œæ¥­æœ€ä½³å¯¦è¸
6. **æœªä¾†éˆæ´»**ï¼šè‹¥éœ€å¾Œç«¯ï¼Œå¯é¸æ“‡ Remix / Next.js / TanStack Startï¼Œç„¡ç¼é·ç§»

### ä½•æ™‚æ‰éœ€è¦ TanStack Start

- éœ€è¦å¾Œç«¯ä¾†å„²å­˜ Google OAuth Refresh Tokenï¼ˆå®‰å…¨è€ƒé‡ï¼‰
- åŒæ­¥é‚è¼¯è¤‡é›œåˆ°éœ€è¦ä¼ºæœå™¨å”èª¿
- åœ˜éšŠæ“´å±•åˆ° 3+ äººï¼Œéœ€è¦å…¨æ£§æ¨™æº–åŒ–æµç¨‹

**ç›®å‰å»ºè­°ï¼šæ¨é²æ±ºç­–ï¼Œå…ˆç”¨å‚³çµ± React + Vite å®Œæˆ MVPï¼Œè‹¥ç¢ºå¯¦éœ€è¦å¾Œç«¯å†è€ƒæ…®å‡ç´šã€‚**

ç°¡å–®èªªï¼šTanStack Start æ˜¯å¥½æ¡†æ¶ï¼Œä½†å°æ‚¨ã€Œä¸€äºº + ç´”å‰ç«¯ + ç„¡å¾Œç«¯ã€çš„å ´æ™¯æ˜¯éåº¦è¨­è¨ˆã€‚é¸ React + Vite + TanStack Table + Dexie.jsï¼Œæ—¢èƒ½ç”¨åˆ° TanStack çš„ç”Ÿæ…‹å„ªå‹¢ï¼Œåˆä¿æŒç°¡æ½”é«˜æ•ˆã€‚

æ‚¨æƒ³è®“æˆ‘è©³ç´°è¦åŠƒé€™å€‹æŠ€è¡“æ£§çš„å¯¦æ–½æ­¥é©Ÿå—ï¼Ÿ

===============================================================

---

## [2026-02-10] ychsue é‚£éº¼è«‹å•ä½¿ç”¨ React 19 æœƒæ¯” React 18 å¥½å—ï¼Ÿæˆ‘çŸ¥é“ä»–å¤šäº† Server Component ç­‰ï¼Œé›–ç„¶åœ¨é€™è£¡ç”¨ä¸åˆ°ï¼Œä½†æˆ‘çœ‹ç¶²é æœ‰çš„èªªå¥¹èƒ½å¤§å¹…é™ä½ä¸å¿…è¦çš„ useMemo ç­‰é¿å…é‡è¤‡æ¸²æŸ“çš„å•é¡Œ

## [2026-02-10] React 19 vs React 18 çš„é¸æ“‡

### çµè«–ï¼šæš«æ™‚ä½¿ç”¨ React 18.3+ï¼Œæ¨é²å‡ç´šåˆ° React 19

### ç‚ºä»€éº¼ React 19 çš„ Compiler å°æ‚¨æ”¶ç›Šæœ‰é™

**æ‚¨æåˆ°çš„ã€Œå¤§å¹…é™ä½ useMemoã€ç¢ºå¯¦æ˜¯ React 19 çš„æ ¸å¿ƒæ”¹é€²ï¼Œä½†æœ‰ 3 å€‹å•é¡Œï¼š**

1. **æ‚¨çš„é …ç›®é‚„ç”¨ä¸åˆ°**
   - è¡¨æ ¼æ‡‰ç”¨çš„æ€§èƒ½ç“¶é ¸ä¸åœ¨ã€Œéåº¦æ¸²æŸ“ã€
   - ä¸»è¦ç“¶é ¸ï¼šDexie.js æŸ¥è©¢ + Google Sheets API å»¶é²ï¼ˆèˆ‡ React ç„¡é—œï¼‰

2. **Compiler é‚„åœ¨è©¦é©—éšæ®µ**
   - ä¸¦éæ‰€æœ‰ä»£ç¢¼éƒ½èƒ½å„ªåŒ–ï¼ŒæŸäº›æ¨¡å¼éœ€æ‰‹å·¥èª¿æ•´
   - ä½œç‚ºä¸€äººåœ˜éšŠï¼Œé‡åˆ° edge case ç„¡äººå¹«åŠ©

3. **ä¾è³´åº«å…¼å®¹æ€§é¢¨éšª**
   - TanStack Table âœ…ã€Dexie.js âœ… éƒ½æ”¯æŒ
   - ä½†å‡ç´šéç¨‹ä¸­å¯èƒ½å‡ºç¾æ–°çš„ä¸å…¼å®¹æƒ…æ³
   - ä¸€äººç¶­è­·ç„¡æ³•å¿«é€Ÿæ‡‰å°

### å¯¦éš›æ€§èƒ½æ”¶ç›Šå°æ¯”

| å„ªåŒ–æ–¹å¼ | æˆæœ¬ | æ”¶ç›Š | æ¨è–¦åº¦ |
| --------- | ------ | ------ | -------- |
| React 19 Compiler | ä½ï¼ˆè‡ªå‹•ï¼‰ | ~2-5% | â­â­ |
| è¡¨æ ¼è™›æ“¬åŒ–ï¼ˆTanStackï¼‰ | é›¶ï¼ˆå·²æœ‰ï¼‰ | ~20-30% | âœ…âœ…âœ… |
| Dexie.js ç´¢å¼•å„ªåŒ– | ä¸­ | ~15-25% | âœ…âœ…âœ… |
| Google Sheets æ‰¹é‡åŒæ­¥ | ä¸­ | ~10-20% | âœ…âœ… |

### æ¨è–¦æ–¹æ¡ˆ

#### **ç¾åœ¨é¸æ“‡ï¼šReact 18.3+**

- å®Œæ•´çš„ç”Ÿæ…‹æ”¯æŒ
- ä¸€äººç¶­è­·é¢¨éšªæœ€ä½
- React 18 å·²è¶³ä»¥æ”¯æ’æ¨¹ 500+ çµ„ä»¶

**å‡ç´šæ¢ä»¶ï¼š**

- React 19.1+ æ­£å¼ç©©å®šç™¼å¸ƒ
- TanStack å…¨ç³»åˆ—å®˜æ–¹ç¢ºèªå®Œå…¨æ”¯æŒ
- ç¢ºå¯¦é‡åˆ°äº† React 18 ç„¡æ³•è§£æ±ºçš„æ€§èƒ½ç“¶é ¸

### æ€§èƒ½å„ªåŒ–å„ªå…ˆç´šï¼ˆä¸ä¾è³´ React ç‰ˆæœ¬ï¼‰

1. **è¡¨æ ¼è™›æ“¬åŒ–** - æ‚¨å·²åœ¨ç”¨ TanStack Table âœ“
2. **Dexie æŸ¥è©¢å„ªåŒ–** - æ·»åŠ åˆé©çš„ç´¢å¼•å’ŒæŸ¥è©¢ç­–ç•¥
3. **Google Sheets åŒæ­¥ç­–ç•¥** - æ‰¹é‡æ“ä½œè€Œéå¯¦æ™‚åŒæ­¥
4. **Service Worker ç·©å­˜** - æ¸›å°‘ API å¾€è¿”

é€™äº›å„ªåŒ–åœ¨ React 18 ä¸­å®Œå…¨å¯è¡Œï¼Œæ”¶ç›Š 20-50%ï¼Œé é«˜æ–¼å‡ç´šåˆ° React 19 çš„ ~5% æ”¶ç›Šã€‚

=========================================================

## [2026-02-10] ychsue éå¸¸æœ‰é“ç†ï¼Œé‚£å°± React 18 å³å¯ï¼Œé‚£éº¼ï¼Œ Tanstack Query æœƒæœ‰å¹«åŠ©å—ï¼Ÿ

### Answer

``` js
// æ‚¨çœŸæ­£éœ€è¦çš„é †åº

1ï¸âƒ£ Dexie.js âœ… (å·²æ±ºå®š)
   â””â”€ æœ¬åœ°æ•¸æ“šå±¤ï¼Œå¿«é€Ÿå¯é 

2ï¸âƒ£ Service Worker åŒæ­¥ âœ… (å·²è¦åŠƒ)
   â””â”€ å¾Œå°ä¿æŒ Google Sheets åŒæ­¥

3ï¸âƒ£ ç‹€æ…‹ç®¡ç† (Zustand / Jotai) âœ… éœ€è¦
   â”œâ”€ è¿½è¹¤ã€Œå“ªäº›æ•¸æ“šå¾…åŒæ­¥ã€
   â”œâ”€ ç®¡ç†ã€ŒåŒæ­¥ç‹€æ…‹ã€(syncing / error)
   â”œâ”€ ç®¡ç†ã€ŒiPhone æ·å¾‘ APIã€çš„è«‹æ±‚ç‹€æ…‹
   â””â”€ // TanStack Query ä¸æ“…é•·é€™å€‹

4ï¸âƒ£ TanStack Query âŒ å¯é¸
   â””â”€ èƒ½åšçš„éƒ½è¢« Dexie + Service Worker åšäº†
   â””â”€ ä¸èƒ½åšçš„ï¼ˆè¤‡é›œåŒæ­¥é‚è¼¯ï¼‰éœ€è¦è‡ªå®šç¾©
   â””â”€ å¼•å…¥å¢åŠ è¤‡é›œåº¦
```

âœ… æ¨è–¦çš„æ›¿ä»£æ–¹æ¡ˆ
èˆ‡å…¶ç”¨ TanStack Queryï¼Œä¸å¦‚ç”¨é€™å€‹æ›´ç°¡å–®çš„çµ„åˆï¼š

``` js
// æ–¹æ¡ˆ Aï¼šç°¡æ½”æ–¹æ¡ˆï¼ˆæ¨è–¦ï¼‰
import { create } from 'zustand'
import { subscribeWithSelector } from 'zustand/middleware'

const useTaskStore = create(
  subscribeWithSelector((set) => ({
    tasks: [],
    syncStatus: 'idle', // 'idle' | 'syncing' | 'error'
    
    // å¾ Dexie åŠ è¼‰æœ¬åœ°æ•¸æ“šï¼ˆå¾ˆå¿«ï¼Œé€šå¸¸ <10msï¼‰
    loadLocal: async () => {
      const tasks = await db.tasks.toArray()
      set({ tasks })
    },
    
    // è§¸ç™¼å¾Œå°åŒæ­¥ï¼ˆService Worker æœƒæ¥ç®¡ï¼‰
    triggerSync: () => {
      set({ syncStatus: 'syncing' })
      // Service Worker æœƒåœ¨å¾Œå°è™•ç†ï¼Œå®Œæˆæ™‚é€šé postMessage é€šçŸ¥
    },
    
    setSyncStatus: (status) => set({ syncStatus: status }),
  }))
)

// åœ¨çµ„ä»¶ä¸­ä½¿ç”¨
function TaskTable() {
  const tasks = useTaskStore((state) => state.tasks)
  const syncStatus = useTaskStore((state) => state.syncStatus)
  
  useEffect(() => {
    useTaskStore.getState().loadLocal()
  }, [])
  
  return (
    <>
      {syncStatus === 'syncing' && <Spinner />}
      <Table data={tasks} />
    </>
  )
}
```

å„ªé»ï¼š

ç°¡æ½”æ˜ç­ï¼ˆZustand åªæœ‰ Jotai çš„ 1/5 è¤‡é›œæ€§ï¼‰
èˆ‡ Dexie.js é«˜åº¦å”èª¿
Service Worker é€šä¿¡ç›´æ¥ï¼Œç„¡ä¸­é–“å±¤
ä¸€äººç¶­è­·å®Œå…¨å‹ä»»
æœ€çµ‚ Bundle å¤§å°ï¼šZustand ~1KBï¼ˆvs TanStack Query ~40KBï¼‰

## [2026-02-10] TanStack Query æ˜¯å¦æœ‰å¹«åŠ©ï¼Ÿ

### çµè«–ï¼šä¸æ¨è–¦ï¼Œæœƒå¢åŠ ä¸å¿…è¦çš„è¤‡é›œåº¦

### ç‚ºä»€éº¼ TanStack Query ä¸é©åˆæ‚¨

**TanStack Query çš„æ ¸å¿ƒåƒ¹å€¼æ˜¯ï¼š**

- çµ±ä¸€ç®¡ç†å¤šå€‹æœå‹™å™¨çš„æ•¸æ“šç²å–
- è‡ªå‹•å¿«å–ã€é‡è©¦ã€å¾Œå°é‡æ–°ç²å–
- è¤‡é›œçš„ç‹€æ…‹ç®¡ç†

**æ‚¨çš„é …ç›®ç‰¹æ€§ï¼š**

- æ•¸æ“šæºå–®ä¸€ï¼ˆGoogle Sheetsï¼Œé€šé Dexie.jsï¼‰
- å·²æœ‰å¿«å–å±¤ï¼ˆDexie.js IndexedDBï¼‰
- å·²æœ‰å¾Œå°åŒæ­¥æ©Ÿåˆ¶ï¼ˆService Workerï¼‰
- æ²’æœ‰å¤šå€‹æœå‹™å™¨çš„åŒæ­¥è¤‡é›œåº¦

### å…·é«”å°æ¯”

| åŠŸèƒ½ | æ‚¨éœ€è¦ï¼Ÿ | ç•¶å‰æ–¹æ¡ˆ | TanStack Query å¸¶ä¾†çš„æ·¨åƒ¹å€¼ |
| ------ | --------- | --------- | ----- |
| æœ¬åœ°å¿«å– | âœ… | Dexie.js | âŒ é‡è¤‡ |
| å¾Œå°åŒæ­¥ | âœ… | Service Worker | âŒ é‡è¤‡ |
| å¤±æ•—é‡è©¦ | ğŸŸ¡ | ç„¡ | âš ï¸ å¾®é‡ï¼ˆåªæœ‰ Google Sheets APIï¼‰ |
| åŠ è¼‰ç‹€æ…‹ | âœ… | éœ€è¦ | âœ… å¯ä»¥ç°¡åŒ–ï¼ˆä½† Zustand æ›´è¼•ï¼‰ |
| å¤šæœå‹™å™¨ | âŒ | - | âŒ ç”¨ä¸åˆ° |
| Bundle å¤§å° | âœ… å° | ~30KB(Viteå„ªåŒ–) | âŒ å¢åŠ  40KB |

### æ¨è–¦æ–¹æ¡ˆï¼šZustand æ›¿ä»£

Instead of TanStack Queryï¼Œä½¿ç”¨ Zustand åšç‹€æ…‹ç®¡ç†ï¼š

```javascript
// Zustand è§£æ±ºçš„æ˜¯ã€ŒåŒæ­¥ç‹€æ…‹ã€ï¼Œä¸æ˜¯ã€Œæ•¸æ“šç²å–ã€
const useTaskStore = create((set) => ({
  tasks: [],
  syncStatus: 'idle',  // idle | syncing | error
  
  loadLocal: async () => {
    const tasks = await db.tasks.toArray()  // Dexie å¾ˆå¿«
    set({ tasks })
  },
  
  triggerSync: () => {
    set({ syncStatus: 'syncing' })
    // Service Worker åœ¨èƒŒæ™¯åŸ·è¡ŒåŒæ­¥
  }
}))
```

---

## ğŸ¬ å»ºè­°çš„ PWA å®Œæ•´æŠ€è¡“æ£§ï¼ˆæœ€çµ‚ç‰ˆï¼‰

æ ¹æ“šä¹‹å‰ + ç¾åœ¨çš„è¨è«–ï¼š
TODO æ¥è‘—è¦æœçš„æ–¹å‘

``` js
React 18 + Vite
â”œâ”€ TanStack Table (è¡¨æ ¼)
â”œâ”€ TanStack Router (è·¯ç”±)
â”œâ”€ Dexie.js (æœ¬åœ°æ•¸æ“šåº«) â† ä¸éœ€è¦ TanStack Query
â”œâ”€ Zustand (ç‹€æ…‹ç®¡ç†) â† ç”¨é€™å€‹æ›¿ä»£ TanStack Query
â”œâ”€ TailwindCSS (æ¨£å¼)
â””â”€ vite-plugin-pwa (PWA æ‰“åŒ…)

é¡å¤–ï¼š
â””â”€ Service Worker (å¾Œå°åŒæ­¥) â† æ ¸å¿ƒï¼Œæ‰¿æ“” TanStack Query æœ¬æ‡‰åšçš„å·¥ä½œ
```

### **é€™å€‹çµ„åˆï¼š**

- ç¸½ Bundle å¤§å°ï¼š~45-55KBï¼ˆæ¥µè¼•é‡ï¼‰
- ä¸€äººç¶­è­·é›£åº¦ï¼šä½
- ç”Ÿæ…‹æˆç†Ÿåº¦ï¼šå®Œæ•´
- é›¢ç·šå„ªå…ˆæ”¯æ´ï¼šå®Œç¾

---

**ç°¡å–®èªªï¼šTanStack Query æ˜¯ç‚ºäº†è§£æ±ºã€Œå¾å¤šå€‹é ç«¯ API ç²å–å’Œå¿«å–æ•¸æ“šã€çš„å•é¡Œã€‚æ‚¨çš„é …ç›®æœ¬åœ°å„ªå…ˆï¼ˆDexie.jsï¼‰+ Service Worker å¾Œå°åŒæ­¥ï¼Œå·²ç¶“è§£æ±ºäº†é€™å€‹å•é¡Œã€‚åŠ  TanStack Query å°±åƒçµ¦è‡ªè¡Œè»Šè£é£›æ©Ÿå¼•æ“â€”â€”æœ‰èƒ½åŠ›ä½†å¤šé¤˜ã€‚ç”¨ Zustand è¼•é‡ç´šç‹€æ…‹ç®¡ç†å°±è¶³å¤ äº†ã€‚****é€™å€‹çµ„åˆï¼š**

- ç¸½ Bundle å¤§å°ï¼š~45-55KBï¼ˆæ¥µè¼•é‡ï¼‰
- ä¸€äººç¶­è­·é›£åº¦ï¼šä½
- ç”Ÿæ…‹æˆç†Ÿåº¦ï¼šå®Œæ•´
- é›¢ç·šå„ªå…ˆæ”¯æ´ï¼šå®Œç¾

---

**ç°¡å–®èªªï¼šTanStack Query æ˜¯ç‚ºäº†è§£æ±ºã€Œå¾å¤šå€‹é ç«¯ API ç²å–å’Œå¿«å–æ•¸æ“šã€çš„å•é¡Œã€‚æ‚¨çš„é …ç›®æœ¬åœ°å„ªå…ˆï¼ˆDexie.jsï¼‰+ Service Worker å¾Œå°åŒæ­¥ï¼Œå·²ç¶“è§£æ±ºäº†é€™å€‹å•é¡Œã€‚åŠ  TanStack Query å°±åƒçµ¦è‡ªè¡Œè»Šè£é£›æ©Ÿå¼•æ“â€”â€”æœ‰èƒ½åŠ›ä½†å¤šé¤˜ã€‚ç”¨ Zustand è¼•é‡ç´šç‹€æ…‹ç®¡ç†å°±è¶³å¤ äº†ã€‚**

=====================================================

---

## [2026-02-12] ychsue ç”± #file:8th_disucssion.md çœ‹ä¾†ï¼Œæ‡‰è©²æ¥è¿‘å¯ä»¥å¯¦ä½œäº†ï¼Œä¸éï¼Œä¸‰å€‹é»è·Ÿæ‚¨è¨è«–ä¸€ä¸‹

1. å¦‚æœå¤š import export xlsx ç­‰é¡å‹çš„æª”æ¡ˆï¼Œå°æ–¼æœ¬æ©Ÿä½¿ç”¨è€…æ˜¯å¦æ›´å®‰å…¨ï¼Ÿ
2. ä¸€èˆ¬åŒæ­¥æ€éº¼åšï¼Ÿç”¨é¡ä¼¼SQLçš„èªæ³• add, update, delete å—ï¼Ÿç„¶å¾ŒåŒæ­¥æ™‚å…ˆæŠ“å–sheetså€‘ï¼Œå¥—ç”¨ä¸Šé€™äº›ä¿®æ”¹å¾Œï¼Œå†å…©é‚Šéƒ½æ›´æ–°å—ï¼Ÿ
3. æˆ‘å€‘éœ€è¦ä½¿ç”¨åƒæ˜¯ Jenkins ä¾†åšåˆ° software development/ DevOps pipeline å—ï¼Ÿå› ç‚ºï¼Œæ‡‰è©²æ²’è¾¦æ³•ä¸€æ¬¡å°±åˆ°ä½å§ï¼Ÿéœ€è¦æä¾›æ‚¨MCPå—ï¼Ÿé‚„æ˜¯æ‚¨æœ‰æ›´å¥½çš„æƒ³æ³•ï¼Ÿè«‹åœ¨æ­¤æª”æ¥çºŒå›ç­”å³å¯ï¼Œæˆ‘å€‘å…ˆåšå¥½ plan çš„å‹•ä½œï¼Œè¬è¬ã€‚

## [2026-02-12] å›ç­”ä¸‰é»ï¼ˆå¯å¯¦ä½œå‰çš„è¦åŠƒï¼‰

### 1) å¤šåš import/export xlsx æ˜¯å¦æ›´å®‰å…¨ï¼Ÿ

çµè«–ï¼š**ä¸æœƒæ›´å®‰å…¨ï¼Œåªæ˜¯æ›´å¯æ§çš„æœ¬æ©Ÿæ“ä½œé¸é …**ã€‚

- å®‰å…¨é¢¨éšªä¸»è¦åœ¨ã€Œæ†‘è­‰èˆ‡è³‡æ–™å­˜æ”¾ã€è€Œéæª”æ¡ˆæ ¼å¼ã€‚
- åŒ¯å…¥/åŒ¯å‡ºåªæ˜¯è®“ä½¿ç”¨è€…æœ‰é›¢ç·šå‚™ä»½ã€æ¬å®¶ã€æ‰‹å‹•ä¿®å¾©è³‡æ–™çš„èƒ½åŠ›ã€‚
- è‹¥è¦æå‡å®‰å…¨æ€§ï¼Œå»ºè­°åšçš„æ˜¯ï¼š
  - Token å­˜åœ¨ IndexedDB ä¸”åŠ å¯†ï¼ˆæˆ–åªåœ¨è¨˜æ†¶é«”ä¸­ï¼Œé‡æ–°ç™»å…¥å†åŒæ­¥ï¼‰ã€‚
  - PWA å•Ÿç”¨ CSPã€é™åˆ¶ç¬¬ä¸‰æ–¹ scriptã€‚
  - åŒ¯å‡ºæ™‚æä¾›ã€ŒåªåŒ¯å‡ºå¿…è¦æ¬„ä½ã€çš„é¸é …ï¼Œé¿å…æ•æ„Ÿæ¬„ä½å¤–æ´©ã€‚

å› æ­¤ï¼Œ**import/export æ˜¯ã€Œå¯ç”¨æ€§èˆ‡å¯æ¢å¾©æ€§ã€åŠ åˆ†ï¼Œä¸æ˜¯å®‰å…¨æ€§æœ¬èº«**ã€‚

### 2) ä¸€èˆ¬åŒæ­¥æ€éº¼åšï¼Ÿ

çµè«–ï¼š**ç”¨ã€Œè®Šæ›´ç´€éŒ„ï¼ˆchange logï¼‰ã€åŒæ­¥ï¼Œä¸ç›´æ¥åš SQL add/update/deleteã€‚**

å»ºè­°æµç¨‹ï¼ˆLocal-Firstï¼‰ï¼š

1. æœ¬åœ°æ¯æ¬¡è®Šæ›´éƒ½å¯«å…¥ Dexieï¼Œä¸¦è¨˜éŒ„ä¸€ç­† change log
   - å…§å®¹åŒ…å«ï¼šæ“ä½œé¡å‹ï¼ˆadd/update/deleteï¼‰ã€ç›®æ¨™è¡¨ã€ä¸»éµã€æ¬„ä½è®Šæ›´ã€æ™‚é–“æˆ³ã€clientId
2. åŒæ­¥æ™‚ï¼š
   - å…ˆå°‡æœ¬åœ° change log æ‰“åŒ…æ‰¹é‡é€åˆ° Google Sheets API
   - é ç«¯æˆåŠŸå¾Œï¼Œæ¨™è¨˜è©²æ‰¹ change log ç‚ºå·²åŒæ­¥
3. ä¸‹è¼‰é ç«¯æ›´æ–°æ™‚ï¼š
   - åªæ‹‰ã€Œæœ€å¾ŒåŒæ­¥æ™‚é–“ä¹‹å¾Œã€çš„æ›´æ–°ï¼ˆå¢é‡ï¼‰
   - ä¾ç…§æ™‚é–“æˆ³æˆ–ç‰ˆæœ¬è™Ÿåšè¡çªè™•ç†

é€™æ¨£åšçš„å¥½è™•ï¼š

- æœ¬åœ°æ°¸é å¯ç”¨ï¼Œä¸éœ€è¦ç­‰é ç«¯æˆåŠŸ
- åŒæ­¥å¯é‡è©¦ï¼ˆchange log é‚„åœ¨ï¼‰
- è¡çªåˆ¤æ–·æ¸…æ¥šï¼Œä¸”å¯å±€éƒ¨åˆä½µ

ç°¡åŒ–çš„åŒæ­¥ç­–ç•¥è‰ç¨¿ï¼š

```text
æœ¬åœ°æ“ä½œ â†’ å¯«å…¥ Dexie + è¨˜éŒ„ change log
å®šæ™‚åŒæ­¥ â†’ æ‰¹é‡ä¸Šå‚³ change log â†’ ä¼ºæœå›å‚³æˆåŠŸæ¸…å–®
ä¸‹è¼‰é ç«¯ â†’ åªæ‹‰å¢é‡ â†’ åˆä½µ + è¡çªè™•ç†
```

è‹¥æœªä¾† Google Sheets ç„¡æ³•æä¾›çœŸæ­£çš„å¢é‡ APIï¼Œå‰‡ç”¨ã€Œæœ€å¾ŒåŒæ­¥æ™‚é–“ + ç‰ˆæœ¬æ¬„ä½ã€æ¨¡æ“¬ã€‚

### 3) éœ€è¦ Jenkins / DevOps pipeline å—ï¼Ÿ

çµè«–ï¼š**ä¸éœ€è¦ Jenkinsï¼Œå…ˆç”¨æœ€å°åŒ–æµç¨‹å³å¯ã€‚**

ç›®å‰åªæœ‰ä¸€äººç¶­è­·ã€ä¸” PWA æ˜¯ç´”å‰ç«¯ï¼Œå»ºè­°çš„æœ€å°æµç¨‹ï¼š

- GitHub Actionsï¼ˆæˆ–æœ¬æ©Ÿè…³æœ¬ï¼‰å®Œæˆï¼š
  - lint / test / build
  - éƒ¨ç½²ï¼ˆä¾‹å¦‚ GitHub Pages æˆ–ä»»æ„éœæ…‹ä¸»æ©Ÿï¼‰
- ç‰ˆæœ¬ç­–ç•¥ï¼š
  - main = ç©©å®šç·š
  - dev = é–‹ç™¼ç·š
- release checklistï¼š
  - build æˆåŠŸ
  - PWA å®‰è£ã€é›¢ç·šã€åŒæ­¥ä¸‰é …åŸºæœ¬æª¢æŸ¥

è‡³æ–¼ MCPï¼šç›®å‰ä¸éœ€è¦ã€‚é€™é¡å•é¡Œä¸»è¦æ˜¯è¨­è¨ˆèˆ‡æ–‡ä»¶ï¼Œä¸æ˜¯å‹•æ…‹ç’°å¢ƒæ•´åˆã€‚

å¦‚æœæ‚¨åŒæ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥æŠŠã€ŒåŒæ­¥ change log schema + Dexie schema + åŸºæœ¬åŒæ­¥æµç¨‹ã€å¯«æˆå¯¦ä½œ planã€‚

==============================================================

## [2026-02-12] ychsue å¥½çš„ï¼Œè«‹ `åŒæ­¥ change log schema + Dexie schema + åŸºæœ¬åŒæ­¥æµç¨‹ã€å¯«æˆå¯¦ä½œ plan`ï¼Œæˆ‘ä¸å¤§æœƒä½¿ç”¨ git åšæµç¨‹ç¶­è­·ï¼Œéœ€è¦æ™‚ï¼Œæ‚¨å¯ä»¥å‘ŠçŸ¥æˆ‘ã€æ•™æˆ‘å—ï¼Ÿè¬è¬æ‚¨ã€‚ğŸ˜„

## [2026-02-12] å¯¦ä½œ Planï¼šchange log schema + Dexie schema + åŸºæœ¬åŒæ­¥æµç¨‹

### A) Change Log Schema (æœ¬åœ°è®Šæ›´ç´€éŒ„)

ç›®çš„ï¼šæŠŠæ‰€æœ‰æœ¬åœ°æ“ä½œè®Šæˆå¯é‡æ”¾ã€å¯é‡è©¦çš„äº‹ä»¶ã€‚

æ¬„ä½å»ºè­°ï¼š

- `id` (string, pk): å”¯ä¸€äº‹ä»¶ ID
- `clientId` (string): è£ç½®æˆ–ç€è¦½å™¨å¯¦ä¾‹ ID
- `table` (string): ç›®æ¨™è¡¨åï¼Œä¾‹å¦‚ `tasks`
- `recordId` (string): ç›®æ¨™è³‡æ–™ä¸»éµ
- `op` (string): `add` | `update` | `delete`
- `patch` (object): æ›´æ–°æ¬„ä½ï¼ˆåªå­˜å·®ç•°ï¼‰
- `createdAt` (number): æœ¬åœ°æ™‚é–“æˆ³
- `syncedAt` (number|null): åŒæ­¥æˆåŠŸæ™‚é–“
- `retryCount` (number): å¤±æ•—é‡è©¦æ¬¡æ•¸
- `status` (string): `pending` | `synced` | `failed`

å‚™è¨»ï¼š

- `patch` å° `add` å¯å­˜å®Œæ•´æ¬„ä½ï¼Œ`update` å­˜å·®ç•°æ¬„ä½ï¼Œ`delete` å­˜æœ€å°è³‡è¨Šã€‚
- `clientId` ç”¨ä¾†åˆ¤æ–·ã€Œé€™æ¬¡æ›´æ–°æ˜¯ä¸æ˜¯è‡ªå·±é€ æˆã€ã€‚

### B) Dexie Schema (æœ¬åœ°è³‡æ–™åº«)

ä»¥ç¾æœ‰ Sheets ç‚ºåŸºç¤ï¼Œå»ºè­°æœ€å°‘ä¸‰å±¤è¡¨ï¼š

1) ä¸»è³‡æ–™è¡¨ï¼ˆä¾‹ï¼štasks, records, configs ç­‰ï¼‰
2) åŒæ­¥ç‹€æ…‹è¡¨ï¼ˆsync_stateï¼‰
3) è®Šæ›´ç´€éŒ„è¡¨ï¼ˆchange_logï¼‰

ç¯„ä¾‹ (æ¦‚å¿µç‰ˆ)ï¼š

```js
db.version(1).stores({
  tasks: 'id, status, updatedAt, createdAt',
  records: 'id, taskId, startedAt, endedAt, updatedAt',
  configs: 'key',
  change_log: 'id, table, recordId, op, status, createdAt',
  sync_state: 'key'
})
```

sync_state å»ºè­°å­˜ï¼š

- `lastSyncAt`
- `lastRemoteCursor` (è‹¥æœªä¾†å¯ç”¨)
- `lastFullSyncAt` (ä¿éšªç”¨)

### C) åŸºæœ¬åŒæ­¥æµç¨‹ (Local-First)

#### 1. æœ¬åœ°å¯«å…¥æµç¨‹

1) ä½¿ç”¨è€…æ“ä½œ -> å¯«å…¥ä¸»è³‡æ–™è¡¨
2) ç«‹åˆ»æ–°å¢ change log -> ç‹€æ…‹ `pending`
3) UI ç›´æ¥æ›´æ–°ï¼Œä¸ç­‰å¾…é ç«¯

#### 2. ä¸Šå‚³æµç¨‹ (Upload)

1) å–å‡º `pending` çš„ change log
2) ä¾ `table` åˆ†çµ„ï¼Œæ‰¹é‡é€åˆ° Sheets API
3) æˆåŠŸ -> `status = synced`, `syncedAt = now`
4) å¤±æ•— -> `status = failed`, `retryCount++`

#### 3. ä¸‹è¼‰æµç¨‹ (Download)

1) ä»¥ `lastSyncAt` æˆ– `lastRemoteCursor` å–å¢é‡
2) è‹¥ç„¡å¢é‡ API -> ä¸‹è¼‰å…¨é‡ä¸¦æ¯”å°ç‰ˆæœ¬æ¬„ä½
3) åˆä½µé€²æœ¬åœ°ï¼š
   - è‹¥æœ¬åœ°æœ‰æ›´æ–°ä¸”è¼ƒæ–° -> ä¿ç•™æœ¬åœ°ï¼Œè¨˜éŒ„è¡çª
   - è‹¥é ç«¯è¼ƒæ–° -> è¦†è“‹æœ¬åœ°

#### 4. è¡çªè™•ç†ç­–ç•¥ (æœ€å°ç‰ˆ)

- ä»¥ `updatedAt` æ¯”è¼ƒç‚ºä¸»
- è‹¥æ™‚é–“å·® < 30 ç§’ä¸”æ¬„ä½ä¸åŒ -> æ¨™è¨˜ `conflict`
- conflict é¡¯ç¤ºåœ¨ UI å¾…ä½¿ç”¨è€…æ±ºå®š

### D) æœ€å°é‡Œç¨‹ç¢‘ (MVP)

1) Dexie schema å»ºç«‹ + åŸºæœ¬ CRUD
2) change log è¨˜éŒ„èˆ‡é‡è©¦æ©Ÿåˆ¶
3) å–®å‘ä¸Šå‚³ (local -> sheets)
4) å–®å‘ä¸‹è¼‰ (sheets -> local)
5) æœ€å°è¡çªæç¤º

### E) Git æµç¨‹ï¼ˆæ‚¨ä¸ç†Ÿä¹Ÿæ²’é—œä¿‚ï¼Œæˆ‘å¯ä»¥å¸¶æ‚¨åšï¼‰

ä¸éœ€è¦é€²éšæµç¨‹ï¼Œå…ˆç”¨æœ€å°æµç¨‹å³å¯ï¼š

1) æ–°åŠŸèƒ½ -> å»ºè­°é–‹ä¸€å€‹åˆ†æ”¯
2) åšå®Œ -> åˆä½µå› main
3) ç™¼ç‰ˆ -> æ‰“ tag (å¯é¸)

å¸¸ç”¨æŒ‡ä»¤ï¼ˆåˆ°æ™‚æˆ‘æœƒä¸€æ­¥ä¸€æ­¥å¸¶æ‚¨åšï¼‰ï¼š

```bash
git checkout -b feature/sync
git add .
git commit -m "Add local change log"
git checkout main
git merge feature/sync
```

æ‚¨åªè¦å‘Šè¨´æˆ‘ã€Œç¾åœ¨è¦åšå“ªå€‹éšæ®µã€ï¼Œæˆ‘æœƒå‘Šè¨´æ‚¨æœ€å°‘éœ€è¦çš„ git æ­¥é©Ÿã€‚

---

å¦‚æœæ‚¨åŒæ„ï¼Œæˆ‘ä¸‹ä¸€æ­¥å¯ä»¥æŠŠã€Œå¯¦éš› Dexie schema å°æ‡‰åˆ°ç¾æœ‰ Sheets æ¬„ä½ã€æ•´ç†æˆæ›´å…·é«”çš„è¡¨æ ¼ï¼ˆé€è¡¨æ¬„ä½å°æ‡‰ï¼‰ã€‚

=============================================================

## [2026-02-12] ychsue å¥½ï¼Œç›®å‰çš„è¡¨æ ¼åœ¨ [[sheets\2026NonBlockingLife.xlsx]], è«‹å¹«æˆ‘æŠŠã€Œå¯¦éš› Dexie schema å°æ‡‰åˆ°ç¾æœ‰ Sheets æ¬„ä½ã€æ•´ç†æˆæ›´å…·é«”çš„è¡¨æ ¼ï¼ˆé€è¡¨æ¬„ä½å°æ‡‰ï¼‰ï¼Œè¬è¬

è«‹å•ï¼Œ

1. æ‚¨è®€å¾—äº† xlsx æª”æ¡ˆå…§å®¹å—ï¼Ÿéœ€è¦æˆ‘åˆ—çµ¦æ‚¨å®ƒçš„è³‡è¨Šå—ï¼Ÿ
2. å¯ä»¥å…ˆåˆ—å‡ºTODOsï¼Œç„¶å¾Œå‰é¢æ”¾ `[ ]` å—ï¼Ÿæˆ‘åœ¨VSCodeæœ‰è£ TODOs extenstionï¼Œå®ƒæœƒè®“æˆ‘çŸ¥é“æœ‰å“ªäº› TODOsã€‚è¬è¬ã€‚

## [2026-02-12] å›è¦†èˆ‡ä¸‹ä¸€æ­¥

### 1) xlsx å…§å®¹è®€å–

æˆ‘ç›®å‰ç„¡æ³•ç›´æ¥è®€å– xlsx çš„å…§å®¹ï¼Œå› æ­¤éœ€è¦æ‚¨æä¾›è¡¨æ ¼è³‡è¨Šã€‚æˆ‘æ‰èƒ½åšå‡ºã€Œé€è¡¨æ¬„ä½å°æ‡‰ã€çš„ Dexie schemaã€‚

è«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼ˆç”¨æœ€ç°¡å–®æ–‡å­—åˆ—å‡ºå³å¯ï¼‰ï¼š

- å·¥ä½œè¡¨åç¨±æ¸…å–®ï¼ˆæ¯ä¸€å¼µ sheet çš„åå­—ï¼‰
- æ¯å¼µ sheet çš„æ¬„ä½åç¨±ï¼ˆç¬¬ä¸€åˆ—æ¨™é¡Œï¼‰
- è‹¥æœ‰ä¸»éµæˆ–å”¯ä¸€æ¬„ä½ï¼Œè«‹æ¨™è¨»
- è‹¥æœ‰æ¬„ä½æ˜¯æ—¥æœŸ/æ™‚é–“æˆ–ç‹€æ…‹ enumï¼Œè«‹æ¨™è¨»

### 2) TODOs

ä»¥ä¸‹å…ˆåˆ—å‡º TODOsï¼Œä¸¦ç”¨ `[ ]` æ ¼å¼ï¼š

- [x] æä¾› xlsx å…§å„ sheet åç¨±èˆ‡æ¬„ä½æ¸…å–®
- [x] æ¨™è¨»æ¯å¼µ sheet çš„ä¸»éµ/å”¯ä¸€æ¬„ä½ï¼ˆä¾èªªæ˜æ•´ç†ï¼‰
- [x] æ¨™è¨»æ—¥æœŸ/æ™‚é–“æ¬„ä½èˆ‡ç‹€æ…‹æ¬„ä½ï¼ˆä»¥ epoch msï¼‰
- [x] ä¾æ“šä¸Šè¿°è³‡è¨Šæ•´ç† Dexie schema å°æ‡‰è¡¨

æä¾›è³‡è¨Šå¾Œï¼Œæˆ‘æœƒæŠŠã€Œé€è¡¨æ¬„ä½å°æ‡‰ã€è¡¨æ ¼è£œä¸Šã€‚

==============================================================

---

## [2026-02-12] ychsue è©²xlsxè³‡è¨Šå¦‚ä¸‹

``` json
{
  "Log": {
    "Timestamp": 0,
    "Task_ID": 1,
    "Title": 2,
    "Action": 3,
    "Category": 4,
    "State": 5,
    "Duration": 6,
    "Notes": 7
  },
  "Dashboard": {
    "Task_ID": 0,
    "Notes": 1,
    "Start_At": 2,
    "System_Status": 3,
    "Total_Focus_Today": 4
  },
  "Inbox": {
    "Task_ID": 0,
    "Title": 1,
    "Received_At": 2
  },
  "Task_Pool": {
    "Task_ID": 0,
    "Title": 1,
    "Status": 2,
    "Project": 3,
    "Spent_Today_Mins": 4,
    "Daily_Limit_Mins": 5,
    "Priority": 6,
    "Last_Run_Date": 7,
    "Total_Spent_Mins": 8
  },
  "Scheduled": {
    "Task_ID": 0,
    "Title": 1,
    "Status": 2,
    "Cron_Expr": 3,
    "Remind_Before": 4,
    "Remind_After": 5,
    "Callback": 6,
    "Last_Run": 7,
    "Note": 8,
    "Next_Run": 9
  },
  "Selection_Cache": {
    "Task_ID": 0,
    "Title": 1,
    "Score": 2,
    "Source": 3,
    "Total_Mins_in_Pool": 4
  },
  "Micro_Tasks": {
    "Task_ID": 0,
    "Title": 1,
    "Status": 2,
    "Last_Run_Date": 7
  }
}
```

æ‚¨è¦ºå¾—å®Œæˆçš„ï¼Œå°±å¹«æˆ‘åœ¨ `[ ]`ï¼Œè®Šæˆ`[x]` å§ï¼Œé‚„æœ‰ï¼Œæˆ‘éœ€è¦å…ˆå®‰è£æˆ‘ä¸Šé¢æœ‰å¯« `TODO` çš„ packages å—ï¼Ÿ

## [2026-02-12] Dexie schema å°æ‡‰è¡¨ï¼ˆé€è¡¨æ¬„ä½ï¼‰

ä»¥ä¸‹ä»¥æ¬„ä½åç¨±æ¨å®šå‹åˆ¥èˆ‡ç”¨é€”ï¼Œè‹¥ä¸»éµ/æ—¥æœŸæ¬„ä½éœ€èª¿æ•´ï¼Œè«‹å‘Šè¨´æˆ‘ã€‚

### Log -> `log`

| Sheets æ¬„ä½ | Dexie æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| Timestamp | timestamp | number | å»ºè­°ç”¨ epoch ms (`ychsue Answer è‹¥google sheet é¡¯ç¤ºçš„æ™‚å€™å¯ä»¥æ˜¯æ™‚é–“å­—ä¸²ï¼Œé‚£å°±ç”¨ epoch ms`) |
| Task_ID | taskId | string | ä»»å‹™ ID |
| Title | title | string | ä»»å‹™æ¨™é¡Œ |
| Action | action | string | START/END/ADD ç­‰ |
| Category | category | string | åˆ†é¡ |
| State | state | string | ç‹€æ…‹ |
| Duration | duration | number | åˆ†é˜æˆ–ç§’ï¼ˆè«‹ç¢ºèªï¼‰(`ychsue Answer ä½¿ç”¨åˆ†é˜`) |
| Notes | notes | string | å‚™è¨» |

å»ºè­°ä¸»éµï¼š`id` (è‡ªè¡Œç”Ÿæˆï¼Œä¾‹å¦‚ `log_${timestamp}_${taskId}`)
å»ºè­°ç´¢å¼•ï¼š`timestamp`, `taskId`, `action`, `state` (`ychsue Answer å°±ä¾æ‚¨`)

### Dashboard -> `dashboard`

| Sheets æ¬„ä½ | Dexie æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| Task_ID | taskId | string | ç•¶å‰ä»»å‹™ ID |
| Notes | notes | string | å‚™è¨» |
| Start_At | startAt | number | epoch ms |
| System_Status | systemStatus | string | ç³»çµ±ç‹€æ…‹ |
| Total_Focus_Today | totalFocusToday | number | ä»Šæ—¥ç´¯ç© |

å»ºè­°ä¸»éµï¼š`taskId`
å»ºè­°ç´¢å¼•ï¼š`systemStatus`
(`ychsue Answer å°±ä¾æ‚¨`)

### Inbox -> `inbox`

| Sheets æ¬„ä½ | Dexie æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| Task_ID | taskId | string | ä»»å‹™ ID |
| Title | title | string | ä»»å‹™æ¨™é¡Œ |
| Received_At | receivedAt | number | epoch ms |

å»ºè­°ä¸»éµï¼š`taskId`
å»ºè­°ç´¢å¼•ï¼š`receivedAt`

### Task_Pool -> `task_pool`

| Sheets æ¬„ä½ | Dexie æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| Task_ID | taskId | string | ä»»å‹™ ID |
| Title | title | string | ä»»å‹™æ¨™é¡Œ |
| Status | status | string | ç‹€æ…‹ |
| Project | project | string | å°ˆæ¡ˆ |
| Spent_Today_Mins | spentTodayMins | number | ä»Šæ—¥æ¶ˆè€— |
| Daily_Limit_Mins | dailyLimitMins | number | æ¯æ—¥ä¸Šé™ |
| Priority | priority | number | å„ªå…ˆåº |
| Last_Run_Date | lastRunDate | number | epoch ms |
| Total_Spent_Mins | totalSpentMins | number | ç¸½æ¶ˆè€— |

å»ºè­°ä¸»éµï¼š`taskId`
å»ºè­°ç´¢å¼•ï¼š`status`, `project`, `priority`, `lastRunDate`

### Scheduled -> `scheduled`

| Sheets æ¬„ä½ | Dexie æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| Task_ID | taskId | string | ä»»å‹™ ID |
| Title | title | string | ä»»å‹™æ¨™é¡Œ |
| Status | status | string | ç‹€æ…‹ |
| Cron_Expr | cronExpr | string | cron è¡¨é”å¼ |
| Remind_Before | remindBefore | number | æå‰æé†’ï¼ˆåˆ†é˜ï¼‰ |
| Remind_After | remindAfter | number | å»¶å¾Œæé†’ï¼ˆåˆ†é˜ï¼‰ |
| Callback | callback | string | å›å‘¼æŒ‡ä»¤ |
| Last_Run | lastRun | number | epoch ms |
| Note | note | string | å‚™è¨» |
| Next_Run | nextRun | number | epoch ms |

å»ºè­°ä¸»éµï¼š`taskId`
å»ºè­°ç´¢å¼•ï¼š`status`, `nextRun`

### Selection_Cache -> `selection_cache`

| Sheets æ¬„ä½ | Dexie æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| Task_ID | taskId | string | ä»»å‹™ ID |
| Title | title | string | ä»»å‹™æ¨™é¡Œ |
| Score | score | number | åˆ†æ•¸ |
| Source | source | string | ä¾†æº |
| Total_Mins_in_Pool | totalMinsInPool | number | ç¸½æ™‚æ•¸ |

å»ºè­°ä¸»éµï¼š`taskId`
å»ºè­°ç´¢å¼•ï¼š`score`, `source`

### Micro_Tasks -> `micro_tasks`

| Sheets æ¬„ä½ | Dexie æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| Task_ID | taskId | string | ä»»å‹™ ID |
| Title | title | string | ä»»å‹™æ¨™é¡Œ |
| Status | status | string | ç‹€æ…‹ |
| Last_Run_Date | lastRunDate | number | epoch ms |

å»ºè­°ä¸»éµï¼š`taskId`
å»ºè­°ç´¢å¼•ï¼š`status`, `lastRunDate`

### Dexie stores è‰ç¨¿

èªªæ˜ï¼šDexie çš„ `stores` åªæ˜¯åœ¨å®šç¾©ã€Œç´¢å¼•æ¬„ä½ã€ï¼Œä¸æ˜¯æŠŠæ¬„ä½æ‹¿æ‰ã€‚æ‰€æœ‰æ¬„ä½ä»æœƒå®Œæ•´ä¿å­˜ã€‚

```js
db.version(1).stores({
  log: 'id, timestamp, taskId, action, state, title',
  dashboard: 'taskId, systemStatus',
  inbox: 'taskId, receivedAt, title',
  task_pool: 'taskId, status, project, priority, lastRunDate, title',
  scheduled: 'taskId, status, nextRun, title',
  selection_cache: 'taskId, score, source, title',
  micro_tasks: 'taskId, status, lastRunDate, title',
  change_log: 'id, table, recordId, op, status, createdAt',
  sync_state: 'key'
})
```

### å¥—ä»¶å®‰è£å»ºè­°

ç›®å‰åªæ˜¯è¦åŠƒï¼Œä¸éœ€è¦å…ˆå®‰è£ã€‚
ç­‰è¦é–‹å§‹å¯¦ä½œæ™‚ï¼Œæ‰éœ€è¦å®‰è£ä¸‹åˆ—åŸºæœ¬å¥—ä»¶ï¼š

- `dexie`ï¼ˆæœ¬åœ° DBï¼‰
- `xlsx`ï¼ˆè‹¥è¦æä¾› import/export xlsx åŠŸèƒ½æ‰éœ€è¦ï¼‰

è‹¥æ‚¨åŒæ„ï¼Œæˆ‘å¯ä»¥æŠŠ TODOs å…§ã€Œä¸»éµ/æ—¥æœŸæ¬„ä½ã€å…ˆä¾æ¬„ä½åç¨±æ¨å®šä¸¦æ¨™ `[x]`ï¼Œæˆ–è«‹æ‚¨ç›´æ¥ç¢ºèªå¾Œæˆ‘å†å‹¾ã€‚

==================================================================

---

## [2026-02-12] ychsue æˆ‘æœ‰ä»¥ä¸‹å¹¾å€‹å›ç­”èˆ‡ç–‘å•

1. `Log` æ˜¯ factor tableï¼Œè¨˜éŒ„æ‰€æœ‰äº‹ä»¶ã€‚ä»–åˆ©ç”¨ `Task_ID`ä¾†é€£åˆ°å…¶ä»–çš„ dimension tablesï¼Œæ‰€ä»¥ï¼Œ `Task_ID`å°å¥¹æ˜¯ FKï¼Œæ‰€ä»¥ï¼Œæ‚¨å®šçš„ id è¦å‰‡å°±ä¾æ‚¨
2. `Dashboard` æ˜¯ç‚ºäº†èƒ½çŸ¥é“ç›®å‰åœ¨è·‘çš„æ˜¯èª°ï¼Œæ‰€ä»¥ï¼Œä»¥æˆ‘é€™è£çš„ä¾‹å­ï¼Œä¸€æ¬¡åªæœ‰ä¸€å€‹æˆ–0å€‹ï¼ŒTask_ID ä¹Ÿæ˜¯FK
3. `Selection_Cache` æ˜¯èª¿åº¦å‡½å¼å®šæœŸå°‡å»ºè­°çµ¦ä½¿ç”¨è€…çš„ä»»å‹™æ•´ç†è€Œæ“ºæ”¾çš„ï¼Œé€™æ¨£ï¼Œæˆ‘iOSæŸ¥è©¢æ™‚ï¼ŒæŸ¥çœ‹æ­¤è¡¨å³å¯
4. è€Œ `Inbox` å‰‡æ˜¯ idea ç´€éŒ„ï¼Œä»–çš„ `Task_ID` åœ¨ç§»åˆ°åˆ¥çš„ task sheets æ™‚é ­ä¸€å€‹å­—è¦æ”¹ï¼Œ
   1. å…§å®šæ½›è¦å‰‡ï¼š Task_Pool (`T`), Micro_Tasks(`t`), Scheduled(`S`)
5. è€Œæ¯å€‹çš„ `Title` éƒ½æœ‰æ„ç¾©ï¼Œæˆ‘ä¸æ‡‚æ‚¨çš„ `stores`å»éƒ½æŠŠä»–å€‘æ‹¿æ‰ï¼Œæ„Ÿè¦ºä¸Šæ‹¿æ‰ä¸åª Titleï¼Œæˆ‘ä¸æ‡‚æ‚¨ç‚ºä½•é€™éº¼åšï¼Ÿ
6. æ™‚é–“è‹¥ä½¿ç”¨ epoch ms ï¼Œè€Œ Google Sheets æœ‰è¾¦æ³•é¡¯ç¤ºæ™‚é–“å­—ä¸²çš„è©±ï¼Œé‚£å°±ä½¿ç”¨ `epoch ms`

## [2026-02-12] å›è¦†èˆ‡èª¿æ•´ï¼ˆä¾æ‚¨çš„è£œå……ï¼‰

å·²ä¾æ‚¨çš„èªªæ˜èª¿æ•´èˆ‡ç¢ºèªï¼š

- `Log` æ˜¯ fact tableï¼Œ`Task_ID` ç‚º FKï¼Œå› æ­¤ `log` è¡¨ä¿ç•™ `taskId` ä¸¦ç”¨ `id` ä½œç‚ºäº‹ä»¶ä¸»éµï¼ˆå¯ç”¨ `log_${timestamp}_${taskId}`ï¼‰ã€‚
- `Dashboard` ç‚ºå–®ç­†ç‹€æ…‹ï¼ˆ0 æˆ– 1ï¼‰ï¼Œ`taskId` ç‚º FKï¼Œä¸¦ç¶­æŒ `taskId` ä½œç‚ºä¸»éµã€‚
- `Selection_Cache` æ˜¯ iOS æŸ¥è©¢å…¥å£ï¼Œä¿ç•™ `taskId/title/score/source` ä»¥åˆ©æ’åºèˆ‡å±•ç¤ºã€‚
- `Inbox` çš„ `Task_ID` æœƒåœ¨ç§»åˆ°å…¶ä»–è¡¨æ™‚æ”¹é¦–å­—ï¼ˆ`T`/`t`/`S`ï¼‰ï¼Œå·²è¦–ç‚ºæ—¢å®šè¦å‰‡ã€‚
- `Title` çµ•å°æœƒä¿ç•™ï¼›å…ˆå‰ `stores` åªæ˜¯ç´¢å¼•æ¬„ä½å®šç¾©ï¼Œä¸¦ä¸æ˜¯åˆªé™¤æ¬„ä½ã€‚
- æ™‚é–“æ¬„ä½æ¡ `epoch ms`ï¼ŒSheets ç«¯å¯é¡¯ç¤ºç‚ºæ™‚é–“å­—ä¸²ã€‚

è‹¥æ‚¨å¸Œæœ› `Title` å¯è¢«æœå°‹æˆ–æ’åºæ›´å¿«ï¼Œæˆ‘å·²æŠŠ `title` åŠ å…¥ç´¢å¼•å»ºè­°ï¼ˆå¯è¦–æ•ˆèƒ½éœ€æ±‚å†èª¿æ•´ï¼‰ã€‚

=================================================================

## [2026-02-12] ychsue å›ç­”

1. å¾—æ˜¯ Task_ID ï¼Œå› ç‚ºé‚£æ˜¯FKï¼Œæˆ‘æ‰èƒ½çŸ¥é“å¥¹å°æ‡‰åˆ°å“ªå¼µè¡¨(æ ¹æ“šç¬¬ä¸€å€‹å­—)çš„å“ªä¸€åˆ—
2. å°±ç”¨ `log_${timestamp}_${taskId}` ç‚º Log çš„ id å§ã€‚

## [2026-02-12] ç¢ºèªçµæœ

- `Dashboard` ä¸»éµç¢ºå®šç‚º `taskId`ï¼ˆå› ç‚º FK éœ€æ±‚ï¼‰ã€‚
- `Log` äº‹ä»¶ä¸»éµæ¡ `log_${timestamp}_${taskId}`ã€‚

=================================================================

---

## [2026-02-12] ychsue å¥½çš„ï¼Œé‚£å°±éº»ç…©æ‚¨

1. [x] Dexie schema æª”æ¡ˆè‰ç¨¿
2. [x] change log å¯«å…¥/é‡è©¦çš„ pseudo-code
3. [x] æœ€å°åŒæ­¥æµç¨‹çš„ä»»å‹™æ¸…å–®

## [2026-02-12] äº¤ä»˜å…§å®¹

### 1) Dexie schema æª”æ¡ˆè‰ç¨¿

```js
// db/schema.js
import Dexie from 'dexie'

export const db = new Dexie('NonBlockingLife')

db.version(1).stores({
  log: 'id, timestamp, taskId, action, state, title',
  dashboard: 'taskId, systemStatus',
  inbox: 'taskId, receivedAt, title',
  task_pool: 'taskId, status, project, priority, lastRunDate, title',
  scheduled: 'taskId, status, nextRun, title',
  selection_cache: 'taskId, score, source, title',
  micro_tasks: 'taskId, status, lastRunDate, title',
  change_log: 'id, table, recordId, op, status, createdAt',
  sync_state: 'key'
})

// Optional: normalize Task_ID prefix rules in one place
export const TASK_PREFIX = {
  task_pool: 'T',
  micro_tasks: 't',
  scheduled: 'S'
}
```

### 2) change log å¯«å…¥/é‡è©¦çš„ pseudo-code

```text
function applyChange(table, recordId, patch, op):
  now = Date.now()
  clientId = getClientId()
  eventId = makeId()  // uuid or ulid

  // 1) write data first
  if op == 'add':
    db[table].add({ ...patch, taskId: recordId, updatedAt: now })
  if op == 'update':
    db[table].update(recordId, { ...patch, updatedAt: now })
  if op == 'delete':
    db[table].delete(recordId)

  // 2) append change log
  db.change_log.add({
    id: eventId,
    clientId,
    table,
    recordId,
    op,
    patch,
    createdAt: now,
    status: 'pending',
    retryCount: 0,
    syncedAt: null
  })

function retrySync():
  pending = db.change_log.where('status').equals('pending').toArray()
  failed = db.change_log.where('status').equals('failed').toArray()
  batch = pending + failed

  if batch is empty: return

  payload = groupByTable(batch)
  result = sendToSheets(payload)

  for each item in batch:
    if result.success(item.id):
      db.change_log.update(item.id, { status: 'synced', syncedAt: Date.now() })
    else:
      db.change_log.update(item.id, { status: 'failed', retryCount: item.retryCount + 1 })
```

### 3) æœ€å°åŒæ­¥æµç¨‹çš„ä»»å‹™æ¸…å–®

- [x] å»ºç«‹ Dexie schema èˆ‡è³‡æ–™è¡¨ï¼ˆå« change_log, sync_stateï¼‰
- [x] å»ºç«‹ Task_ID å‰ç¶´è¦å‰‡ï¼ˆT/t/Sï¼‰èˆ‡è½‰æ›å‡½å¼
- [ ] å¯«å…¥æœ¬åœ° CRUD + äº‹ä»¶å¯«å…¥ change_log
- [ ] å»ºç«‹ uploadï¼šä¾ table åˆ†çµ„ï¼Œä¸Šå‚³ change_log
- [ ] å»ºç«‹ downloadï¼šä»¥ lastSyncAt æ‹‰å¢é‡æˆ–å…¨é‡
- [ ] åˆä½µç­–ç•¥ï¼šä»¥ updatedAt æ¯”è¼ƒã€æ¨™è¨˜è¡çª
- [ ] åŒæ­¥ç‹€æ…‹ UIï¼šsyncing / error / offline
- [ ] åŸºæœ¬æ¸¬è©¦ï¼šæ–°å¢/æ›´æ–°/åˆªé™¤/é‡è©¦

## [2026-02-12] Git åˆ†æ”¯å»ºè­°

ä¸ä¸€å®šè¦æ–°åˆ†æ”¯ï¼Œä½†å»ºè­°é–‹ä¸€å€‹ï¼Œæ–¹ä¾¿å›é€€ï¼š

```bash
git checkout -b feature/pwa-sync
```

è‹¥æ‚¨ä¸ç†Ÿ gitï¼Œæˆ‘å¯ä»¥ä¸€æ­¥ä¸€æ­¥å¸¶æ‚¨åšã€‚

================================================================

---

## [2026-02-12] ychsueï¼Œç¾åœ¨å·²ç¶“åœ¨ `feature/pwa-sync` äº†ï¼Œæ‰€ä»¥ï¼Œæ‚¨è¦é–‹å§‹å‰µå»ºæª”æ¡ˆå€‘äº†å—ï¼Ÿ

[x] I wire these into a minimal db/index.js and add a simple usage example.
[x] I draft the sendBatch / fetchRemote adapter stubs for Google Sheets.
[x] I add basic tests for change log + sync flow.

## [2026-02-12] ychsue æˆ‘æƒ³ï¼Œæˆ‘å€‘ä»¥ Test First çš„æ–¹å¼ä¾†è¨­è¨ˆå¦‚ä½•ï¼Ÿæ‰€ä»¥ï¼Œæˆ‘å€‘ç¾åœ¨è¦å…ˆå¯«ä»–å€‘çš„ unit testsï¼Œä¹Ÿå°±æˆç‚ºä½¿ç”¨ç¯„ä¾‹ï¼Œå°å—ï¼Ÿæœ‰è¾¦æ³•ç”¨å¼·å‹åˆ¥å—ï¼Ÿ

## [2026-02-12] å›è¦†ï¼šTest First + å¼·å‹åˆ¥

å¯ä»¥ï¼Œç”¨ Test First ä¾†è¨­è¨ˆæ˜¯å¾ˆå¥½çš„æ–¹å¼ï¼Œunit tests ä¹Ÿæœƒè®Šæˆä½¿ç”¨ç¯„ä¾‹ã€‚

å¼·å‹åˆ¥æ–¹æ¡ˆæ¡ç”¨ TypeScriptï¼ˆæ¸¬è©¦æª”ç”¨ .tsï¼‰ï¼Œä¸¦ä»¥ Jest + ts-jest åŸ·è¡Œã€‚

- [x] å®‰è£ dev packagesï¼š`typescript`, `@types/jest`, `fake-indexeddb`
- [x] æ–°å¢ `jest.config.cjs` èˆ‡ `tsconfig.json`
- [x] æ’°å¯« `changeLog` çš„ unit testsï¼ˆå« add/update/deleteï¼‰
- [x] æ’°å¯« `sync` çš„ unit testsï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰

=============================================================================

## [2026-02-15] ychsue è«‹å•ä¸‹ä¸€æ­¥æ˜¯è¦å…ˆåšå‰ç«¯äº†å—ï¼Ÿ

## [2026-02-15] å›è¦†èˆ‡ä¸‹ä¸€æ­¥ï¼ˆä¾æ‚¨ç¢ºèªï¼‰

å…ˆè£œé½Š sendBatch / fetchRemote çš„ adapter stubï¼Œä¸¦æŠŠ db åŒ¯å‡ºé›†ä¸­åœ¨ indexï¼Œè®“ä¹‹å¾Œå‰ç«¯å¯ä»¥ç›´æ¥å¼•ç”¨ã€‚

- [x] æ–°å¢ sheets adapter stubï¼ˆsendBatchStub / fetchRemoteStubï¼‰
- [x] æ–°å¢ db/index.ts åŒ¯å‡ºå…¥å£
- [ ] ä¸‹ä¸€æ­¥ï¼šé–‹å§‹åšæœ€å°å‰ç«¯ç•«é¢ï¼ˆtable + sync status + æ‰‹å‹• sync æŒ‰éˆ•ï¼‰
- [ ] æŠŠ sendBatch / fetchRemote çœŸçš„ä¸²åˆ° Google Sheets API

================================================================================

---

## [2026-02-15] ychsue è«‹å•æ˜¯ä½¿ç”¨ Tanstack Tableï¼Œç„¶å¾Œå¯ä»¥ç·¨è¼¯ï¼Œç„¶å¾Œæ›´æ–° db å—ï¼Ÿç‚ºäº†æ–¹ä¾¿æ¸¬è©¦ï¼Œæ˜¯å¦éœ€è¦æœ‰ reset db çš„åŠŸèƒ½ï¼Ÿ

## [2026-02-15] å›è¦†ï¼šè¡¨æ ¼ç·¨è¼¯èˆ‡ reset DB

å¯ä»¥ï¼Œå»ºè­°ç”¨ TanStack Table åšå¯ç·¨è¼¯è¡¨æ ¼ï¼Œç·¨è¼¯å¾Œå‘¼å« `applyChange()` å¯«å…¥ Dexieã€‚é€™æ¨£ UI æœƒå³æ™‚æ›´æ–°ï¼Œchange log ä¹Ÿèƒ½åŒæ­¥ç´¯ç©ã€‚

é—œæ–¼ reset DBï¼š

- å»ºè­°éœ€è¦ï¼Œå°¤å…¶åœ¨é–‹ç™¼èˆ‡æ¸¬è©¦éšæ®µã€‚
- ä½†åªåœ¨ dev æ¨¡å¼é¡¯ç¤ºæˆ–ä¿è­·ï¼ˆé¿å…èª¤åˆªæ­£å¼è³‡æ–™ï¼‰ã€‚
- å½¢å¼å¯ä»¥æ˜¯ï¼šæ¸…ç©ºæ‰€æœ‰è¡¨ + æ¸…ç©º change_log + é‡è¨­ sync_stateã€‚

å¦‚æœæ‚¨åŒæ„ï¼Œæˆ‘ä¸‹ä¸€æ­¥å°±æœƒï¼š

- [x] å…ˆåšæœ€å°å¯ç·¨è¼¯è¡¨æ ¼ï¼ˆä»¥ Inbox ç‚ºä¾‹ï¼‰
- [x] åŠ å…¥ dev-only çš„ reset DB åŠŸèƒ½

================================================================================

---

## [2026-02-15] ychsue æ‰€ä»¥ï¼Œéœ€è¦æˆ‘å®‰è£ React, Zustand, Tanstack Table, éœ€è¦ route å—ï¼Ÿå› ç‚ºæœƒæœ‰å¹¾å€‹ sheets çµ¦ä½¿ç”¨è€…çœ‹èˆ‡ç·¨è¼¯ï¼Œé‚„æ˜¯æ‚¨æœ‰æ›´å¥½çš„å»ºè­°ï¼Ÿ

## [2026-02-15] å›è¦†ï¼šå¥—ä»¶èˆ‡è·¯ç”±å»ºè­°

å»ºè­°å…ˆç”¨æœ€å°å¯è¡Œçµ„åˆï¼Œä¹‹å¾Œå†åŠ ï¼š

- å¿…è¦ï¼šReact + TanStack Table + Dexie
- ç‹€æ…‹ç®¡ç†ï¼šå…ˆä¸è£ Zustand ä¹Ÿå¯ä»¥ï¼Œç”¨ React state å°±èƒ½è·‘æœ€å°ç‰ˆ
- Routerï¼šå…ˆä¸éœ€è¦ã€‚å…ˆç”¨ã€Œtabs åˆ‡æ›ã€æˆ–å–®é ä¸‹æ‹‰çš„æ–¹å¼å±•ç¤ºå¤šå€‹ sheetã€‚

ç†ç”±ï¼š

- å…ˆåšå‡ºå¯ç·¨è¼¯ + å¯å¯«å…¥ DB çš„æœ€å°æµç¨‹ï¼Œæ¯”ä¸€æ¬¡è£é½Šæ‰€æœ‰å·¥å…·æ›´å¿«é©—è­‰æ–¹å‘ã€‚
- Router åªæœ‰åœ¨é é¢å¾ˆå¤šæˆ–éœ€è¦ URL åˆ†äº«/è¨˜æ†¶æ™‚æ‰éœ€è¦ï¼Œå¾ŒçºŒå†åŠ ä¹Ÿå¾ˆå®¹æ˜“ã€‚

å»ºè­°çš„èµ·æ‰‹å¼ï¼š

1) å…ˆåš Inbox ä¸€å¼µè¡¨ï¼ˆç·¨è¼¯å¾Œå¯«å…¥ Dexieï¼‰
2) å†åŠ  Selection_Cache è¡¨åš iOS æŸ¥è©¢å…¥å£
3) éœ€è¦å¤šé æ™‚æ‰å¼•å…¥ Router

è‹¥æ‚¨åŒæ„ï¼Œæˆ‘ä¸‹ä¸€æ­¥å°±ç”¨æœ€å°ä¾è³´å•Ÿå‹•å‰ç«¯ï¼Œç­‰åŠŸèƒ½è·‘èµ·ä¾†å†è£œ Zustand / Routerã€‚

================================================================================

---

## [2026-02-15] ychsue å¥½ï¼Œè«‹é–‹å§‹ã€‚å°äº†ï¼Œé€™å€‹ç¶²é åˆ°æ™‚èƒ½ä½¿ç”¨ github pages ä¾†æä¾›çµ¦ä½¿ç”¨è€…å—ï¼Ÿ

## [2026-02-15] å›è¦†ï¼šGitHub Pages å¯è¡Œæ€§

å¯ä»¥ï¼ŒGitHub Pages å¾ˆé©åˆç”¨ä¾†éƒ¨ç½²é€™ç¨®ç´”å‰ç«¯ PWAã€‚

æ³¨æ„äº‹é …ï¼š

- éœ€è¦è¨­å®š Vite çš„ `base`ï¼ˆé€šå¸¸æ˜¯ `/<repo-name>/`ï¼‰ï¼Œå¦å‰‡è³‡ç”¢è·¯å¾‘æœƒéŒ¯ã€‚
- GitHub Pages æ˜¯éœæ…‹è¨—ç®¡ï¼Œæ²’æœ‰å¾Œç«¯ï¼›è‹¥æœªä¾†éœ€è¦ OAuth refresh tokenï¼Œä»éœ€å…¶ä»–å¾Œç«¯æœå‹™ã€‚
- è‹¥ä¹‹å¾ŒåŠ å…¥ Routerï¼ˆé hash æ¨¡å¼ï¼‰ï¼Œè¦åŠ  404 fallback æˆ–æ”¹ç”¨ HashRouterã€‚

ç›®å‰æˆ‘å·²å…ˆä»¥æœ€å°å‰ç«¯èµ·æ‰‹å¼å»ºç«‹ React + TanStack Tableï¼Œç­‰æ‚¨å®‰è£ä¾è³´å¾Œå³å¯è·‘èµ·ä¾†ã€‚

[ ] Tell me which sheet you want next (Selection_Cache or another), and Iâ€™ll add the next table.
[ ] If you want, I can prep a GitHub Pages deployment workflow after the UI is stable.

=================================================================================

---

## [2026-02-16] ychsue å»ºè­°ï¼ŒSelection_Cacheæ”¾æœ€å¾Œï¼Œé‚„æœ‰ï¼Œ`totalMinsInPool` é€™å€‹F2æ¬„ä½æ˜¯è¨ˆç®—ç•¶å¤©åŸ·è¡Œéçš„ task_pool çš„ç¸½èŠ±è²»æ™‚æ•¸ï¼Œæ‰€ä»¥ï¼Œä»–ä¸æ˜¯Itemçš„æ¬„ä½ä¹‹ä¸€ã€‚é€™å¼µè¡¨ç›®çš„åªæœ‰ä¸€å€‹ï¼Œç•¶æˆ‘è©¢å•å»ºè­°çš„ä»»å‹™èˆ‡é †åºæ™‚ï¼Œå¯ä»¥ç›´æ¥å–å‡ºï¼Œè€Œä¸éœ€è¦åœ¨ doPost ç•¶ä¸‹é¦¬ä¸Šè™•ç†ï¼Œé€™å° GAS å¯èƒ½æœƒæœ‰é»æ…¢ï¼Œå› æ­¤ï¼Œæ‰æœƒå­˜åœ¨æ­¤è¡¨

ç„¶å¾Œï¼Œæ­¤Selection_Cache æ¢åˆ—ä¹‹å¾Œï¼Œä½¿ç”¨è€…æ˜¯é»æ“Šæ¢åˆ—ï¼Œä»–å°±æœƒåœ¨ log åŠ ä¸€å€‹ logï¼Œåœ¨ dashboard åŠ ä¸€æ¢å‘ŠçŸ¥èª°æ­£åœ¨è·‘ï¼Œç„¶å¾Œï¼Œè©²æ¢ç›®æ‰€å°æ‡‰çš„å·¥ä½œè¡¨
(Task_Pool, Scheduled èˆ‡ Micro_Tasksä¸­çš„ä¸€å€‹)çš„ Status å°±æœƒè®Šæˆ Doingã€‚æ‰€ä»¥é€™å¼µè¡¨åœ°ä½æ¯”è¼ƒç‰¹æ®Šï¼Œé‚„æ˜¯å…ˆè™•ç†å…¶ä»–é‚£ä¸‰å¼µå§ã€‚

ç¾åœ¨ï¼Œé¡¯ç„¶è¦å°‡ `App.tsx` æå‡åˆ°portal çš„åœ°ä½ï¼Œç„¶å¾Œï¼Œæœ‰è¾¦æ³•é–‹å•Ÿé€™äº›è¡¨å§ï¼Ÿé‚„æœ‰ï¼Œåˆ°æ™‚æ‡‰è©²é‚„è¦èƒ½ç”±iPhoneæ·å¾‘ç›´æ¥ç”¨åƒæ•¸(èƒ½ç”¨Postå—ï¼Ÿ)æ–°å¢ inbox æˆ– scheduled çš„æ¢ç›®ï¼Œé †ä¾¿è·³åˆ°è©²é é¢ï¼Œæ‰€ä»¥ï¼Œæ€éº¼åšå‘¢ï¼Ÿ

## [2026-02-16] å›è¦†

``` js
App.tsx (ä¸»å®¹å™¨)
â”œâ”€ TabNavigation (é¡µç±¤åˆ‡æ¢)
â”‚  â”œâ”€ Inbox
â”‚  â”œâ”€ Task_Pool
â”‚  â”œâ”€ Scheduled
â”‚  â”œâ”€ Micro_Tasks
â”‚  â””â”€ Selection_Cache (æœ€å¾Œ)
â”œâ”€ TableView (å½“å‰é¡µç±¤çš„è¡¨æ ¼)
â”œâ”€ SyncStatus (å³ä¸Šè§’æ˜¾ç¤ºåŒæ­¥çŠ¶æ€)
â””â”€ ResetDB (dev-only)
```

### å»ºè­°

[ ] å‡çº§ App.tsx ä¸º portalï¼ˆå« global state ç®¡ç†å½“å‰é¡µç±¤ï¼‰
[ ] æ–°å¢ TabNavigation ç»„ä»¶ï¼ˆTask_Pool, Scheduled, Micro_Tasksï¼‰
[ ] æ–°å¢ URL å‚æ•°è§£æ hookï¼ˆuseUrlActionï¼‰
[ ] å®ç° iPhone æ·å¾‘çš„ã€Œæ–°å¢ + å¯¼èˆªã€æµç¨‹
[ ] Selection_Cache ç•™æœ€åï¼ˆå› ä¸ºå®ƒä¾èµ–å‰é¢çš„ä¸‰å¼ è¡¨ï¼‰

### è¯¦ç´°å•é¡Œ

é—œæ–¼ iPhone æ·å¾‘ï¼Œæœ‰å¹¾å€‹ç´°ç¯€éœ€ç¢ºèªï¼š

1. POST vs URL Queryï¼š

    - URL Query æ›´ç°¡å–®ã€ç„¡éœ€ CORSã€æ”¯æŒåˆ†äº«
    - POST æ›´å®‰å…¨ã€æ”¯æŒå¤§é‡æ•°æ®
    - å»ºè®®ç”¨ Queryï¼ˆShortcut æ›´ç›´æ¥ï¼‰
    - **Answer**: å› ç‚ºåŸæœ¬æ˜¯å°æ¥ GAS çš„ doPost ï¼Œæ‰€ä»¥ï¼Œæ‰æœ‰æ­¤å•

2. æ ‡é¢˜å­—ç¬¦é™åˆ¶ï¼š

    - URL æœ‰é•·åº¦é™åˆ¶ï¼ˆ~2000 å­—ç¬¦ï¼‰ï¼Œä½ çš„ Title é€šå¸¸å¤šé•·ï¼Ÿ
    - **Answer**: å› ç‚º Inbox åˆ°æ™‚å¯ä»¥ä½¿ç”¨iPhoneåˆ†äº«ä¾†å–å¾—ï¼Œä¸æ›‰å¾—ï¼Œæ‡‰è©²ä¸æœƒè¶…éå§ï¼Ÿ

3. æ–°å¢å¾Œçš„å›é¥‹ï¼š

    - éœ€è¦å›å‚³æˆåŠŸç¢ºèªç»™ Shortcut å—ï¼Ÿ(å¯èƒ½éœ€è¦å°çš„æˆåŠŸç•«é¢)
    - **Answer**: å› ç‚ºiPhoneæ·å¾‘å‘¼å«PWAï¼Œæˆ‘æ€•ä»–æœƒä¸æ›´æ–°indexedDBï¼Œä¸æ›‰å¾—é»äº†å‘¼å« PWAæ‰“é–‹é é¢æœƒå¦å°±æ²’æœ‰é€™å•é¡Œï¼Œè‹¥æ˜¯å¦‚æ­¤ï¼Œå°±ç„¡éœ€å›å‚³æˆåŠŸäº†å§ï¼Ÿä¸éï¼Œæœ‰æ™‚æœ‰éœ€è¦å‘¼å«è¨ˆæ™‚å™¨æˆ–è¡Œäº‹æ›†(èƒ½æ–°å¢å—ï¼Ÿä¸è¡Œä¹Ÿæ²’é—œä¿‚)

## [2026-02-16] å®Œæ•´çš„ iPhone æ·å¾‘é›†æˆæ–¹æ¡ˆ

æ ¹æ“šæ‚¨çš„å›ç­”ï¼Œä»¥ä¸‹æ˜¯è©³ç´°çš„æŠ€è¡“æ–¹æ¡ˆï¼š

### 1ï¸âƒ£ æ±ºè­°ï¼šä½¿ç”¨ URL Query + Route Hash æ–¹å¼ï¼ˆæ¨è–¦ï¼‰

**å„ªæ–¼ POST çš„ç†ç”±ï¼š**

- âœ… ç„¡ CORS å•é¡Œï¼ˆShortcut ç›´æ¥æ‰“é–‹ URLï¼‰
- âœ… 2000 å­—ç¬¦è¶³å¤ ï¼ˆTitle é€šå¸¸ <200 å­—ï¼‰
- âœ… ç”¨æˆ¶é»æ“Š Shortcut â†’ PWA æ‰“é–‹ â†’ åƒæ•¸è‡ªå‹•è§£æ â†’ å¯«å…¥ Dexie â†’ å°èˆªåˆ°å°æ‡‰é ç±¤
- âœ… ç°¡å–®ç„¡é¡å¤–é€šè¨Š
- âŒ åŸæœ¬ç¿’æ…£ doPostï¼ˆä½† PWA æ¨¡å‹å®Œå…¨ä¸åŒï¼Œç„¡éœ€å›å‚³ç¢ºèªï¼‰

**URL æ ¼å¼å»ºè­°ï¼š**

``` js
// æ–°å¢åˆ° Inbox
https://yourdomain.com/pwa/?sheet=inbox&action=add&title=Buy%20milk

// æ–°å¢åˆ° Scheduled
https://yourdomain.com/pwa/?sheet=scheduled&action=add&title=Morning%20Run&cronExpr=0%209%20*%20*%20*

// æ–°å¢åˆ° Task_Pool
https://yourdomain.com/pwa/?sheet=task_pool&action=add&title=Project%20X&project=Work
```

### 2ï¸âƒ£ IndexedDB æ›´æ–°æµç¨‹ï¼ˆè§£æ±ºæ‚¨çš„æ“”æ†‚ï¼‰

**ç¾è±¡ï¼š** æ‚¨æ“”å¿ƒ Shortcut å‘¼å« PWA å¾Œï¼ŒIndexedDB ä¸æœƒæ›´æ–°

**å¯¦éš›æµç¨‹ï¼š**

``` js
iOS Shortcut é»æ“Š
    â†“
PWA URL æ‰“é–‹ï¼ˆç€è¦½å™¨é‡æ–°åŠ è¼‰æˆ–æ¢å¾©ç‹€æ…‹ï¼‰
    â†“
app.tsx çš„ useEffect ç›£è½ URL åƒæ•¸
    â†“
ç«‹å³åŸ·è¡Œ applyChange(sheet, recordId, patch, 'add')
    â†“
å¯«å…¥ Dexie + è¨˜éŒ„ change_log
    â†“
ç‹€æ…‹æ›´æ–° â†’ React é‡æ–°æ¸²æŸ“ â†’ è‡ªå‹•å°èˆªåˆ°è©²é ç±¤
    â†“
âœ… æ•¸æ“šå·²åœ¨æœ¬åœ°ï¼Œç„¡éœ€ç­‰å¾…é ç«¯ç¢ºèª
```

**é—œéµé»ï¼š** ä¸éœ€è¦å›å‚³ç¢ºèªçµ¦ Shortcutï¼Œå› ç‚ºï¼š

- Dexie.js æ˜¯åŒæ­¥å¯«å…¥ï¼ˆIndexedDB ç«‹å³æŒä¹…åŒ–ï¼‰
- ç”¨æˆ¶åœ¨åŒä¸€è£ç½®ä¸Šï¼Œé›¢ç·šä¹Ÿèƒ½çœ‹åˆ°
- Service Worker æœƒåœ¨èƒŒæ™¯è‡ªå‹•èˆ‡ Google Sheets åŒæ­¥

### 3ï¸âƒ£ è¨ˆæ™‚å™¨èˆ‡è¡Œäº‹æ›†é›†æˆï¼ˆå¯é¸ï¼‰

**ç¾ç‹€ï¼š** iOS Shortcut å¯å‘¼å«åŸç”Ÿ Calendar / Clock åŠŸèƒ½

**å»ºè­°æ–¹æ¡ˆï¼š**

``` js
é¸é … Aï¼šPWA â†’ Shortcut â†’ iOS Calendarï¼ˆæ¨è–¦ï¼‰
  - PWA å°‡é¸å®šçš„ Task è³‡è¨Šå›å‚³çµ¦ Shortcut
  - Shortcut å‘¼å« iOS Calendar/Reminders API æ–°å¢äº‹ä»¶
  - ä¾‹ï¼šé»æ“Šã€ŒMorning Runã€â†’ PWA å›å‚³æ™‚é–“ â†’ Shortcut å»ºç«‹æé†’

é¸é … Bï¼šPWA å…§ç½®è¨ˆæ™‚å™¨ï¼ˆæ¬¡ä½³ï¼‰
  - PWA ä½¿ç”¨ Web Notification API æé†’
  - æˆ–ä½¿ç”¨ Service Worker çš„ Tag Notification

é¸é … Cï¼šä¸æ”¯æŒï¼ˆæœ€ç°¡å–®ï¼‰
  - æš«æ™‚å¿½ç•¥ï¼Œèšç„¦æ ¸å¿ƒåŠŸèƒ½
  - æœªä¾†è‹¥æœ‰éœ€è¦å†åŠ 
```

**æˆ‘çš„å»ºè­°ï¼š** å…ˆå¯¦ä½œé¸é … Bï¼ˆWeb Notificationï¼‰ï¼Œç„¡éœ€èˆ‡ iOS é€šè¨Šã€‚æœªä¾†è‹¥é ˆè¦èˆ‡è¡Œäº‹æ›†åŒæ­¥ï¼Œå†ç”¨é¸é … Aã€‚

### 4ï¸âƒ£ å®Œæ•´çš„ useUrlAction Hook è¨­è¨ˆ

```typescript
// hooks/useUrlAction.ts

import { useEffect } from 'react'
import { applyChange } from '../db/index'

interface UrlAction {
  sheet: 'inbox' | 'scheduled' | 'task_pool' | 'micro_tasks'
  action: 'add' | 'edit'
  [key: string]: string
}

export function useUrlAction(
  onNavigate: (sheet: string) => void,
  onSuccess?: (message: string) => void
) {
  useEffect(() => {
    const params = new URLSearchParams(window.location.search)
    const sheet = params.get('sheet')
    const action = params.get('action')

    if (!sheet || !action) return

    // æå–æ‰€æœ‰åƒæ•¸ç‚º record patch
    const patch: Record<string, string> = {}
    params.forEach((value, key) => {
      if (key !== 'sheet' && key !== 'action') {
        patch[key] = value
      }
    })

    // ç”Ÿæˆ recordIdï¼ˆä¾è¡¨è€Œç•°ï¼‰
    const recordId = generateRecordId(sheet, patch)

    // å¯«å…¥ Dexie
    applyChange(sheet, recordId, patch, 'add')
      .then(() => {
        // å°èˆªåˆ°è©²é ç±¤
        onNavigate(sheet)
        // é¡¯ç¤ºæˆåŠŸæç¤º
        onSuccess?.(`âœ… å·²æ–°å¢åˆ° ${sheet}`)
        // æ¸…é™¤ URLï¼ˆå¯é¸ï¼Œé¿å…é‡è¤‡æ–°å¢ï¼‰
        window.history.replaceState({}, document.title, window.location.pathname)
      })
      .catch((err) => {
        console.error('Failed to add:', err)
        onSuccess?.(`âŒ æ–°å¢å¤±æ•—ï¼š${err.message}`)
      })
  }, [onNavigate, onSuccess])
}

// æ ¹æ“šè¡¨é¡å‹ç”Ÿæˆ recordId
function generateRecordId(sheet: string, patch: Record<string, string>): string {
  const Utils = require('../../gas/src/Utils') // é‡ç”¨ GAS çš„ ID ç”Ÿæˆå™¨
  
  if (sheet === 'inbox') {
    return Utils.generateId('I')
  } else if (sheet === 'task_pool') {
    return Utils.generateId('T')
  } else if (sheet === 'micro_tasks') {
    return Utils.generateId('t')
  } else if (sheet === 'scheduled') {
    return Utils.generateId('S')
  }
  
  return Utils.generateId('X')
}
```

### 5ï¸âƒ£ App.tsx Portal å¯¦ç¾ï¼ˆå« Tab + URL åƒæ•¸è™•ç†ï¼‰

```typescript
// App.tsx

import { useState, useCallback } from 'react'
import { useUrlAction } from './hooks/useUrlAction'
import TabNavigation from './components/TabNavigation'
import InboxTable from './components/tables/InboxTable'
import TaskPoolTable from './components/tables/TaskPoolTable'
import ScheduledTable from './components/tables/ScheduledTable'
import MicroTasksTable from './components/tables/MicroTasksTable'
import SyncStatus from './components/SyncStatus'
import Toast from './components/Toast'

export default function App() {
  const [currentSheet, setCurrentSheet] = useState<string>('inbox')
  const [toast, setToast] = useState<string>('')
  const [showResetConfirm, setShowResetConfirm] = useState(false)

  // ç›£è½ iPhone Shortcut åƒæ•¸
  useUrlAction(setCurrentSheet, setToast)

  const renderTable = () => {
    switch (currentSheet) {
      case 'inbox':
        return <InboxTable />
      case 'task_pool':
        return <TaskPoolTable />
      case 'scheduled':
        return <ScheduledTable />
      case 'micro_tasks':
        return <MicroTasksTable />
      default:
        return <InboxTable />
    }
  }

  return (
    <div className="app-container">
      {/* æ¨™é¡Œæ¬„ */}
      <header className="app-header">
        <h1>ğŸ“± Non-Blocking Life</h1>
        <SyncStatus />
      </header>

      {/* é ç±¤å°èˆª */}
      <TabNavigation 
        currentSheet={currentSheet} 
        onSelectSheet={setCurrentSheet}
      />

      {/* è¡¨æ ¼å…§å®¹ */}
      <main className="app-main">
        {renderTable()}
      </main>

      {/* Dev-only Reset DB */}
      {import.meta.env.DEV && (
        <footer className="app-footer">
          <button onClick={() => setShowResetConfirm(true)}>
            âš ï¸ Reset DB (Dev)
          </button>
          {showResetConfirm && (
            <ResetDBConfirm
              onConfirm={handleResetDB}
              onCancel={() => setShowResetConfirm(false)}
            />
          )}
        </footer>
      )}

      {/* Toast é€šçŸ¥ */}
      {toast && <Toast message={toast} onClose={() => setToast('')} />}
    </div>
  )
}
```

### 6ï¸âƒ£ iOS Shortcut çš„ URL æ§‹å»ºç¯„ä¾‹

**Shortcut å½ä»£ç¢¼ï¼š**

```js
Shortcut: Add to NonBlockingLife

1. Ask for "Task Title"
2. Ask for optional "Project" (for task_pool)
3. Construct URL:
   base_url = "https://yourdomain.com/pwa/"
   params = "sheet=inbox&action=add&title=<title>"
   Open URL: base_url + "?" + params
4. Show notification "Added to NonBlockingLife"
```

**çœŸå¯¦ Shortcut èªæ³•ï¼ˆå¾…é©—è­‰ï¼‰ï¼š**

```js
Text: https://yourdomain.com/pwa/
Set Variable "baseURL" to above
Ask for "Task Title"
Set Variable "title" to response
URL Encode "title" â†’ "encodedTitle"
Open URL: baseURL + "?sheet=inbox&action=add&title=" + encodedTitle

â†’ PWA æ¥æ”¶ â†’ å¯«å…¥ Dexie â†’ è‡ªå‹•å°èˆª âœ…
```

### 7ï¸âƒ£ æŠ€è¡“æ±ºè­°ç¸½çµ

| æ±ºè­°é … | çµè«– | ç†ç”± |
| ------ | ------ | ------ |
| POST vs Query | âœ… URL Query | ç°¡å–®ã€ç„¡ CORSã€Shortcut åŸç”Ÿæ”¯æŒ |
| æ¨™é¡Œé™åˆ¶ | âœ… 2000 å­—è¶³å¤  | ç”¨æˆ¶è¼¸å…¥é€šå¸¸ <200 å­— |
| å›å‚³ç¢ºèª | âŒ ç„¡éœ€å›å‚³ | Dexie åŒæ­¥å¯«å…¥ï¼ŒPWA å°èˆªè‡ªå‹•å®Œæˆ |
| è¨ˆæ™‚å™¨/è¡Œäº‹æ›† | ğŸŸ¡ å¯é¸æœªä¾†æ“´å±• | å…ˆé—œæ³¨æ ¸å¿ƒåŠŸèƒ½ï¼Œå¾ŒçºŒå¯åŠ  Web Notification |

### 8ï¸âƒ£ å¯¦å­˜å¾…è¾¦

- [ ] å¯¦ç¾ useUrlAction Hookï¼ˆåŒ…å« generateRecordIdï¼‰
- [ ] å‡ç´š App.tsx ç‚º Tab Portal æ¶æ§‹
- [ ] æ–°å¢ TabNavigation çµ„ä»¶
- [ ] RxJavaScript/TypeScript è¡¨æ ¼çµ„ä»¶ï¼ˆInbox, Task_Pool, Scheduled, Micro_Tasksï¼‰
- [ ] å¯¦ç¾ Toast é€šçŸ¥çµ„ä»¶
- [ ] å¯¦ç¾ SyncStatus çµ„ä»¶ï¼ˆå³ä¸Šè§’é¡¯ç¤ºåŒæ­¥ç‹€æ…‹ï¼‰
- [ ] Dev-only Reset DB åŠŸèƒ½
- [ ] æ¸¬è©¦ iPhone Shortcut åƒæ•¸å‚³éæµç¨‹
- [ ] GitHub Pages éƒ¨ç½²çš„ base URL é…ç½®ï¼ˆå½±éŸ¿ URL æ§‹å»ºï¼‰

---

**ä¸‹ä¸€æ­¥å»ºè­°ï¼š**

1. [ ] ç¢ºèª GitHub Pages çš„æœ€çµ‚ base URLï¼ˆä¾‹ï¼š`/NonBlockingLife/` æˆ–æ ¹åŸŸåï¼‰
2. [ ] é–‹å§‹å¯¦ç¾ Tab Portal èˆ‡ useUrlAction Hook
3. [ ] å„ªå…ˆå®Œæˆ Inbox èˆ‡ Scheduled è¡¨æ ¼ï¼ˆiPhone ä¸»è¦æ“ä½œé€™å…©å€‹ï¼‰
4. [ ] æ¸¬è©¦ iOS Shortcut èˆ‡ PWA çš„é›†æˆæµç¨‹

===============================================================================

## [2026-02-16] ychsue æœƒæ˜¯ `http://ychsue.github.io/NonBlockingLife`ï¼Œéº»ç…©æ‚¨ä¾åºé€²è¡Œäº†ã€‚è¬è¬

## [2026-02-16] å›è¦†å‰ç«¯Portal

### ä¸‹ä¸€æ­¥å»ºè­°ï¼ˆæ“‡ä¸€ï¼‰

[ ] æˆ‘å¹«æ‚¨åš iOS Shortcut çš„å¯¦éš›æ¸¬è©¦æµç¨‹èªªæ˜èˆ‡ç¯„ä¾‹
[ ] æˆ‘åŠ ä¸Š Selection_Cache çš„è¡Œç‚ºï¼ˆé»é¸å¾Œå¯« logã€dashboardã€ä¸¦æ›´æ–° Statusï¼‰
[ ] æˆ‘æŠŠ Scheduled/Task Pool çš„æ¬„ä½è£œé½Šï¼ˆç›®å‰å…ˆä¿ç•™æ ¸å¿ƒæ¬„ä½ï¼‰

====================================================================================

---

## [2026-02-16] ychsue å°šæœªå®Œæˆæ”¾åˆ° Github page çš„å‹•ä½œï¼Œè«‹å•æ€éº¼åšå‘¢ï¼Ÿ

## [2026-02-16] GitHub Pages éƒ¨ç½²æµç¨‹ï¼ˆPWAï¼‰

ä»¥ä¸‹æ­¥é©Ÿå®Œæˆå¾Œï¼Œå°±å¯ä»¥ç”¨ iOS Shortcut é€£åˆ° PWA åšæ¸¬è©¦ã€‚

### æ–¹æ¡ˆ Aï¼šGitHub Actions è‡ªå‹•éƒ¨ç½²ï¼ˆæ¨è–¦ï¼‰

#### 1) GitHub Pages è¨­å®š

- åœ¨ GitHub å°ˆæ¡ˆé é¢ â†’ Settings â†’ Pages
- Source é¸æ“‡: **GitHub Actions**

#### 2) æ–°å¢ Workflowï¼ˆæ”¾åˆ° .github/workflows/deploy-pwa.ymlï¼‰

```yaml
name: Deploy PWA to GitHub Pages

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        working-directory: pwa
        run: npm ci

      - name: Build
        working-directory: pwa
        run: npm run build

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pwa/dist

      - name: Deploy
        uses: actions/deploy-pages@v4
```

#### 3) æ¨é€åˆ° GitHub

- `git add .`
- `git commit -m "Add Pages deploy"`
- `git push`

å®Œæˆå¾Œç¶²å€å°±æ˜¯ï¼š

```bash
http://ychsue.github.io/NonBlockingLife
```

### æ–¹æ¡ˆ Bï¼šæ‰‹å‹•éƒ¨ç½²ï¼ˆä¸æ¨è–¦ï¼Œåƒ…é–‹ç™¼å¿«é€Ÿæ¸¬è©¦ï¼‰

#### 1) åœ¨æœ¬æ©Ÿ build

```bash
cd pwa
npm install
npm run build
```

#### 2) å°‡ pwa/dist ä¸Šå‚³åˆ° gh-pages åˆ†æ”¯

```bash
git subtree push --prefix pwa/dist origin gh-pages
```

#### 3) GitHub Pages è¨­å®š

- Settings â†’ Pages
- Source é¸æ“‡: **Deploy from a branch**
- Branch é¸æ“‡: **gh-pages** / **root**

### æª¢æŸ¥æ¸…å–®

- [x] Vite base è¨­ç‚º `/NonBlockingLife/`
- [ ] GitHub Pages è¨­å®šç‚º Actions æˆ– gh-pages
- [ ] éƒ¨ç½²å®Œæˆå¾Œå¯ç”¨ `http://ychsue.github.io/NonBlockingLife`
- [ ] iOS Shortcut æ¸¬è©¦ URL æŒ‡å‘è©²ç¶²å€

å¦‚æœéœ€è¦ï¼Œæˆ‘å¯ä»¥è£œä¸€ä»½ iOS Shortcut çš„å¯¦éš›æ¸¬è©¦æµç¨‹ï¼ˆå«ç¯„ä¾‹ URLï¼‰ã€‚
