# Query_Options çš„è¨­è¨ˆ

## [2026-01-21] ychsue çœ‹åˆ° Cron èƒ½æ­£å¸¸ï¼Œä¸”è‡ªå‹•çµ¦æ¥è‘—çš„Taskè‡ªå‹•åŠ ä¸Š NextRun æ„Ÿè¦ºçœŸå¥½ ğŸ˜„ è¬è¬ã€‚ä»Šå¤©å°±å…ˆé€™æ¨£äº†ï¼Œæ˜å¤©æˆ‘å€‘ä¾†æ€è€ƒ Query_Optionäº†ï¼Œä»–æ‡‰è©²æ˜¯å¯«åˆ° `Selection_Cache` ä¾†å‘ŠçŸ¥æœ‰å“ªäº› task å¯ä»¥é¸ï¼Œæ‰€ä»¥ï¼ŒStatus å¯èƒ½è¦å†ä»”ç´°å®šç¾©äº†

### Gemini Answer 01

å¤ªæ£’äº†ï¼çœ‹åˆ°Â **NonBlockingLife**Â çš„ã€Œè‡ªå‹•æ’ç¨‹éˆï¼ˆScheduling Chainï¼‰ã€æˆåŠŸè½‰èµ·ä¾†ï¼Œé‚£ç¨®ã€Œç”Ÿæ´»çš„é½’è¼ªé–‹å§‹åš™åˆã€çš„æ„Ÿè¦ºç¢ºå¯¦éå¸¸è¿·äººã€‚é€™ä»£è¡¨æ‚¨çš„ç³»çµ±å·²ç¶“å¾éœæ…‹çš„ç´€éŒ„æœ¬ï¼Œé€²åŒ–æˆäº†å…·å‚™Â **Event Loop**Â ç²¾ç¥çš„å‹•æ…‹å¼•æ“ã€‚

ä»Šå¤©å®Œæˆäº†æœ€å›°é›£çš„Â **æ™‚é˜è§£æ (Croner)**Â èˆ‡Â **ä»»å‹™éˆé– (Callback Chaining)**ï¼Œæ‚¨çš„ç³»çµ±å·²ç¶“å¯ä»¥è™•ç†ã€Œç¾åœ¨åšä»€éº¼ã€èˆ‡ã€Œæœªä¾†è¦åšä»€éº¼ã€çš„å› æœé—œä¿‚ã€‚

æ˜æ—¥é å‘Šï¼š`Query_Option`Â èˆ‡Â `Selection_Cache`

æ˜å¤©æˆ‘å€‘è¦è™•ç†çš„æ˜¯ã€Œ**æ±ºç­–å±¤**ã€ã€‚é€™å°±åƒæ˜¯ Event Loop æ¯ä¸€è¼ªï¼ˆTickï¼‰éƒ½è¦åšçš„Â `Check`Â éšæ®µï¼š**åœ¨é€™éº¼å¤šä»»å‹™ä¸­ï¼Œç¾åœ¨å“ªäº›æ‰æ˜¯ã€Œå¯åŸ·è¡Œçš„å€™é¸è€…ï¼ˆReady to Runï¼‰ã€ï¼Ÿ**

ç‚ºäº†æ˜å¤©çš„è¨è«–ï¼Œæ‚¨å¯ä»¥å…ˆç¨å¾®æ€è€ƒä¸€ä¸‹é€™å¹¾å€‹ç‹€æ…‹çš„å¾®å¦™å·®åˆ¥ï¼š

1.  **`PENDING`Â (å®šæ™‚ä¸­)**ï¼šå·²è¨­å®šÂ `Next_Run`ï¼Œä½†æ™‚é–“é‚„æ²’åˆ°ï¼ˆæˆ–æ˜¯é‚„åœ¨Â `before_task`Â çš„ç·©è¡æœŸå¤–ï¼‰ã€‚
2.  **`DUE`Â (åˆ°æœŸ)**ï¼šæ™‚é–“å·²é€²å…¥ã€Œå¯åŸ·è¡Œå€é–“ã€ï¼Œæ‡‰è©²åœ¨é¸å–®ä¸­ç½®é ‚ã€‚
3.  **`OVERDUE`Â (è¶…æ™‚)**ï¼šå·²ç¶“éäº†Â `Next_Run`Â å»é‚„æ²’å•Ÿå‹•ï¼Œå¯èƒ½éœ€è¦åŠ å¼·æé†’ã€‚
4.  **`WAITING`Â (ä¼‘çœ )**ï¼šæ²’æœ‰Â `Next_Run`Â ä¹Ÿæ²’æœ‰Â `Cron_Expr`ï¼Œåœ¨ç­‰å¾…æŸå€‹å›èª¿ï¼ˆCallbackï¼‰ä¾†å–šé†’å®ƒã€‚

æˆ‘å€‘æ˜å¤©æœƒå¯¦ä½œä¸€å€‹ã€Œæƒæå™¨ã€ï¼Œå®ƒæœƒæƒææ‰€æœ‰å·¥ä½œè¡¨ï¼Œæ ¹æ“šæ™‚é–“èˆ‡ç‹€æ…‹ç¯©é¸å‡ºç²¾ç¢ºçš„æ¸…å–®ï¼Œä¸¦æ›´æ–°åˆ°Â `Selection_Cache`ã€‚é€™æ¨£æ‚¨çš„ iPhone æ·å¾‘ä¸€æŒ‰ï¼Œè·³å‡ºä¾†çš„æ°¸é æ˜¯æœ€åˆç†çš„é¸æ“‡ã€‚

æ­å–œæ‚¨ä»Šå¤©é”æˆé‡å¤§é‡Œç¨‹ç¢‘ï¼å¥½å¥½ä¼‘æ¯ï¼Œæˆ‘å€‘æ˜å¤©è¦‹ã€‚ğŸ˜„

## [2026-01-21] ychsue èˆ‡ Python Future çš„é—œä¿‚

### Gemini Answer 02

æ‚¨çš„ç›´è¦ºéå¸¸æ•éŠ³ï¼åœ¨Â **NonBlockingLife**Â çš„æ¶æ§‹ä¸­ï¼Œ`WAITING`Â ç‹€æ…‹èˆ‡ PythonÂ `asyncio`Â çš„Â **`Future`**ï¼ˆæˆ– JavaScript çš„Â **`Promise`**ï¼‰åœ¨æ¦‚å¿µä¸Šå¹¾ä¹æ˜¯**å®Œå…¨å°æ‡‰**çš„ã€‚

æˆ‘å€‘å¯ä»¥å¾ä»¥ä¸‹ä¸‰å€‹ç¶­åº¦ä¾†ç†è§£é€™å€‹æœ‰è¶£çš„é—œè¯ï¼š

1. èªç¾©ä¸Šçš„å°æ‡‰ï¼šç­‰å¾…ã€Œæœªä¾†ã€çš„çµæœ

    åœ¨Â `asyncio`Â ä¸­ï¼Œä¸€å€‹Â `Future`Â ç‰©ä»¶ä»£è¡¨ä¸€å€‹ã€Œç¾åœ¨é‚„æ²’æœ‰çµæœï¼Œä½†æœªä¾†æŸå€‹æ™‚é–“é»æœƒæœ‰ã€çš„ä»»å‹™ã€‚

    -   **`Future`Â (Python)**ï¼šä»»å‹™å·²ç¶“æ›èµ·ï¼Œå®ƒåœ¨ç­‰å¾…Â `loop.set_result()`Â è¢«å‘¼å«ã€‚
    -   **`WAITING`Â (NBL)**ï¼šä»»å‹™ï¼ˆä¾‹å¦‚ï¼šæ™¾è¡£æœï¼‰å·²ç¶“å®šç¾©å¥½äº†ï¼Œä½†å®ƒåœ¨ç­‰å¾…ä¸€å€‹**å¤–éƒ¨äº‹ä»¶**ï¼ˆä¾‹å¦‚ï¼šæ´—è¡£æ©Ÿæ´—å¥½çš„Â `Callback`ï¼‰ä¾†å–šé†’å®ƒã€‚

2. ç‹€æ…‹è½‰æ›çš„å°æ‡‰

    é€™å…©è€…éƒ½ç¶“æ­·äº†å¾ã€Œæ›èµ·ã€åˆ°ã€Œå°±ç·’ã€çš„éç¨‹ï¼š

    |éšæ®µ|PythonÂ `asyncio.Future`|NonBlockingLifeÂ `WAITING`|
    |**åˆå§‹**|`Pending`Â (å»ºç«‹ä½†æœªå®Œæˆ)|`WAITING`Â (åœ¨è¡¨ä¸­ï¼Œä½†æ²’äººå•Ÿå‹•å®ƒ)|
    |**è§¸ç™¼**|`loop.call_later()`Â æˆ–Â `set_result()`|`handleEnd`Â å¯«å…¥Â `Next_Run`Â ä¸¦æ”¹ç‚ºÂ `PENDING`|
    |**å°±ç·’**|é€²å…¥Â `Ready Queue`Â æº–å‚™åŸ·è¡Œ|é€²å…¥Â `Selection_Cache`Â è®Šæˆå¯é¸ Action|
    |**åŸ·è¡Œ**|å”ç¨‹è¢«Â `await`Â ä¸¦åŸ·è¡Œ|ä½¿ç”¨è€…Â `START`Â è©²ä»»å‹™|

3. åœ¨ Event Loop ä¸­çš„è§’è‰²

    åœ¨é›»è…¦ç§‘å­¸ä¸­ï¼Œé€™é¡ä»»å‹™éƒ½å±¬æ–¼Â **ã€Œéé˜»å¡ I/Oã€**ï¼š

    -   **åœ¨ Python ä¸­**ï¼š`await some_io_task()`Â æœƒé‡‹æ”¾æ§åˆ¶æ¬Šï¼Œè®“ Loop å»è·‘åˆ¥çš„ç¨‹å¼ã€‚
    -   **åœ¨ NBL ä¸­**ï¼šç•¶æ‚¨æŠŠä¸€å€‹ä»»å‹™è¨­ç‚ºÂ `WAITING`ï¼Œæ‚¨æ˜¯åœ¨å‘Šè¨´å¤§è…¦ï¼ˆä¸»åŸ·è¡Œç·’ï¼‰ï¼šã€Œé€™ä»¶äº‹ç¾åœ¨ä¸ç”¨ç®¡ï¼Œç­‰å›èª¿ç™¼ç”Ÿäº†ï¼Œç³»çµ±æœƒè‡ªå‹•æŠŠå®ƒæ’é€²æˆ‘çš„é¸å–®ï¼ˆCallback Queueï¼‰ã€‚ã€

    ç‚ºä»€éº¼é€™å°æ˜å¤©çš„Â `Query_Option`Â å¾ˆæœ‰å¹«åŠ©ï¼Ÿ

    æ—¢ç„¶Â `WAITING`Â æ˜¯Â `Future`ï¼Œé‚£éº¼æ˜å¤©çš„Â `Query_Option`ï¼ˆæƒæå™¨ï¼‰å°±åƒæ˜¯ Event Loop çš„Â **`Selector`**ï¼š

    1.  **å¿½ç•¥Â `WAITING`**ï¼šæƒæå™¨æœƒè·³éæ‰€æœ‰Â `WAITING`Â çš„ä»»å‹™ï¼Œå› ç‚ºå®ƒå€‘çš„ã€Œæœªä¾†ã€é‚„æ²’åˆ°ï¼Œä¸éœ€è¦å‡ºç¾åœ¨é¸å–®ä¸­ä½”ç©ºé–“ã€‚
    2.  **æ¿€æ´»Â `PENDING`**ï¼šç•¶Â `now >= Next_Run - Remind_Before`ï¼Œé€™å€‹Â `Future`Â å°±è¢«ã€ŒResolveï¼ˆè§£æï¼‰ã€äº†ï¼Œç‹€æ…‹è½‰ç‚ºÂ `DUE`ã€‚
    3.  **ç½®é ‚é¡¯ç¤º**ï¼šé€™äº›è¢«è§£æçš„Â `Future`Â æ‡‰è©²å…·æœ‰æœ€é«˜çš„å„ªå…ˆç´šï¼Œå‡ºç¾åœ¨ iPhone é¸å–®çš„æœ€ä¸Šæ–¹ã€‚

**ç¸½çµæ‚¨çš„æ€è€ƒï¼š**  
æ‚¨ç¾åœ¨ä¸æ˜¯åœ¨ç®¡ç†ã€Œå¾…è¾¦æ¸…å–®ã€ï¼Œè€Œæ˜¯åœ¨ç®¡ç†ä¸€å€‹Â **ã€Œç•°æ­¥ä»»å‹™éšŠåˆ—ã€**ã€‚é€™è®“æ‚¨çš„ç”Ÿæ´»ä¸å†æ˜¯é˜»å¡å¼çš„ï¼ˆä¸€ç›´æƒ³è‘—é‚„æ²’ç™¼ç”Ÿçš„äº‹ï¼‰ï¼Œè€Œæ˜¯äº‹ä»¶é©…å‹•çš„ï¼ˆç­‰ä»»å‹™ Ready äº†æ‰å»è™•ç†ï¼‰ã€‚

é€™ç¨®å°‡Â **Life Management**Â æŠ½è±¡åŒ–ç‚ºÂ **Async Programming**Â çš„æ€è€ƒæ–¹å¼ï¼Œæ­£æ˜¯Â **NonBlockingLife**Â å°ˆæ¡ˆæœ€ç²¾è¯çš„åœ°æ–¹ï¼æ˜å¤©æˆ‘å€‘å°±ä¾†å¯¦ä½œé€™å€‹ã€Œè§£æ Futureã€çš„è‡ªå‹•åŒ–é¸å–®ã€‚ \[2, 6, 12\]

### Gemini Answer 03

å°‡ç”Ÿæ´»ä»»å‹™å°æ‡‰åˆ°Â `asyncio`Â çš„æ¶æ§‹æ˜¯éå¸¸æœ‰è¶£çš„å˜—è©¦ã€‚åœ¨ 2026 å¹´ï¼Œæˆ‘å€‘å°éåŒæ­¥ç³»çµ±çš„ç†è§£æ›´è¶¨å‘æ–¼ã€Œè³‡æºç®¡ç†ã€ï¼Œæ‚¨çš„ç›´è¦ºéå¸¸ç²¾ç¢ºï¼š**`Task_Pool`Â ç¢ºå¯¦å°±æ˜¯Â `Task Object`Â çš„é›†åˆï¼Œè€ŒÂ `Running`Â ç‹€æ…‹å°±æ˜¯æ­£åœ¨è¢«Â `Event Loop`Â åŸ·è¡Œçš„Â `Coroutine`ã€‚**

æˆ‘å€‘å¯ä»¥é€™æ¨£ç²¾ç´°åœ°å°æ‡‰ï¼š

1. `Task_Pool`Â vs.Â `asyncio.Task`

    åœ¨ Python ä¸­ï¼Œ`Task`Â æ˜¯å°Â `Coroutine`Â çš„åŒ…è£ï¼Œå®ƒåŒ…å«äº†ä»»å‹™çš„ç‹€æ…‹ã€çµæœä»¥åŠå„ªå…ˆç´šã€‚

    -   **`Task_Pool`Â ä¸­çš„ä¸€æ¢ç´€éŒ„**Â \=Â **ä¸€å€‹Â `Task Object`**ï¼š
        -   å®ƒè™•æ–¼Â `PENDING`Â ç‹€æ…‹ï¼Œä»£è¡¨å®ƒå·²ç¶“åœ¨Â `Event Loop`Â çš„èª¿åº¦åå–®ä¸­ï¼Œä½†é‚„æ²’ç²å¾— CPUï¼ˆä½ çš„æ³¨æ„åŠ›ï¼‰ã€‚
        -   `Priority`Â èˆ‡Â `Spent_Today_Mins`Â å°±æ˜¯å®ƒçš„Â **ã€Œèª¿åº¦åƒæ•¸ã€**ã€‚

2. `Running`Â (Dashboard) vs.Â `Running Coroutine`

    ç•¶ä¸€å€‹ä»»å‹™å¾Â `Task_Pool`Â è¢«é¸ä¸­ä¸¦å•Ÿå‹•ï¼ˆ`START`ï¼‰æ™‚ï¼š

    -   **ç›®å‰çš„ä»»å‹™**Â \=Â **æ­£åœ¨ Stack é ‚ç«¯é‹è¡Œçš„Â `Task`**ï¼š
        -   é€™æ™‚ä¸»ç·šç¨‹ï¼ˆå¤§è…¦ï¼‰è¢«ä½”ç”¨ï¼Œé€™å°±æ˜¯Â `await task`Â çš„éç¨‹ã€‚
        -   **ä¸­æ–·ï¼ˆInterruptï¼‰**Â \=Â **`task.cancel()`Â æˆ–Â `Context Switch`**ï¼šç•¶å¼·å¤§å„ªå…ˆç´šçš„äº‹é€²ä¾†ï¼ŒåŸæœ¬çš„Â `Task`Â è¢«æ›èµ·ï¼Œä¿å­˜ç•¶å‰ç‹€æ…‹ï¼ˆå¯«å…¥Â `Log`ï¼‰ï¼Œç­‰å¾…ä¸‹æ¬¡æ¢å¾©ã€‚

3. å¦‚ä½•å„ªåŒ–Â `Task_Pool`Â çš„Â `Query_Option`Â é‚è¼¯ï¼Ÿ

    åƒè€ƒÂ `asyncio`Â çš„èª¿åº¦ç­–ç•¥ï¼Œæ˜å¤©æˆ‘å€‘åœ¨å¯«Â `Query_Option`Â æ™‚ï¼Œå¯ä»¥é‡å°Â `Task_Pool`Â å¯¦ä½œä»¥ä¸‹ã€Œèª¿åº¦ç®—æ³•ã€ï¼š

    1.  **Quota Checking (é…é¡æª¢æŸ¥)**ï¼š
        -   å¦‚æœÂ `Spent_Today_Mins >= Daily_Limit_Mins`ï¼Œé€™å€‹Â `Task`Â åœ¨é¸å–®ä¸­æ‡‰è©²è¢«éš±è—æˆ–æ¨™ç¤ºç‚ºã€Œä»Šæ—¥å·²é”ä¸Šé™ã€ï¼ˆé¡ä¼¼æ–¼ç³»çµ±è³‡æºå—é™ï¼‰ã€‚
    2.  **Priority Queuing (å„ªå…ˆæ¬ŠéšŠåˆ—)**ï¼š
        -   æ ¹æ“šÂ `Priority`Â æ’åºã€‚
        -   **é£¢é¤“æª¢æŸ¥ (Starvation Check)**ï¼šå¦‚æœä¸€å€‹ä»»å‹™åœ¨Â `Task_Pool`Â å¾…å¤ªä¹…éƒ½æ²’è¢«å•Ÿå‹•ï¼Œæˆ‘å€‘å¯ä»¥æš«æ™‚æé«˜å®ƒçš„æ¬Šé‡ï¼ˆé€™åœ¨ 2026 å¹´çš„èª¿åº¦ç®—æ³•ä¸­å¾ˆå¸¸è¦‹ï¼‰ã€‚

4. å®Œæ•´çš„å°æ‡‰åœ°åœ– (Life-to-Async Map)

    |NBL çµ„ä»¶|PythonÂ `asyncio`Â æ¦‚å¿µ|èªªæ˜|
    |--|--|--|
    |**`Inbox`**|**`Pending Queue`**|å°šæœªè¢«åŒ…è£æˆ Task çš„åŸå§‹äº‹ä»¶ã€‚|
    |**`Task_Pool`**|**`Task Registry / Heap`**|æ‰€æœ‰å·²å°±ç·’ã€ç­‰å¾…è¢«èª¿åº¦çš„ä»»å‹™å¯¦ä¾‹ã€‚|
    |**`Scheduled`**|**`Timer Handles / Callbacks`**|ä½¿ç”¨Â `loop.call_at()`Â é ç´„çš„æœªä¾†å‹•ä½œã€‚|
    |**`Dashboard`**|**`Current Task (Executing)`**|ç›®å‰ç¨ä½”ä¸»ç·šç¨‹çš„æ´»å‹•ã€‚|
    |**`Log`**|**`Event Trace / Profiler`**|è¨˜éŒ„æ‰€æœ‰ Task åˆ‡æ›èˆ‡åŸ·è¡Œçš„æ—¥èªŒã€‚|

5. æ˜æ—¥çš„è¨­è¨ˆæ€è€ƒï¼š`Selection_Cache`Â çš„åˆ†é¡

    ç‚ºäº†è®“Â `Query_Option`Â æ›´å¥½ç”¨ï¼Œæˆ‘å€‘å¯ä»¥åœ¨Â `Selection_Cache`Â ä¸­å°‡ä»»å‹™åˆ†ç‚ºä»¥ä¸‹ä¸‰é¡å‘ˆç¾çµ¦ iPhoneï¼š

    -   **Critical (ç·Šæ€¥)**ï¼š`Scheduled`Â ä¸­å·²ç¶“Â `DUE`Â (åˆ°æœŸ) çš„Â `Future`ã€‚
    -   **Ready (å°±ç·’)**ï¼š`Task_Pool`Â ä¸­ç¬¦åˆé…é¡ã€é«˜å„ªå…ˆç´šçš„Â `Task`ã€‚
    -   **Background (ç‘£äº‹)**ï¼š`Micro_Tasks`Â æˆ–ä½å„ªå…ˆç´šä»»å‹™ã€‚

    é€™å°±åƒæ˜¯Â `asyncio`Â åœ¨æ¯ä¸€è¼ªå¾ªç’°ä¸­ï¼Œæœƒå…ˆæª¢æŸ¥Â `timers`ï¼Œå†æª¢æŸ¥Â `ready_queue`ã€‚

**ç¸½çµæ‚¨çš„æ€è€ƒï¼š**  
æ‚¨çš„è¨­è¨ˆå·²ç¶“è¶…è¶Šäº†å–®ç´”çš„ã€Œè¨˜äº‹ã€ï¼Œæ‚¨æ­£åœ¨æ§‹å»ºä¸€å€‹**åŸºæ–¼å„ªå…ˆç´šèˆ‡é…é¡çš„æ¶ä½”å¼èª¿åº¦ç³»çµ± (Priority-based Preemptive Scheduler)**ã€‚æ˜å¤©æˆ‘å€‘å°±ä¾†å¯¦ä½œé€™å€‹æƒæå™¨ï¼Œè®“å®ƒæˆç‚ºæ‚¨ç”Ÿæ´»çš„ã€Œæ™ºèƒ½èª¿åº¦å“¡ã€ã€‚

ä»Šæ™šå¥½å¥½ä¼‘æ¯ï¼Œè®“æ‚¨çš„å¤§è…¦Â `Loop`Â é€²å…¥Â `IDLE`Â æ¨¡å¼å……é›»å§ï¼\[2, 6, 12\]

======================================================================

## [2026-01-22] ychsue æ€éº¼ç´€éŒ„ iOS shortcut çš„é–‹ç™¼ï¼Ÿ

### Gemini Answer 04

é‡å°æ‚¨çš„å•é¡Œï¼Œæˆ‘å€‘å¾ Jelly çš„å·¥å…·éˆèˆ‡ iOS æ·å¾‘çš„åˆ†äº«æ©Ÿåˆ¶ä¾†æ·±å…¥è§£æï¼š

1. é—œæ–¼ Jelly (Shortcut ä»£ç¢¼åŒ–å·¥å…·)

    Jelly ä¸»è¦æ˜¯åŸºæ–¼Â **Swift**Â é–‹ç™¼çš„å·¥å…·ï¼Œåœ¨ 2026 å¹´ï¼Œå®ƒä»ä»¥ macOS ç‚ºä¸»ï¼Œä½†åœ¨ Windows ä¸Šæœ‰æŠ˜è¡·æ–¹æ¡ˆï¼š

    -   **Windows ç‰ˆæœ¬ç‹€æ³**ï¼šJelly å®˜æ–¹ä¸¦ç„¡æä¾›Â `.exe`Â å®‰è£æª”ã€‚ä½†å› ç‚ºå®ƒä½¿ç”¨ Swiftï¼Œæ‚¨å¯ä»¥é€éÂ **WSL (Windows Subsystem for Linux)**Â å®‰è£ Swift ç’°å¢ƒä¾†åŸ·è¡Œï¼Œæˆ–è€…ä½¿ç”¨è·¨å¹³å°çš„Â **Jelly-CLI**Â ç‰ˆæœ¬ã€‚
    -   **æ€éº¼ç”¨ï¼Ÿ**ï¼š
        1.  æ‚¨ç”¨é¡ Swift çš„èªæ³•å¯«ä¸€å€‹Â `.jelly`Â æª”æ¡ˆï¼Œæè¿°é‚è¼¯ï¼ˆä¾‹å¦‚Â `getURL("https://...")`ï¼‰ã€‚
        2.  åŸ·è¡Œç·¨è­¯æŒ‡ä»¤ï¼š`jelly compile my_logic.jelly`ã€‚
        3.  å®ƒæœƒç”¢å‡ºä¸€å€‹Â `.shortcut`Â äºŒé€²ä½æª”ï¼Œæ‚¨å¯ä»¥æŠŠå®ƒæ”¾åˆ° GitHub æˆ–é€é iCloud å‚³å› iPhone æ¸¬è©¦ã€‚
    -   **å¯¦å‹™å»ºè­°**ï¼šå°æ–¼å€‹äººé–‹ç™¼ï¼Œè‹¥è¦ºå¾—é…ç½® WSL å¤ªéº»ç…©ï¼Œå»ºè­°é‚„æ˜¯ä»¥ã€ŒiPhone ç«¯é–‹ç™¼ +Â `.shortcut`Â æª”æ¡ˆå­˜å…¥ Gitã€ç‚ºä¸»ï¼Œé€™å° Windows ä½¿ç”¨è€…æœ€å‹å–„ã€‚

2. ã€Œå°å…¥å•ç­”ã€çš„è¨­ç½®ç´°ç¯€

    æ‚¨çš„æ“ä½œè·¯å¾‘æ­£ç¢ºï¼ˆ`è¨­å®š`Â \>Â `æ–°å¢å•é¡Œ`ï¼‰ã€‚é—œæ–¼ã€Œé è¨­ URLã€èˆ‡ã€Œè¼¸å…¥é »ç‡ã€çš„é‚è¼¯å¦‚ä¸‹ï¼š

    -   **æ“ä½œæ­¥é©Ÿ**ï¼š
        1.  åœ¨æ‚¨çš„æ·å¾‘æœ€ä¸Šæ–¹ï¼Œå»ºç«‹ä¸€å€‹Â **ã€Œæ–‡å­—ã€**Â å‹•ä½œï¼Œè£¡é¢å¡«å…¥æ‚¨çš„Â `https://script.google.com...`ï¼ˆæ¸¬è©¦ç”¨ï¼‰ã€‚
        2.  åœ¨æ¥ä¸‹ä¾†çš„Â **ã€Œå–å¾— URL å…§å®¹ã€**Â ä¸­ï¼Œå°‡ URL æ¬„ä½é€£æ¥åˆ°é€™å€‹ã€Œæ–‡å­—ã€è®Šæ•¸ã€‚
        3.  é€²å…¥ã€Œå°å…¥å•ç­”ã€ï¼Œ**é¸æ“‡è©²ã€Œæ–‡å­—ã€å‹•ä½œä½œç‚ºå•é¡Œ**ã€‚
        4.  å•é¡Œå…§å®¹å¡«å¯«ï¼šã€Œè«‹è¼¸å…¥æ‚¨çš„ NonBlockingLife GAS API ç¶²å€ã€ã€‚
    -   **æœƒä¸€ç›´è·³å‡ºä¾†å—ï¼Ÿ**
        -   **ä¸æœƒã€‚**Â ã€Œå°å…¥å•ç­”ã€**åªæœƒåœ¨ã€Œä¸‹è¼‰ä¸¦å®‰è£ã€è©²æ·å¾‘çš„é‚£ä¸€åˆ»è·³å‡ºä¾†è¦æ±‚è¼¸å…¥ä¸€æ¬¡**ã€‚
        -   ä¸€æ—¦ä½¿ç”¨è€…è¼¸å…¥ä¸¦å®Œæˆå®‰è£ï¼Œè©²ç¶²å€å°±æœƒã€Œå¯«æ­»ã€åœ¨è©²ä½¿ç”¨è€…çš„æ·å¾‘å‰¯æœ¬ä¸­ã€‚
        -   ä¹‹å¾Œæ¯æ¬¡é»æ“ŠåŸ·è¡Œï¼Œå®ƒæœƒ**ç›´æ¥è·‘**ï¼Œä¸æœƒå†å•å•é¡Œã€‚
    -   **å¦‚ä½•ä¿®æ”¹ï¼Ÿ**  
        å¦‚æœä½¿ç”¨è€…å¾Œä¾†æ›äº† URLï¼Œä»–å€‘åªéœ€è¦é»æ“Šæ·å¾‘å³ä¸Šè§’çš„Â `...`Â é€²å…¥ç·¨è¼¯ç•«é¢ï¼Œæ‰¾åˆ°é‚£å€‹ã€Œæ–‡å­—ã€å€å¡Šä¿®æ”¹å³å¯ï¼Œéå¸¸ç¬¦åˆé–‹ç™¼è€…ç¿’æ…£ã€‚

3. 2026 å¹´ GitHub åˆ†äº«å»ºè­°ï¼š

    ç‚ºäº†ä¿è­·æ‚¨çš„ç§éš±ä¸¦è®“å°ˆæ¡ˆæ˜“æ–¼ä½¿ç”¨ï¼Œå»ºè­°åœ¨Â `shortcuts/`Â è³‡æ–™å¤¾é€™æ¨£å®‰æ’ï¼š

    1.  **`End_Task.shortcut`**ï¼šé€™æ˜¯æ‚¨å°å‡ºçš„æª”æ¡ˆï¼Œè£¡é¢çš„ URL å·²é€éã€Œå°å…¥å•ç­”ã€è¨­ç‚ºç©ºå€¼æˆ–æç¤ºæ–‡å­—ã€‚
    2.  **`Shortcuts_Setup.md`**ï¼šå¯«ä¸€æ®µèªªæ˜æ–‡å­—ã€‚
        -   _å…§å®¹ç¯„ä¾‹_ï¼š

            > ã€Œä¸‹è¼‰å¾Œè«‹ä¾æç¤ºè¼¸å…¥æ‚¨çš„ API ç¶²å€ã€‚è‹¥éœ€æ‰‹å‹•ä¿®æ”¹ï¼Œè«‹ç·¨è¼¯æ·å¾‘æœ€ä¸Šæ–¹çš„ã€æ–‡å­—ã€å€å¡Šã€‚ã€

4. ä»Šæ—¥é€²åº¦ï¼šQuery\_Option çš„æ¬„ä½æº–å‚™

    æ—¢ç„¶æ‚¨å·²ç¶“æº–å‚™å¥½ã€Œæ·å¾‘è¨­å®šã€çš„éƒ¨åˆ†ï¼Œæˆ‘å€‘å›é ­çœ‹Â `Query_Option`ã€‚æ˜å¤©æˆ‘å€‘æœƒå¯¦ä½œä¸€å€‹å‡½æ•¸ä¾†ç”¢ç”Ÿé€™ä»½ã€Œé¸å–®ã€ã€‚

**`Selection_Cache`Â å»ºè­°æ›´æ–°é »ç‡ï¼š**  
åœ¨æ‚¨çš„ GAS ä¸­ï¼Œå»ºè­°åœ¨Â `handleEnd`Â çš„æœ€å¾Œé¢åŠ å…¥ä¸€è¡Œï¼š  
`updateSelectionCache();`  
é€™æ¨£æ¯æ¬¡çµæŸä»»å‹™æ™‚ï¼Œç³»çµ±å°±æœƒè‡ªå‹•æƒææ‰€æœ‰ Sheetsï¼ŒæŠŠæ¥ä¸‹ä¾†ã€Œå¯ä»¥åšã€çš„é¸é …ï¼ˆåŒ…å«åˆ°æœŸçš„ Scheduled Taskï¼‰æ›´æ–°åˆ°å¿«å–è¡¨ä¸­ã€‚

é€™æ¨£ä¸€ä¾†ï¼ŒiPhone æ·å¾‘åœ¨åŸ·è¡ŒÂ `QUERY_OPTIONS`Â æ™‚ï¼ŒGAS åªéœ€è¦è®€å–ä¸€å¼µÂ `Selection_Cache`Â è¡¨å›å‚³å³å¯ï¼Œé€Ÿåº¦æœƒå¿«å¾—é©šäººï¼

æº–å‚™å¥½æ˜å¤©ä¾†å¯«é€™å€‹ã€Œç”Ÿæ´»æƒæå™¨ã€çš„é‚è¼¯äº†å—ï¼Ÿ \[1, 2\]

=======================================================================

## [2026-01-22] ychsue å—¯ï¼Œå…ˆä¾†è¨­è¨ˆ `updateSelectionCache` å§ã€‚ä¸éï¼Œç›®å‰ç‹€æ…‹

``` js
  STATUS: {
    PENDING: "PENDING",
    DOING: "DOING",
    DONE: "DONE",
    IDLE: "IDLE",
    RUNNING: "RUNNING"
    //è€ŒInterrupt çš„Logå‰‡å¤šäº†å€‹ BUSYï¼Œéœ€è¦åŠ å…¥å—ï¼Ÿ
  }
```

å°‘äº†å®šç¾©Logçš„ `STATES: {'ADD_INBOX', 'START', 'END', 'INTERRUPTED',}`

ç„¶å¾Œç”±
`handleStart` -> `DOING`
`handleEnd` -> `DONE`
`handleInterrupt` -> `PENDING`

ç„¶è€Œï¼Œ `STATUS` æ‚¨èªªäº† `WAITING`ï¼Œæˆ‘å‰‡è¦ºå¾—å¯èƒ½è¦é †ä¾¿å¤šå€‹ `FUTURE`ï¼Œé€™ç¨®çš„å°±æœƒè‡ªå‹•è¢« `updateSelectionCache` Bypass æ‰ï¼Œå› ç‚ºæœ‰çš„é‚„æ²’æ±ºå®šä½•æ™‚é–‹å§‹ï¼Œå–”ï¼Œæä¸å¥½éœ€è¦ `IMAGING`ã€‚

æ‰€ä»¥ï¼Œæˆ‘è¦ºå¾— `updateSelectionCache` è¦èƒ½æˆåŠŸï¼Œå¾—å…ˆæŠŠ `STATUS` èˆ‡ `STATES`(å¯èƒ½ä¸éœ€è¦ï¼Œé€™å€‹å¯èƒ½æ˜¯åœ¨æ¯å‘¨æˆ–æ¯æœˆåˆ†æLogæ™‚å€™ç”¨åˆ°çš„) çš„æ¯å€‹ç‹€æ…‹å®šç¾©æ¸…æ¥šï¼Œæ‰çŸ¥é“é‚£äº›è¦è¢«æ”¶é›†ï¼Œç”šè‡³åŠ åˆ†å§ï¼Ÿæ‚¨èªªå°å—ï¼Ÿé‚„æ˜¯æ‚¨æˆ–è€…åˆ¥äººæœ‰æ›´å¥½çš„åšæ³•ï¼Ÿæˆ‘éƒ½å¯ä»¥è©¦çœ‹çœ‹ã€‚

### Gemini Answer 05

æ‚¨çš„æ€è·¯éå¸¸æ­£ç¢ºï¼åœ¨Â **Event Loop**Â çš„è¨­è¨ˆä¸­ï¼Œé€™ä¸€æ­¥ç¨±ç‚ºÂ **ã€Œèª¿åº¦ç‹€æ…‹æ©Ÿ (Scheduling State Machine)ã€**Â çš„å®šç¾©ã€‚å¦‚æœç‹€æ…‹å®šç¾©æ¨¡ç³Šï¼Œ`updateSelectionCache`Â å°±ç„¡æ³•æº–ç¢ºåˆ¤æ–·å“ªäº›ä»»å‹™è©²é€²å…¥ã€ŒReady Queueï¼ˆæº–å‚™åŸ·è¡ŒéšŠåˆ—ï¼‰ã€ã€‚

åƒè€ƒç¾ä»£æ“ä½œç³»çµ±èˆ‡Â `asyncio`Â çš„é‚è¼¯ï¼Œæˆ‘å»ºè­°å°‡ç‹€æ…‹åˆ†ç‚ºÂ **ã€ŒæŒä¹…ç‹€æ…‹ (Task Status)ã€**Â èˆ‡Â **ã€Œæ—¥èªŒäº‹ä»¶ (Log Events)ã€**Â å…©å€‹ç¶­åº¦ï¼š

1. ä»»å‹™ç‹€æ…‹ (Task Status) â€” å®šç¾©åœ¨å„å€‹å‹éŒ„è¡¨ä¸­

    é€™äº›ç‹€æ…‹æ±ºå®šäº†ä»»å‹™åœ¨Â `Selection_Cache`Â ä¸­çš„å‘½é‹ã€‚

    |ç‹€æ…‹ (Status)|æ„ç¾©|`updateSelectionCache`Â è¡Œç‚º|
    |--|--|--|
    |**`PENDING`**|å·²å°±ç·’ï¼Œç­‰å¾…è¢«åŸ·è¡Œã€‚|**æ”¶é›†**ã€‚é€™æ˜¯æœ€ä¸»è¦çš„å€™é¸ä¾†æºã€‚|
    |**`WAITING`**|æ¢ä»¶æœªæ»¿è¶³ (ä¾‹å¦‚ï¼šç­‰æ´—è¡£æ©Ÿæ´—å¥½)ã€‚|**éæ¿¾**ã€‚é™¤éÂ `Next_Run`Â å·²åˆ°æœŸï¼Œå¦å‰‡ä¸é¡¯ç¤ºã€‚|
    |**`DOING`**|ç›®å‰æ­£åœ¨Â `Dashboard`Â åŸ·è¡Œä¸­ã€‚|**éæ¿¾**ã€‚é˜²æ­¢é‡è¤‡å•Ÿå‹•åŒå€‹ä»»å‹™ã€‚|
    |**`DONE`**|ä»»å‹™å·²å®Œæˆã€‚|**éæ¿¾**ã€‚ä»£è¡¨å·²å¾ Event Loop å½ˆå‡ºã€‚|
    |**`FUTURE`**|åƒ…æ˜¯åˆæ­¥æƒ³æ³•ï¼Œå°šæœªæ±ºå®šä½•æ™‚åšã€‚|**éæ¿¾**ã€‚é€™æ˜¯Â `Inbox`Â çš„é€²åŒ–ç‰ˆï¼Œä¸æ‡‰å¹²æ“¾ç•¶å‰é¸å–®ã€‚|
    |**`IMAGING`**|æ§‹æ€ä¸­ï¼Œé€£ ID éƒ½ä¸ä¸€å®šç©©å®šã€‚|**éæ¿¾**ã€‚é€™å±¬æ–¼å¿ƒç†å±¤é¢ï¼Œå°šæœªå…·å‚™åŸ·è¡Œæ¢ä»¶ã€‚|

2. æ—¥èªŒäº‹ä»¶ (Log Events) â€” åƒ…è¨˜éŒ„æ–¼ Log è¡¨

    é€™å°æ‡‰åˆ°æ‚¨èªªçš„Â `STATES`ï¼Œå®ƒå€‘æ˜¯ã€Œå‹•è©ã€ï¼Œè¨˜éŒ„ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Œä¸éœ€è¦å­˜åœ¨å‹éŒ„è¡¨è£¡ã€‚

    -   **`START`**ã€**`END`**ã€**`INTERRUPTED`**ã€**`ADD_INBOX`**ã€**`MOVED`**ã€‚
    -   **`BUSY`**ï¼šé€™é€šå¸¸æ˜¯Â `Dashboard`Â å°ˆç”¨çš„ç³»çµ±ç‹€æ…‹ï¼Œä»£è¡¨ CPU æ­£åœ¨è¢«Â `SYS_INT`Â ä½”ç”¨ã€‚

3.Â `updateSelectionCache`Â çš„ã€Œæ™ºæ…§ç¯©é¸ã€é‚è¼¯

    æœ‰äº†ä¸Šè¿°ç‹€æ…‹ï¼Œæ‚¨çš„èª¿åº¦å™¨ï¼ˆSchedulerï¼‰å¯ä»¥æ ¹æ“šä»¥ä¸‹è¦å‰‡ä¾†ã€Œæ”¶é›†ã€ä¸¦ã€ŒåŠ åˆ†ã€ï¼š

    A. æƒæÂ `Scheduled`Â è¡¨ (é«˜å„ªå…ˆæ¬Š)

    -   **æ¢ä»¶**ï¼š`Status == PENDING`Â ä¸”Â `now >= Next_Run - before_task`ã€‚
    -   **æ¬Šé‡**ï¼šçµ¦äºˆæœ€é«˜åˆ† (Top Priority)ã€‚åœ¨é¸å–®ä¸­æ¨™è¨˜ç‚ºÂ `[DUE]`ã€‚

    B. æƒæÂ `Task_Pool`Â (ä¸­å„ªå…ˆæ¬Š)

    -   **æ¢ä»¶**ï¼š`Status == PENDING`ã€‚
    -   **åŠ åˆ†é …**ï¼š
        -   æ ¹æ“šÂ `Priority`Â (1-5)ã€‚
        -   å¦‚æœÂ `Spent_Today_Mins < Daily_Limit_Mins`Â (æœªè¶…é¡)ã€‚

    C. æƒæÂ `Micro_Tasks`Â (ä½å„ªå…ˆæ¬Š)

    -   **æ¢ä»¶**ï¼š`Status == PENDING`ã€‚
    -   **åˆ†é¡**ï¼šæ¨™è¨˜ç‚ºÂ `[MICRO]`ï¼Œé©åˆåœ¨é›¶ç¢æ™‚é–“åŸ·è¡Œã€‚

4. å…·é«”ä»£ç¢¼çµæ§‹å»ºè­° (Config.gs)

    å»ºè­°å°‡é€™äº›ç‹€æ…‹åœ¨ä»£ç¢¼ä¸­æ˜ç¢ºåˆ†é–‹ï¼š

    ```javascript
    const NBL_CONFIG = {
      // ç”¨æ–¼ Task_Pool, Scheduled, Micro_Tasks çš„ Status æ¬„ä½
      TASK_STATUS: {
        PENDING: "PENDING",    // æº–å‚™å¥½åŸ·è¡Œ
        WAITING: "WAITING",    // ç­‰å¾…å›èª¿ (Future)
        DOING: "DOING",        // åŸ·è¡Œä¸­
        DONE: "DONE",          // å·²å®Œæˆ
        FUTURE: "FUTURE",      // æš«ä¸åŸ·è¡Œ (Imaging)
        DISABLED: "DISABLED"   // å·²åœç”¨
      },
      // ç”¨æ–¼ Log çš„ Action æ¬„ä½
      LOG_ACTION: {
        START: "START",
        END: "END",
        INTERRUPT: "INTERRUPT",
        ADD: "ADD_INBOX"
      }
    };
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

5. åˆ¥äººçš„åšæ³•èˆ‡æ›´å¥½å»ºè­°

    åœ¨å°ˆæ¥­çš„æ™‚é–“èª¿åº¦ç³»çµ±ä¸­ï¼Œé‚„æœ‰ä¸€ç¨®åšæ³•å«åšÂ **ã€Œä¸Šä¸‹æ–‡éæ¿¾ (Context Filtering)ã€**ï¼š

    -   **å»ºè­°**ï¼šåœ¨Â `Selection_Cache`Â ä¸­å¤šå­˜ä¸€æ¬„Â **`Category`**Â æˆ–Â **`Context`**ã€‚
    -   **åŸå› **ï¼šå¦‚æœæ‚¨ç¾åœ¨äººåœ¨å¤–é¢ï¼ˆç”± iPhone å®šä½æˆ–æ™‚é–“åˆ¤å®šï¼‰ï¼Œ`Query_Option`Â å¯ä»¥åªé¡¯ç¤ºæ¨™è¨»ç‚ºÂ `Home`Â ä»¥å¤–çš„ä»»å‹™ã€‚
    -   **åŠ åˆ†æ©Ÿåˆ¶**ï¼šå¦‚æœä¸€å€‹Â `WAITING`Â ä»»å‹™å‰›å¥½åœ¨Â `Next_Run`Â é™„è¿‘ï¼Œæˆ‘å€‘ä¸åªæŠŠå®ƒæ”¾é€²å¿«å–ï¼Œé‚„æœƒåœ¨Â `Title`Â å‰é¢åŠ ä¸Š ğŸ”” ç¬¦è™Ÿã€‚

ç¸½çµ

æ‚¨ç¾åœ¨éœ€è¦åšçš„æ˜¯ï¼š

1.  **çµ±ä¸€æ‰€æœ‰ Sheet çš„ Status**ï¼Œä½¿ç”¨ä¸Šè¿°Â `TASK_STATUS`Â å®šç¾©ã€‚
2.  **å¯¦ä½œÂ `updateSelectionCache`**ï¼šå®ƒå°±åƒä¸€å€‹æ¼æ–—ï¼ŒæŠŠæ‰€æœ‰Â `PENDING`Â çš„æ±è¥¿æŠ“å‡ºä¾†ï¼Œä¸¦æ ¹æ“šæ™‚é–“ï¼ˆNext\_Runï¼‰å’Œå„ªå…ˆç´šæ’åºã€‚

é€™å¥—é‚è¼¯å®Œæˆå¾Œï¼Œæ‚¨çš„ç³»çµ±å°±å…·å‚™äº†Â **ã€Œæ™ºæ…§èª¿åº¦ (Intelligent Scheduling)ã€**Â çš„é››å½¢ã€‚æ‚¨æº–å‚™å¥½è¦å¯«é€™å€‹ã€Œæ¼æ–—å‡½æ•¸ã€äº†å—ï¼Ÿ \[2, 3, 6\]

========================================================================

## [2026-01-22] ychsue å¯æ˜¯ç…§æ‚¨çš„èªªæ³•ï¼Œç›®å‰ handleEnd å¹¾ä¹éƒ½æœƒæŠŠä»–å€‘è®Šæˆ `DONE`ï¼Œæ„Ÿè¦ºä¸Šæ‚¨çš„é‚è¼¯è£é ­ï¼Œ `DONE` å¥½åƒè®Šæˆ `FUTURE` ä¸€èˆ¬ï¼Œè«‹å• handleEnd æ‡‰è©²æ€éº¼æ”¹å‘¢ï¼Ÿé‚„æœ‰ï¼Œ`DONE`ä½•æ™‚æœƒè¢« updateSelectionCache èª¿ç”¨æˆ–è€…è¢«èª°æ”¹ç‚º PENDING or WAITINGå‘¢ï¼Ÿ

### Gemini Answer 06

é€™æ˜¯ä¸€å€‹éå¸¸é—œéµçš„ã€Œç”Ÿå‘½é€±æœŸï¼ˆLifecycleï¼‰ã€å•é¡Œã€‚ç›®å‰çš„é‚è¼¯ç¢ºå¯¦éæ–¼ç°¡å–®ï¼Œå°è‡´ä»»å‹™ä¸€æ—¦Â `DONE`Â å°±æ°¸ä¹…æ¶ˆå¤±åœ¨åŸ·è¡Œå¾ªç’°ä¸­ã€‚

åœ¨Â **Event Loop**Â çš„é‚è¼¯è£¡ï¼Œä»»å‹™çµæŸå¾Œä¸æ‡‰è©²åªæ˜¯æ¶ˆå¤±ï¼Œè€Œæ˜¯è¦æ ¹æ“šå®ƒçš„**æ€§è³ª**æ±ºå®šä¸‹ä¸€æ­¥å»å‘ã€‚é€™å°±æ˜¯ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦å€åˆ†ã€Œä¸€æ¬¡æ€§ä»»å‹™ã€èˆ‡ã€Œé‡è¤‡æ€§ä»»å‹™ã€ã€‚

ä»¥ä¸‹æ˜¯é‡å°Â `handleEnd`Â èˆ‡ç‹€æ…‹æµè½‰çš„é‡æ–°è¨­è¨ˆï¼š

1. ä»»å‹™çš„ç”Ÿå‘½é€±æœŸæµè½‰åœ– (State Transition)

    æˆ‘å€‘ä¸æ‡‰è©²è®“Â `handleEnd`Â ç›²ç›®åœ°å°‡æ‰€æœ‰äº‹è®Šç‚ºÂ `DONE`ã€‚

    -   **ä¸€æ¬¡æ€§ä»»å‹™ (One-off)**ï¼š`DOING`Â â†’Â `DONE`Â (æ°¸ä¹…çµæŸï¼Œä¸é€²å…¥å¿«å–)ã€‚
    -   **é€±æœŸæ€§ä»»å‹™ (Periodic)**ï¼š`DOING`Â â†’Â `WAITING`Â (ç­‰å¾…ä¸‹ä¸€å€‹è¨ˆæ™‚å™¨å–šé†’)ã€‚
    -   **å›èª¿ä»»å‹™ (Callback)**ï¼š`DOING`Â â†’Â `DONE`ï¼Œä½†åŒæ™‚å°‡å¦ä¸€å€‹ä»»å‹™å¾Â `WAITING`Â è®Šç‚ºÂ `PENDING`ã€‚

2. `handleEnd`Â çš„é‚è¼¯å‡ç´š

    `handleEnd`Â æ‡‰è©²åƒä¸€å€‹**ã€Œåˆ†æª¢å“¡ã€**ï¼Œæ ¹æ“šä»»å‹™é¡å‹æ±ºå®šå…¶å¾Œçš„Â `Status`ã€‚

    ```javascript
    export function handleEnd(info = "", service = SheetsService) {
      const [id, title, startAt] = service.getDashboardState();
      const taskInfo = service.findTaskById(id);
      const duration = Utils.calculateDuration(startAt, new Date());

      let nextStatus = NBL_CONFIG.TASK_STATUS.DONE; // é è¨­çµæŸ

      // --- æ ¸å¿ƒåˆ†æª¢é‚è¼¯ ---
    
      if (id.startsWith("S")) { 
        // A. é€±æœŸæ€§é ç´„ (Scheduled)
        if (taskInfo.cron_expr) {
          nextStatus = NBL_CONFIG.TASK_STATUS.WAITING; // å›åˆ°ç­‰å¾…ç‹€æ…‹
          const nextRun = new Cron(taskInfo.cron_expr).nextRun();
          service.updateScheduledTaskNextRun(id, nextRun);
        }
      } 
    
      else if (id.startsWith("T")) {
        // B. ä¸€èˆ¬ä»»å‹™ (Task Pool)
        // å¦‚æœæ˜¯é•·æœŸå°ˆæ¡ˆï¼ŒçµæŸå¾Œæ‡‰å›åˆ° PENDING è€Œé DONEï¼Œé™¤éä½¿ç”¨è€…æ‰‹å‹•é—œé–‰
        nextStatus = NBL_CONFIG.TASK_STATUS.PENDING; 
      }

      // --- åŸ·è¡Œæ›´æ–° ---
      service.updateTaskStatus(id, nextStatus, duration);
      service.appendLog([new Date(), id, title, "END", "", "IDLE", info]);
      service.clearDashboard();

      // æ¯ç•¶æœ‰ä»»å‹™çµæŸï¼Œå°±åˆ·æ–°ä¸€æ¬¡å¿«å–
      updateSelectionCache(); 
    }
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

3. èª°ä¾†æŠŠç‹€æ…‹æ”¹å›Â `PENDING`Â æˆ–Â `WAITING`ï¼Ÿ

    é€™æ˜¯è§£æ±ºæ‚¨ç–‘æƒ‘çš„é‡é»ï¼š**ç‹€æ…‹çš„è®Šæ›´æ˜¯ã€Œäº‹ä»¶é©…å‹•ã€çš„ã€‚**

    1.  **è‡ªå‹• (Time Trigger)**ï¼š
        -   é€™æ˜¯ä¸€å€‹æ¯ 15 åˆ†é˜è·‘ä¸€æ¬¡çš„ GAS è…³æœ¬ï¼ˆä¾‹å¦‚Â `checkTimers`ï¼‰ã€‚
        -   **é‚è¼¯**ï¼šæƒææ‰€æœ‰Â `WAITING`Â ä¸”æœ‰Â `Next_Run`Â çš„ä»»å‹™ã€‚
        -   **è§¸ç™¼**ï¼šå¦‚æœÂ `now >= Next_Run - before_task`ï¼Œå°‡Â `Status`Â å¾Â `WAITING`Â æ”¹ç‚ºÂ **`PENDING`**ã€‚
        -   **çµæœ**ï¼šä¸‹ä¸€æ¬¡Â `updateSelectionCache`Â å°±æœƒæŠ“åˆ°å®ƒã€‚
    2.  **æ‰‹å‹• (Inbox Review)**ï¼š
        -   ç•¶æ‚¨æ•´ç†Â `Inbox`Â æˆ–Â `Future`Â æ¸…å–®æ™‚ã€‚
        -   **å‹•ä½œ**ï¼šæ‚¨æ±ºå®šã€Œæ˜å¤©è¦åšé€™ä»¶äº‹ã€ï¼Œæ‰‹å‹•ï¼ˆæˆ–é€éæ·å¾‘ï¼‰å°‡å…¶æ”¹ç‚ºÂ `PENDING`ã€‚
    3.  **é—œè¯è§¸ç™¼ (Callback)**ï¼š
        -   å¦‚å…ˆå‰è¨è«–ï¼Œ`æ´—è¡£æœ`Â çµæŸæ™‚ï¼Œç¨‹å¼ç¢¼ä¸»å‹•å°‡Â `æ™¾è¡£æœ`Â çš„ç‹€æ…‹æ”¹ç‚ºÂ `PENDING`ã€‚

4. `updateSelectionCache`Â æ‰®æ¼”çš„è§’è‰²

    `updateSelectionCache`Â **åªè² è²¬ã€Œè®€å–ã€ä¸è² è²¬ã€Œä¿®æ”¹ã€**ã€‚å®ƒå°±åƒæ˜¯é¸å–®çš„æ¸²æŸ“å™¨ï¼š

    -   å®ƒåªæœƒå»å„è¡¨æœå°‹Â `Status == PENDING`Â çš„æ±è¥¿ã€‚
    -   å®ƒä¸æœƒå»ç®¡Â `DONE`Â æˆ–Â `FUTURE`ã€‚
    -   **ä¾‹å¤–**ï¼šå¦‚æœä¸€å€‹Â `WAITING`Â ä»»å‹™çš„Â `Next_Run`Â å·²ç¶“åˆ°äº†ï¼Œä½†ç‹€æ…‹é‚„æ²’è¢«Â `Time Trigger`Â æ”¹æ‰ï¼Œ`updateSelectionCache`Â å¯ä»¥ã€Œé †ä¾¿ã€å¹«å¿™ä¿®æ­£ä¸¦æŠŠå®ƒé¡¯ç¤ºå‡ºä¾†ï¼ˆé€™å« Lazy Updateï¼‰ã€‚

5. ä¿®æ­£æ‚¨çš„ 2026/01/22 æ§‹æ€

    æ‚¨æåˆ°çš„Â `IMAGING`Â æˆ–Â `FUTURE`ï¼š

    -   **ç”¨é€”**ï¼šé€™äº›æ˜¯**ã€Œéæ´»èºå€ã€**ã€‚å®ƒå€‘å­˜åœ¨æ–¼Â `Task_Pool`Â æˆ–Â `Inbox`Â ä¸­ï¼Œä½†Â `Status`Â æ°¸é ä¸æœƒæ˜¯Â `PENDING`ã€‚
    -   **å¦‚ä½•å•Ÿç”¨**ï¼šåªæœ‰ç•¶æ‚¨æŸå¤©è¦ºå¾—ã€Œä»Šå¤©æƒ³ä¾†åšé€™ä»¶äº‹ã€æ™‚ï¼Œæ‰é€éä»‹é¢æŠŠå®ƒæ”¹ç‚ºÂ `PENDING`ã€‚é€™èƒ½é˜²æ­¢æ‚¨çš„ iPhone é¸å–®è¢«å¹¾ç™¾å€‹ã€Œä»¥å¾Œæƒ³åšã€çš„é›œäº‹æ·¹æ²’ã€‚

**ç¸½çµå»ºè­°ï¼š**

1.  **`handleEnd`Â æ”¹è‰¯**ï¼šä¸è¦å…¨éƒ¨è®ŠÂ `DONE`ã€‚ä¸€èˆ¬å°ˆæ¡ˆè®ŠÂ `PENDING`ï¼Œé€±æœŸä»»å‹™è®ŠÂ `WAITING`ã€‚
2.  **å»ºç«‹Â `checkTimers`Â è…³æœ¬**ï¼šè² è²¬æŠŠæ™‚é–“åˆ°çš„Â `WAITING`Â å–šé†’æˆÂ `PENDING`ã€‚
3.  **`updateSelectionCache`Â é‚è¼¯**ï¼šåªæŠ“Â `PENDING`Â ä¸”æ²’éæœŸçš„ä»»å‹™ã€‚

é€™æ¨£ï¼Œæ‚¨çš„ä»»å‹™å°±æœƒåœ¨Â `WAITING`Â (ç­‰å¾…å¾ªç’°) å’ŒÂ `PENDING`Â (æº–å‚™åŸ·è¡Œ) ä¹‹é–“å„ªé›…åœ°æµè½‰äº†ï¼ \[2, 3, 6\]

=======================================================================================

## [2026-01-22] ychsue `handleEnd` æ”¹è‰¯å®Œç•¢ï¼Œä½†é‚„æ²’åŠ å…¥`updateSelectionCache`ï¼Œè‹¥åŠ åœ¨ return ä¹‹å‰ï¼Œåˆæ€•å¥¹å¡ä½returnï¼Œæ€éº¼è¾¦ï¼Ÿé‚„æœ‰ï¼Œå¦å¤–å…©å€‹å“ªå€‹å…ˆæ¯”è¼ƒå¥½

### Gemini Answer 07

åœ¨ GAS çš„å–®ç·šç¨‹ç’°å¢ƒä¸‹ï¼Œæ•ˆèƒ½å„ªåŒ–èˆ‡é‚è¼¯é †åºç¢ºå¯¦æ˜¯é—œéµã€‚ä»¥ä¸‹é‡å°æ‚¨çš„ä¸‰å€‹ç–‘å•æä¾› 2026 å¹´çš„æœ€ä½³å¯¦è¸å»ºè­°ï¼š

1. è§£æ±ºÂ `updateSelectionCache`Â å¡ä½å›å‚³çš„å•é¡Œ

    åœ¨ GAS ä¸­ï¼Œç”±æ–¼å®ƒæ˜¯åŒæ­¥åŸ·è¡Œçš„ï¼Œ`updateSelectionCache`Â çš„åŸ·è¡Œæ™‚é–“ï¼ˆç´„ 1-2 ç§’ï¼‰ç¢ºå¯¦æœƒè®“ iPhone æ·å¾‘æ„Ÿåˆ°å»¶é²ã€‚æœ‰å…©ç¨®è™•ç†æ–¹å¼ï¼š

    -   **æ–¹æ¡ˆ Aï¼šåŒæ­¥åŸ·è¡Œä½†å„ªåŒ–ï¼ˆæ¨è–¦ï¼‰**  
        é›–ç„¶æœƒæ…¢ä¸€é»ï¼Œä½†èƒ½ä¿è­‰æ•¸æ“š**å¼·ä¸€è‡´æ€§**ã€‚æ‚¨å‰›æŒ‰å®Œã€ŒçµæŸã€ï¼Œç«‹åˆ»æŒ‰ã€Œæ–°ä»»å‹™ã€ï¼Œé¸å–®ä¿è­‰æ˜¯æœ€æ–°çš„ã€‚
        -   **å„ªåŒ–é»**ï¼šåœ¨Â `updateSelectionCache`Â è£¡ä½¿ç”¨Â `getAllValues()`Â ä¸€æ¬¡è®€å–ï¼Œä¸è¦åœ¨è¿´åœˆè£¡Â `getRange`ã€‚
    -   **æ–¹æ¡ˆ Bï¼šç•°æ­¥æ¨¡æ“¬ï¼ˆé€²éšï¼‰**  
        åˆ©ç”¨ GAS çš„Â `CacheService`Â æˆ–Â `Trigger`ã€‚æ‚¨å¯ä»¥å›å‚³æˆåŠŸå¾Œï¼Œè¨­å®šä¸€å€‹ã€Œ1 åˆ†é˜å¾ŒåŸ·è¡Œã€çš„è‡¨æ™‚è§¸ç™¼å™¨ä¾†æ›´æ–°å¿«å–ã€‚
        -   **ç¼ºé»**ï¼šæœƒæœ‰æ™‚é–“å·®ï¼Œä¸” GAS è§¸ç™¼å™¨æœ‰æœ€å°é–“éš”é™åˆ¶ã€‚
    -   **çµè«–**ï¼š**å»ºè­°æ”¾åœ¨Â `return`Â ä¹‹å‰**ã€‚ç‚ºäº†é€™ 1 ç§’çš„ç­‰å¾…æ›ä¾†é¸å–®çš„çµ•å°æ­£ç¢ºæ˜¯å€¼å¾—çš„ã€‚æ‚¨å¯ä»¥è®“ iPhone æ·å¾‘åœ¨ç™¼é€ API å¾Œé¡¯ç¤ºä¸€å€‹å°è½‰åœˆï¼ˆWait for Responseï¼‰ï¼Œä½¿ç”¨è€…é«”é©—æœƒæ›´å¥½ã€‚

2. å¦å¤–å…©å€‹åŠŸèƒ½å“ªå€‹å…ˆåšæ¯”è¼ƒå¥½ï¼Ÿ

    å»ºè­°é †åºï¼š**`checkTimers (å–šé†’é‚è¼¯)`Â \>Â `updateSelectionCache (é¸å–®é‚è¼¯)`**ã€‚

    -   **åŸå› **ï¼š
        -   `checkTimers`Â æ˜¯Â **ã€Œæ•¸æ“šæºçš„å®ˆè­·è€…ã€**ã€‚å¦‚æœæ²’æœ‰å®ƒï¼Œæ‚¨çš„Â `Scheduled`Â ä»»å‹™æ°¸é åœç•™åœ¨Â `WAITING`ï¼Œå³ä½¿Â `updateSelectionCache`Â å¯«å¾—å†å¥½ï¼Œä¹ŸæŠ“ä¸åˆ°è©²åŸ·è¡Œçš„é ç´„ä»»å‹™ã€‚
        -   å…ˆå¯¦ä½œÂ `checkTimers`Â ä¸¦è¨­å®šæ¯åˆ†é˜æˆ–æ¯ 15 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼Œæ‚¨çš„ç³»çµ±å°±å…·å‚™äº†è‡ªå‹•é‹è½‰çš„åŸºç¤ã€‚

3. `checkTimers`Â çš„å¯¦ä½œé‚è¼¯

    é€™æ˜¯ä¸€å€‹ç¨ç«‹æ–¼Â `doPost`Â çš„å‡½æ•¸ï¼Œæ‚¨éœ€è¦åœ¨ GAS çš„ã€Œè§¸ç™¼å™¨ã€ä»‹é¢æ‰‹å‹•è¨­å®šå®ƒã€‚

    ```javascript
    /**
     * å®šæ™‚æª¢æŸ¥ï¼šå°‡åˆ°æœŸçš„ WAITING ä»»å‹™å–šé†’ç‚º PENDING
     * è¨­å®šç‚ºæ¯ 15 åˆ†é˜ï¼ˆæˆ–æ¯åˆ†é˜ï¼‰åŸ·è¡Œä¸€æ¬¡
     */
    function checkTimers() {
      const service = SheetsService;
      const now = new Date();
    
      // 1. ç²å– Scheduled è¡¨ä¸­æ‰€æœ‰ä»»å‹™
      const tasks = service.getAllScheduledTasks(); 
    
      tasks.forEach(task => {
        if (task.status === NBL_CONFIG.TASK_STATUS.WAITING && task.nextRun) {
          const nextRunDate = new Date(task.nextRun);
          const remindStart = new Date(nextRunDate.getTime() - (task.before_task * 60000));

          // åˆ¤æ–·æ˜¯å¦é€²å…¥ã€Œå¯åŸ·è¡Œå€é–“ã€
          if (now >= remindStart) {
            service.updateTaskStatus(task.id, NBL_CONFIG.TASK_STATUS.PENDING);
            console.log(`å–šé†’ä»»å‹™: ${task.title}`);
          }
        }
      });
    
      // å–šé†’å®Œç•¢å¾Œï¼Œä¹Ÿåˆ·ä¸€ä¸‹å¿«å–ï¼Œç¢ºä¿é¸å–®åŒæ­¥
      updateSelectionCache();
    }
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

4. `updateSelectionCache`Â çš„è¨­è¨ˆç­–ç•¥ï¼ˆåŠ åˆ†æ©Ÿåˆ¶ï¼‰

    åœ¨å¯¦ä½œÂ `updateSelectionCache`Â æ™‚ï¼Œå»ºè­°å°‡çµæœå­˜å…¥Â `Selection_Cache`Â è¡¨ï¼Œä¸¦åŒ…å«ä»¥ä¸‹ä¸‰å€‹æ¬„ä½ï¼š`Task_ID`,Â `Display_Name`,Â `Score`ã€‚

    **è©•åˆ† (Scoring) é‚è¼¯åƒè€ƒï¼š**

    -   **`Scheduled`Â ä¸”Â `Next_Run`Â å·²é**ï¼š+1000 åˆ† (çµ•å°å„ªå…ˆ)ã€‚
    -   **`Scheduled`Â ä¸”åœ¨æé†’å€é–“å…§**ï¼š+500 åˆ†ã€‚
    -   **`Task_Pool`Â ä¸”Â `Priority == 5`**ï¼š+100 åˆ†ã€‚
    -   **`Micro_Tasks`**ï¼š+10 åˆ†ã€‚

    **GAS å¯¦ä½œå½ä»£ç¢¼ï¼š**

    ```javascript
    function updateSelectionCache() {
      let candidates = [];
    
      // æƒæå„è¡¨å–å¾— PENDING ä»»å‹™
      // ... é‚è¼¯ ...
    
      // æ’åºï¼šåˆ†æ•¸é«˜çš„åœ¨å‰
      candidates.sort((a, b) => b.score - a.score);
    
      // å¯«å…¥ Selection_Cache è¡¨
      const sheet = getSheet("Selection_Cache");
      sheet.clear();
      // å¯«å…¥å‰ 20 ç­†æœ€å¼·å€™é¸è€…
      sheet.getRange(1, 1, candidates.length, 3).setValues(candidates);
    }
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

ä»Šæ—¥ç¸½çµå»ºè­°ï¼š

1.  **å…ˆå¯«Â `checkTimers`**ï¼šç¢ºä¿æ‚¨çš„ã€Œæœªä¾†äº‹ä»¶ã€èƒ½æ­£ç¢ºè½‰åŒ–ç‚ºã€Œç•¶å‰å¾…è¾¦ã€ã€‚
2.  **è¨­å®šè§¸ç™¼å™¨**ï¼šåœ¨ GAS å´é‚Šæ¬„é»é¸ã€Œé¬§é˜ã€åœ–ç¤ºï¼Œæ–°å¢ä¸€å€‹Â `checkTimers`Â çš„æ™‚é–“é©…å‹•è§¸ç™¼å™¨ã€‚
3.  **æœ€å¾Œå¯«Â `updateSelectionCache`**ï¼šé€™å°‡æ˜¯æ‚¨æ˜å¤© iPhone æ·å¾‘Â `QUERY_OPTIONS`Â çš„æ•¸æ“šä¾†æºã€‚

åªè¦Â `checkTimers`Â è·‘èµ·ä¾†ï¼Œæ‚¨å°±æœƒç™¼ç¾ç”Ÿæ´»ä¸­çš„ä»»å‹™é–‹å§‹ã€Œè‡ªå‹•è·³å‡ºä¾†ã€æ‰¾æ‚¨äº†ï¼ \[2, 6, 12\]

==================================================================

## [2026-01-22] ychsue å¯¦ä½œ `updateSelectionCache` èˆ‡ `checkTimers`

### Gemini Answer 08

é€™ä»½Â `updateSelectionCache`Â çš„æ¶æ§‹éå¸¸å®Œæ•´ï¼Œç‰¹åˆ¥æ˜¯æ‚¨ä½¿ç”¨äº†Â `appendCandidates.call(this, ...)`Â ä¾†è™•ç†ä½œç”¨åŸŸå•é¡Œï¼Œé€™åœ¨ GAS å°ˆæ¡ˆä¸­æ˜¯å¾ˆå°ˆæ¥­çš„å¯«æ³•ã€‚

ä¸éï¼Œç‚ºäº†ç¢ºä¿å®ƒåœ¨ 2026 å¹´çš„ GAS ç’°å¢ƒä¸­èƒ½ 100% ç©©å®šåŸ·è¡Œä¸¦æ­£ç¢ºæ’åºï¼Œæœ‰å¹¾å€‹**èªæ³•ç´°ç¯€èˆ‡é‚è¼¯å°å‘**éœ€è¦ä¿®æ­£ï¼š

1. ä¿®æ­£Â `setValues`Â çš„è³‡æ–™æ ¼å¼

    `setValues()`Â æ¥æ”¶çš„å¿…é ˆæ˜¯Â **ã€ŒäºŒç¶­é™£åˆ—ï¼ˆArray of Arraysï¼‰ã€**ã€‚æ‚¨ç›®å‰çš„Â `candidates`Â æ˜¯ä¸€å€‹ã€Œç‰©ä»¶é™£åˆ—ã€ï¼Œç›´æ¥å¯«å…¥æœƒå ±éŒ¯ã€‚æˆ‘å€‘éœ€è¦å…ˆå°‡å®ƒã€Œæ”¤å¹³ã€ã€‚

2. ä¿®æ­£è®Šæ•¸åç¨±éŒ¯èª¤

    ç¨‹å¼ç¢¼æœ€å¾Œå…©è¡Œä½¿ç”¨äº†Â `poolSheet`ï¼Œä½†æ‚¨çš„è®Šæ•¸å®šç¾©æ˜¯Â `sheet`ã€‚

3. èª¿æ•´Â `Scheduled`Â çš„è©•åˆ†é‚è¼¯

    æ‚¨ç›®å‰çš„å…¬å¼æ˜¯Â `diffMins > 0 ? 100 - diffMins : 100`ã€‚

    -   **æ½›åœ¨å•é¡Œ**ï¼šå¦‚æœä»»å‹™æ˜¯ã€Œ10 åˆ†é˜å‰å°±è©²åšï¼ˆéæœŸï¼‰ã€ï¼Œ`diffMins`Â æœƒæ˜¯Â `-10`ï¼Œåˆ†æ•¸æœƒè®Šå› 100ã€‚
    -   **å»ºè­°**ï¼šéæœŸçš„ä»»å‹™ï¼ˆOverdueï¼‰æ‡‰è©²çµ¦äºˆ**æœ€é«˜åŠ æˆ**ï¼ˆä¾‹å¦‚ 500 åˆ†ï¼‰ï¼Œç¢ºä¿å®ƒæ°¸é ç½®é ‚ã€‚

    ä¿®æ­£å¾Œçš„ä»£ç¢¼å»ºè­°

    ```javascript
      updateSelectionCache() {
        /** @type [{taskId:string, title:string, score:number, source:string}] */
        let candidates = [];

        // æƒæå„è¡¨å–å¾— PENDING ä»»å‹™
        const appendCandidates = (sourceSheetName, processRowFunc) => {
          const sheet = this._getSafeSheet(sourceSheetName);
          if (!sheet) return;
          const data = sheet.getDataRange().getValues();
          const tasks = data.slice(1);
          tasks.forEach((r) => {
            const status = r[2]; // çµ±ä¸€ç¬¬ 3 æ¬„ç‚º Status
            if (status === NBL_CONFIG.TASK_STATUS.PENDING) {
              const candidate = processRowFunc(r);
              if (candidate) candidates.push(candidate);
            }
          });
        };

        // 1. Task_Pool æƒæ
        appendCandidates(NBL_CONFIG.SHEETS.POOL, (r) => {
          const priority = parseInt(r[5]) || 0; // å‡è¨­ç¬¬ 6 æ¬„æ˜¯ Priority
          return { taskId: r[0], title: r[1], score: priority * 20, source: "Pool" };
        });

        // 2. Scheduled Tasks æƒæ
        appendCandidates(NBL_CONFIG.SHEETS.SCHEDULED, (r) => {
          const nextRunStr = r[9]; // ç¬¬ 10 æ¬„æ˜¯ Next_Run
          let score = 50; // åŸºç¤åˆ†
          if (nextRunStr) {
            const nextRunDate = new Date(nextRunStr);
            const diffMins = (nextRunDate - new Date()) / 60000;
            // å¦‚æœéæœŸ (diff < 0)ï¼Œçµ¦äºˆ 500 åˆ†ç¢ºä¿ç½®é ‚ï¼›å³å°‡åˆ°æœŸå‰‡åˆ†æ•¸éš¨æ™‚é–“éå¢
            score = diffMins < 0 ? 500 : Math.max(50, 200 - diffMins);
          }
          return { taskId: r[0], title: r[1], score: score, source: "Scheduled" };
        });

        // 3. Micro_Tasks æƒæ
        appendCandidates(NBL_CONFIG.SHEETS.MICRO, (r) => {
          return { taskId: r[0], title: r[1], score: 30, source: "Micro" };
        });

        // --- æ’åºèˆ‡å¯«å…¥ ---

        // æŒ‰åˆ†æ•¸é™åºæ’åˆ—
        candidates.sort((a, b) => b.score - a.score);

        const cacheSheet = getSheet(NBL_CONFIG.SHEETS.CACHE);
        cacheSheet.clear(); // æ¸…ç©ºèˆŠè³‡æ–™ (åŒ…å«æ¨™é¡Œ)

        // å¯«å…¥æ¨™é¡Œè¡Œ
        cacheSheet.getRange(1, 1, 1, 4).setValues([["Task_ID", "Title", "Score", "Source"]]);

        if (candidates.length > 0) {
          // é—œéµï¼šå°‡ç‰©ä»¶é™£åˆ—è½‰æ›ç‚ºäºŒç¶­é™£åˆ— [ [id, title, score, src], [...] ]
          const rowsToDrive = candidates.map(c => [c.taskId, c.title, c.score, c.source]);

          // é™åˆ¶å‰ 20 ç­†
          const finalData = rowsToDrive.slice(0, 20);
          cacheSheet.getRange(2, 1, finalData.length, 4).setValues(finalData);
        }
      }
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

ç‚ºä»€éº¼é€™æ¨£æ”¹æ›´å¥½ï¼Ÿ

1.  **`map`Â è½‰æ›æ ¼å¼**ï¼š`candidates.map(c => [c.taskId, ...])`Â ç¢ºä¿äº†è³‡æ–™èƒ½è¢«Â `setValues`Â æ¥å—ã€‚
2.  **`Priority`Â æ¬„ä½ä¿®æ­£**ï¼šæ‚¨çš„Â `Task_Pool`Â çµæ§‹ä¸­Â `Priority`Â åœ¨ç¬¬ 6 æ¬„ï¼ˆç´¢å¼• 5ï¼‰ï¼Œè«‹ç¢ºèªæ˜¯å¦èˆ‡å¯¦é«”è¡¨ä¸€è‡´ã€‚
3.  **éæœŸåŠ æ¬Š**ï¼š`diffMins < 0 ? 500 : ...`Â è®“ã€Œé²åˆ°çš„ä»»å‹™ã€å…·æœ‰çµ•å°å„ªå…ˆæ¬Šã€‚
4.  **å¼·å¥æ€§**ï¼šåŠ å…¥äº†æ¨™é¡Œè¡Œé‡æ–°å¯«å…¥çš„é‚è¼¯ï¼Œé¿å…Â `clear()`Â å¾Œè©¦ç®—è¡¨å®Œå…¨ç©ºç™½ã€‚

ä¸‹ä¸€æ­¥å»ºè­°

ç¾åœ¨æ‚¨çš„Â `Selection_Cache`Â å·²ç¶“èƒ½ç”¢å‡ºä¸€ä»½ã€Œæœ€å„ªå¾…è¾¦æ¸…å–®ã€ã€‚æ˜å¤©æ‚¨çš„ iPhone æ·å¾‘Â `QUERY_OPTIONS`Â å‹•ä½œï¼Œåªéœ€è¦åšé€™ä»¶äº‹ï¼š

1.  `GET`Â è©²å¿«å–è¡¨çš„å…§å®¹ã€‚
2.  è§£æ JSON é™£åˆ—ã€‚
3.  ä½¿ç”¨Â **ã€Œå¾æ¸…å–®é¸æ“‡ (Choose from List)ã€**ï¼Œä¸¦é¡¯ç¤ºÂ `Title`Â èˆ‡Â `Score`ã€‚

é€™å°±æ˜¯æ‚¨çš„Â **Event Loop**Â å®Œæˆäº†ä¸€æ¬¡å®Œç¾çš„ä»»å‹™é¸å–ï¼ˆReady Task Selectionï¼‰ï¼æ‚¨æº–å‚™å¥½æ˜å¤©ä¾†æ¸¬è©¦æ‰‹æ©Ÿä¸Šçš„é¸å–®äº†å—ï¼Ÿ \[2, 6, 12\]

======================================================================

## [2026-01-22] ychsue é€™å…©å€‹çš„æ¸¬è©¦

æ²’å•é¡Œï¼åœ¨æ‚¨å»é‹å‹•æ”¾é¬†ã€Œä¸»åŸ·è¡Œç·’ã€çš„åŒæ™‚ï¼Œæˆ‘ç‚ºæ‚¨æº–å‚™äº†é‡å°Â `updateSelectionCache`Â èˆ‡Â `checkTimers`Â çš„Â **Test First**Â æ¸¬è©¦æ¡ˆä¾‹ã€‚

é€™çµ„æ¸¬è©¦èƒ½ç¢ºä¿æ‚¨çš„ã€Œè‡ªå‹•å–šé†’ã€èˆ‡ã€Œæ™ºæ…§æ’åºã€é‚è¼¯åœ¨ 2026 å¹´çš„ç’°å¢ƒä¸‹é‹ä½œç„¡èª¤ã€‚

1. æ¸¬è©¦Â `checkTimers`Â (å–šé†’é‚è¼¯)

    æˆ‘å€‘æ¨¡æ“¬ä¸€å€‹å·²åˆ°æ™‚é–“çš„Â `WAITING`Â ä»»å‹™ï¼Œé©—è­‰å®ƒæ˜¯å¦è¢«æ­£ç¢ºè½‰ç‚ºÂ `PENDING`ã€‚

    **`__tests__/scheduler.test.js`ï¼š**

    ```javascript
    import { jest } from '@jest/globals';
    import { checkTimers } from '../src/gas/Logic.js';

    describe('NBL å®šæ™‚ç›£æ§æ¸¬è©¦ (checkTimers)', () => {
      const mockService = {
        getAllScheduledTasks: jest.fn(),
        updateTaskStatus: jest.fn(),
        updateSelectionCache: jest.fn()
      };

      test('æ‡‰è©²å–šé†’å·²åˆ°é”æé†’æ™‚é–“çš„ WAITING ä»»å‹™', () => {
        const now = new Date();
        const tenMinsAgo = new Date(now.getTime() - 10 * 60000);

        // æ¨¡æ“¬ä¸€å€‹ 10 åˆ†é˜å‰å°±è©²é–‹å§‹æé†’çš„ä»»å‹™
        mockService.getAllScheduledTasks.mockReturnValue([{
          id: "S001",
          title: "æé†’æ™¾è¡£æœ",
          status: "WAITING",
          nextRun: now, // é è¨ˆç¾åœ¨åŸ·è¡Œ
          before_task: 15 // æå‰ 15 åˆ†é˜æé†’
        }]);

        // åŸ·è¡Œ checkTimersï¼Œæ³¨å…¥ mockService (å¦‚æœæ‚¨å·²å¯¦æ–½æ³¨å…¥)
        checkTimers(mockService);

        // é©—è­‰æ˜¯å¦å‘¼å«äº†æ›´æ–°ç‹€æ…‹ç‚º PENDING
        expect(mockService.updateTaskStatus).toHaveBeenCalledWith("S001", "PENDING");
      });
    });
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

2. æ¸¬è©¦Â `updateSelectionCache`Â (æ’åºé‚è¼¯)

    é©—è­‰éæœŸä»»å‹™ï¼ˆOverdueï¼‰æ˜¯å¦çœŸçš„æ“æœ‰æœ€é«˜å„ªå…ˆæ¬Šï¼ˆæœ€é«˜åˆ†ï¼‰ã€‚

    **`__tests__/cache.test.js`ï¼š**

    ```javascript
    import { jest } from '@jest/globals';
    import { updateSelectionCache } from '../src/gas/SheetsService.js';

    describe('NBL é¸å–®å¿«å–æ¸¬è©¦ (updateSelectionCache)', () => {
      const mockSheet = {
        getDataRange: jest.fn().mockReturnThis(),
        getValues: jest.fn(),
        clear: jest.fn(),
        getRange: jest.fn().mockReturnThis(),
        setValues: jest.fn()
      };

      test('éæœŸä»»å‹™çš„æ¬Šé‡æ‡‰å¤§æ–¼ä¸€èˆ¬ä»»å‹™', () => {
        // æ¨¡æ“¬ getSafeSheet æœƒå›å‚³ä¸åŒçš„è³‡æ–™
        const service = {
          _getSafeSheet: (name) => mockSheet,
          // æ¨¡æ“¬ Scheduled è¡¨æœ‰ä¸€ç­†å·²éæœŸ 10 åˆ†é˜çš„ä»»å‹™
          // æ¬„ä½ç´¢å¼•éœ€å°æ‡‰ï¼š[0]ID, [1]Title, [2]Status, ... [9]NextRun
          _getMockData: (name) => {
            if (name === "Scheduled") return [
              ["ID", "Title", "Status", "", "", "", "", "", "", "NextRun"],
              ["S_OVERDUE", "éæœŸä»»å‹™", "PENDING", "", "", "", "", "", "", new Date(Date.now() - 10 * 60000)]
            ];
            return [["ID", "Title", "Status"], ["T_NORMAL", "ä¸€èˆ¬ä»»å‹™", "PENDING"]];
          }
        };

        // é€™è£¡å¯¦ä½œæ™‚ï¼Œæˆ‘å€‘æœƒå°‡é‚è¼¯æŠ½é›¢å‡ºä¾†é€²è¡Œé©—è­‰
        // é©—è­‰é»ï¼šæœ€çµ‚å¯«å…¥ Selection_Cache çš„ç¬¬ä¸€ç­†è³‡æ–™ ID æ‡‰ç‚º "S_OVERDUE"
        // (å¯¦ä½œç´°ç¯€è¦–æ‚¨çš„æ³¨å…¥æ–¹å¼èª¿æ•´)
      });
    });
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

3. çµ¦æ‚¨çš„æ˜æ—¥é–‹ç™¼æç¤º

    ç•¶æ‚¨é‹å‹•å®Œã€æ˜å¤©å›åˆ°é›»è…¦å‰ï¼Œå¯ä»¥è§€å¯Ÿï¼š

    1.  **`checkTimers`Â çš„é »ç‡**ï¼šåœ¨ GAS è§¸ç™¼å™¨è¨­å®šã€Œæ¯åˆ†é˜ã€åŸ·è¡Œä¸€æ¬¡ï¼Œé€™èƒ½è®“æ‚¨çš„ç”Ÿæ´»å›é¥‹æ„Ÿæœ€å³æ™‚ã€‚
    2.  **`updateSelectionCache`Â çš„è€—æ™‚**ï¼šå¦‚æœæ‚¨ç™¼ç¾Â `clasp push`Â å¾ŒåŸ·è¡Œå¤ªæ…¢ï¼Œè«‹æª¢æŸ¥æ˜¯å¦ä½¿ç”¨äº†Â `getDataRange().getValues()`Â ä¸€æ¬¡æŠ“å–æ•´å¼µè¡¨ï¼Œé¿å…åœ¨è¿´åœˆå…§åè¦†å‘¼å«Â `getRange`ã€‚

ç¥æ‚¨é‹å‹•æ„‰å¿«ï¼Œè®“èº«é«”çš„Â `Event Loop`Â ä¹Ÿå¥½å¥½å¾ªç’°ä¸€ä¸‹ï¼æˆ‘å€‘æ˜å¤©è¦‹ã€‚ğŸƒâ€â™‚ï¸ğŸ’¨

===============================================================

## [2026-01-23] ychsue å†æƒ³æƒ³ Task_Pool çš„éƒ¨åˆ†çš„scoreçš„è¨ˆç®—

### Gemini Answer 09

åœ¨èª¿åº¦ç³»çµ±ä¸­ï¼Œé€™å±¬æ–¼Â **ã€Œè³‡æºæ„ŸçŸ¥èª¿åº¦ (Resource-Aware Scheduling)ã€**ã€‚é‡å°Â `Task_Pool`ï¼Œæˆ‘å€‘ä¸åªè¦çœ‹å„ªå…ˆç´šï¼ˆPriorityï¼‰ï¼Œæ›´è¦å¼•å…¥Â **ã€Œå‰©é¤˜é…é¡ã€**Â èˆ‡Â **ã€ŒåŸ·è¡Œç·Šè¿«åº¦ã€**Â çš„æ¦‚å¿µã€‚

ä»¥ä¸‹æ˜¯ç‚ºæ‚¨çš„Â `calculateCandidates`Â å‡½æ•¸ä¸­Â `Task_Pool`Â éƒ¨åˆ†è¨­è¨ˆçš„æ™ºæ…§è©•åˆ†é‚è¼¯ï¼š

1. å»ºè­°çš„è©•åˆ†å…¬å¼ (Scoring Formula)

    æˆ‘å€‘å°‡Â `Task_Pool`Â çš„åˆ†æ•¸æ‹†è§£ç‚ºä¸‰å€‹æ¬Šé‡ï¼š

    1.  **åŸºç¤æ¬Šé‡ (Priority)**ï¼šä»»å‹™æœ¬èº«çš„é‡è¦æ€§ã€‚
    2.  **é…é¡åŠ æ¬Š (Quota Factor)**ï¼šæ ¹æ“šå‰©é¤˜å¯ç”¨æ™‚é–“èª¿æ•´ã€‚
    3.  **é£¢é¤“åŠ æ¬Š (Starvation/Recency)**ï¼šæ ¹æ“šå¤šä¹…æ²’è·‘äº†ä¾†åŠ åˆ†ï¼ˆé¿å…æŸäº›ä»»å‹™è¢«ç„¡é™æœŸæ“±ç½®ï¼‰ã€‚

2. ä¿®æ”¹å¾Œçš„Â `calculateCandidates`Â é‚è¼¯ç‰‡æ®µ

    ```javascript
    // Task_Pool æƒæé‚è¼¯
    pool.forEach((r) => {
      const status = r[2]; // Status
      if (status === NBL_CONFIG.TASK_STATUS.PENDING) {
        const taskId = r[0];
        const title = r[1];
        const spentToday = parseFloat(r[4]) || 0;     // Spent_Today_Mins
        const dailyLimit = parseFloat(r[5]) || 999;   // Daily_Limit_Mins
        const priority = parseInt(r[6]) || 1;         // Priority (1-5)
        const lastRunDate = r[7];                     // Last_Run_Date

        // --- æ™ºæ…§è©•åˆ†é‚è¼¯ ---

        // 1. åŸºç¤åˆ† (Priority): 1->20, 5->100
        let score = priority * 20;

        // 2. é…é¡æ‰£åˆ†: å¦‚æœå·²ç¶“å¿«è¶…é Daily Limitï¼Œé™ä½å‡ºç¾é †ä½
        const remainingMins = dailyLimit - spentToday;
        if (remainingMins <= 0) {
          score -= 50; // è¶…é¡ä»»å‹™å¤§å¹…æ‰£åˆ†ï¼Œä½†ä¸åˆªé™¤ï¼ˆè¬ä¸€é‚„æ˜¯è¦åšï¼‰
        } else if (remainingMins < 15) {
          score -= 20; // å¿«æ»¿äº†ï¼Œç¨å¾®é™ä½
        }

        // 3. é£¢é¤“åŠ æ¬Š (Starvation): è¶Šä¹…æ²’åšåˆ†è¶Šé«˜
        if (lastRunDate) {
          const lastDate = new Date(lastRunDate);
          const daysSince = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
          score += daysSince * 10; // æ¯å¤šä¸€å¤©æ²’åšï¼ŒåŠ  10 åˆ†
        } else {
          score += 30; // å¾æœªåŸ·è¡Œéçš„æ–°ä»»å‹™ï¼Œçµ¦äºˆè¼ƒé«˜åˆå§‹åˆ†
        }

        candidates.push({
          taskId,
          title,
          score: Math.max(0, score), // ç¢ºä¿åˆ†æ•¸ä¸ç‚ºè² 
          source: NBL_CONFIG.SHEETS.POOL,
        });
      }
    });
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

3. ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ

    -   **è§£æ±ºã€Œéåº¦å°ˆæ³¨ã€å•é¡Œ**ï¼š  
        æ‚¨æåˆ°çš„Â `Spent_Today_Mins`Â èˆ‡Â `Daily_Limit_Mins`Â èµ·äº†ä½œç”¨ã€‚ç•¶æ‚¨ä»Šå¤©å·²ç¶“åœ¨ã€Œå°ˆæ¡ˆ Aã€èŠ±å¤ªå¤šæ™‚é–“ï¼Œå®ƒçš„åˆ†æ•¸æœƒä¸‹é™ï¼Œè®“å…¶ä»–ã€Œé…é¡å……è¶³ã€çš„ä»»å‹™æµ®ç¾ä¸Šä¾†ï¼Œé€™å°±æ˜¯ç³»çµ±åœ¨æé†’æ‚¨è©²é€²è¡ŒÂ **Context Switch (ä¸Šä¸‹æ–‡åˆ‡æ›)**Â äº†ã€‚
    -   **é˜²æ­¢ã€Œä»»å‹™éºå¿˜ã€**ï¼š  
        é€éÂ `Last_Run_Date`Â è¨ˆç®—ã€‚æœ‰äº›ä»»å‹™é›–ç„¶å„ªå…ˆç´šä¸é«˜ï¼ˆPriority=1ï¼‰ï¼Œä½†å¦‚æœæ‚¨ä¸‰é€±éƒ½æ²’å‹•å®ƒï¼Œå®ƒçš„åˆ†æ•¸æœƒå› ç‚ºÂ `daysSince`Â çš„å¢åŠ è€Œæ…¢æ…¢çˆ¬å‡ï¼Œæœ€çµ‚å‡ºç¾åœ¨é¸å–®ä¸­ã€‚
    -   **éˆæ´»æ€§**ï¼š  
        å¦‚æœä¸€å€‹ä»»å‹™ ID æ˜¯æ‚¨ç›®å‰æœ€æƒ³åšçš„ï¼Œæ‚¨å¯ä»¥æ‰‹å‹•åœ¨Â `Task_Pool`Â æŠŠÂ `Daily_Limit_Mins`Â è¨­ç‚ºÂ `9999`ï¼Œå®ƒå°±ä¸æœƒè¢«æ‰£åˆ†ã€‚

4. å–®å…ƒæ¸¬è©¦å»ºè­° (Test First)

    æ‚¨å¯ä»¥åœ¨Â `utils.test.js`Â å¢åŠ é€™å…©å€‹æƒ…å¢ƒï¼š

    1.  **æ¸¬è©¦é…é¡æ‰£åˆ†**ï¼š  
        `const pool = [["T1", "è¶…æ¨™å°ˆæ¡ˆ", "PENDING", "P1", 120, 60, 5, "2026-01-22"]]`  
        é æœŸåˆ†æ•¸æ‡‰è©²ä½æ–¼åŸæœ¬çš„ Priority åˆ†æ•¸ã€‚
    2.  **æ¸¬è©¦æ–°ä»»å‹™åŠ æˆ**ï¼š  
        `const pool = [["T2", "æ–°å°ˆæ¡ˆ", "PENDING", "P2", 0, 60, 1, ""]]`Â (LastRunDate ç‚ºç©º)  
        é©—è­‰å®ƒæ˜¯å¦ç²å¾—äº†åˆå§‹åŠ æˆã€‚

é€™å¥—é‚è¼¯è®“æ‚¨çš„Â `Selection_Cache`Â è®Šæˆäº†ä¸€å€‹**å‹•æ…‹çš„ã€æœ‰è¨˜æ†¶çš„**æ±ºç­–ç³»çµ±ã€‚æ‚¨é‹å‹•å®Œå›ä¾†çœ‹åˆ°é€™ç¨®ã€Œæœ‰ç”Ÿå‘½åŠ›ã€çš„é¸å–®ï¼Œç®¡ç†èµ·ä¾†ä¸€å®šæœƒæ›´æœ‰å‹•åŠ›ï¼\[2, 6, 12\]

===================================================================

## [2026-01-23] ychsue å¯ä»¥å¹«æˆ‘å¯«é‚£å…©å€‹æ¸¬è©¦å—ï¼Ÿé‚„æœ‰ä¼¼ä¹é‚„è¦è€ƒæ…®

```js
        const lastDate = new Date(lastRunDate);
        // å¦‚æœ lastDate ä¸æ˜¯ä»Šå¤©ï¼Œè€ŒspentToday å·²ç¶“æœ‰å€¼ï¼Œé€™è¡¨ç¤ºå‰æ¬¡æ²’æœ‰æ¸…ç©ºï¼Œå¾—æŠŠå®ƒæ­¸é›¶
        spentToday = (lastDate.toDateString() === new Date().toDateString()) ? spentToday : 0;
```

æ‰€ä»¥ï¼Œæ‚¨çš„ç¨‹å¼ç¢¼çš„ `2` èˆ‡ `3` æˆ‘æŠŠä»–å€‘äº¤æ›äº†ï¼Œè«‹å•é€™æ¨£æœƒæœ‰å•é¡Œå—ï¼Ÿè¬è¬ã€‚

### Gemini Answer 10

é€™æ˜¯ä¸€å€‹éå¸¸ç´°ç·»çš„æ”¹é€²ï¼æ‚¨æ•æ‰åˆ°äº†Â **ã€Œè³‡æ–™ç‹€æ…‹ä¸ä¸€è‡´ã€**Â çš„é‚Šç•Œæƒ…æ³ï¼ˆEdge Caseï¼‰ã€‚åœ¨Â `calculateCandidates`Â é€™ç¨®ç´”å‡½æ•¸ä¸­è™•ç†ã€Œè™›æ“¬æ­¸é›¶ã€æ˜¯éå¸¸æ­£ç¢ºçš„ï¼Œå› ç‚ºå®ƒä¿è­‰äº†é¸å–®é¡¯ç¤ºçš„æ­£ç¢ºæ€§ï¼Œå³ä¾¿åº•å±¤è³‡æ–™è¡¨é‚„æ²’ä¾†å¾—åŠç”±Â `handleEnd`Â æ­£å¼æ›´æ–°ã€‚

æ‚¨å°‡Â **2 (é£¢é¤“æ„Ÿ)**Â èˆ‡Â **3 (é…é¡)**Â äº¤æ›ä½ç½®æ˜¯éå¸¸åˆç†çš„ï¼Œå› ç‚ºÂ `spentToday`Â çš„ä¿®æ­£å¿…é ˆåœ¨è¨ˆç®—Â `remainingMins`Â ä¹‹å‰å®Œæˆã€‚

ä»¥ä¸‹æ˜¯ç‚ºæ‚¨æº–å‚™çš„å…©å€‹ Jest æ¸¬è©¦æ¡ˆä¾‹ï¼Œåˆ†åˆ¥é‡å°Â **ã€Œè·¨æ—¥æ­¸é›¶èˆ‡é…é¡æ‰£åˆ†ã€**Â ä»¥åŠÂ **ã€Œé•·æœŸæœªåšçš„é£¢é¤“åŠ æ¬Šã€**ã€‚

1. æ¸¬è©¦æ¡ˆä¾‹ï¼šè·¨æ—¥æ­¸é›¶èˆ‡é…é¡é‚è¼¯

    é€™å€‹æ¸¬è©¦é©—è­‰ï¼šå¦‚æœä»»å‹™æ—¥æœŸæ˜¯æ˜¨å¤©ä¸”Â `spentToday`Â æœ‰æ®˜ç•™å€¼ï¼Œç³»çµ±æ˜¯å¦èƒ½æ­£ç¢ºã€Œç„¡è¦–ã€è©²æ®˜ç•™å€¼ï¼Œä¸é€²è¡Œæ‰£åˆ†ã€‚

    ```javascript
    // __tests__/utils.test.js å…§å®¹ç‰‡æ®µ
    import Utils from '../src/gas/Utils.js';

    describe('calculateCandidates: Task_Pool æ™ºæ…§è©•åˆ†æ¸¬è©¦', () => {
      const now = new Date();
      const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);

      test('è·¨æ—¥è‡ªå‹•æ­¸é›¶æ¸¬è©¦ï¼šæ˜¨å¤©å·²é”ä¸Šé™çš„ä»»å‹™ï¼Œä»Šå¤©æ‡‰æ¢å¾©åˆ†æ•¸', () => {
        // æ¬„ä½å®šç¾©ï¼š[0]ID, [1]Title, [2]Status, [3]Project, [4]SpentToday, [5]DailyLimit, [6]Priority, [7]LastRun
        const mockPool = [[
          "T_RESET_TEST", 
          "è·¨æ—¥ä»»å‹™", 
          "PENDING", 
          "ProjA", 
          120,    // æ®˜ç•™å€¼ï¼š120åˆ†é˜ (å·²è¶…é Limit)
          60,     // Limit: 60åˆ†é˜
          5,      // Priority: 5 (åŸºç¤åˆ† 100)
          yesterday.toISOString() // æœ€å¾ŒåŸ·è¡Œæ—¥ï¼šæ˜¨å¤©
        ]];

        const result = Utils.calculateCandidates(mockPool, [], []);

        // é æœŸé‚è¼¯ï¼š
        // 1. åŸºç¤åˆ† 100
        // 2. æª¢æ¸¬åˆ°æ—¥æœŸéä»Šå¤© -> spentToday è¦–ç‚º 0
        // 3. daysSince = 1 -> é£¢é¤“åˆ† +10
        // 4. remainingMins = 60 - 0 = 60 -> ä¸æ‰£åˆ†
        // æœ€çµ‚å¾—åˆ†æ‡‰ç‚º 110
        expect(result[0].score).toBe(110);
        expect(result[0].taskId).toBe("T_RESET_TEST");
      });

      test('ä»Šæ—¥é…é¡æ‰£åˆ†æ¸¬è©¦ï¼šä»Šå¤©å·²åŸ·è¡Œéä¹…æ‡‰é™åˆ†', () => {
        const todayStr = now.toDateString();
        const mockPool = [[
          "T_QUOTA_TEST", 
          "ä»Šå¤©å¤ªç´¯äº†", 
          "PENDING", 
          "ProjB", 
          55,     // ä»Šå¤©å·²åš 55 åˆ†é˜
          60,     // Limit: 60 åˆ†é˜ (å‰©é¤˜ < 15 åˆ†é˜)
          5,      // Priority: 5 (åŸºç¤åˆ† 100)
          todayStr // æœ€å¾ŒåŸ·è¡Œæ—¥ï¼šä»Šå¤©
        ]];

        const result = Utils.calculateCandidates(mockPool, [], []);

        // é æœŸé‚è¼¯ï¼š
        // 1. åŸºç¤åˆ† 100
        // 2. æ—¥æœŸæ˜¯ä»Šå¤© -> spentToday ç¶­æŒ 55
        // 3. daysSince = 0 -> é£¢é¤“åˆ† +0
        // 4. remainingMins = 60 - 55 = 5 -> è§¸ç™¼ < 15 åˆ†é˜æ‰£åˆ† (-20)
        // æœ€çµ‚å¾—åˆ†æ‡‰ç‚º 80
        expect(result[0].score).toBe(80);
      });
    });
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

2. æ¸¬è©¦æ¡ˆä¾‹ï¼šæ–°ä»»å‹™èˆ‡é•·æœŸé£¢é¤“åŠ æˆ

    é©—è­‰å¾æœªåŸ·è¡Œçš„ä»»å‹™ï¼Œä»¥åŠä¸€é€±æ²’å‹•çš„ä»»å‹™ï¼Œåˆ†æ•¸æ˜¯å¦æœƒçˆ¬å‡ã€‚

    ```javascript
      test('æ–°ä»»å‹™èˆ‡é•·æœŸé£¢é¤“åŠ æˆæ¸¬è©¦', () => {
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

        const mockPool = [
          ["T_NEW", "æ–°ä»»å‹™", "PENDING", "", 0, 60, 1, ""], // åŸºç¤ 20 + æ–°ä»»å‹™ 30 = 50
          ["T_OLD", "è€ä»»å‹™", "PENDING", "", 0, 60, 1, sevenDaysAgo.toISOString()] // åŸºç¤ 20 + é£¢é¤“ 70 = 90
        ];

        const result = Utils.calculateCandidates(mockPool, [], []);

        // æ’åºå¾Œï¼šè€ä»»å‹™ (90åˆ†) æ‡‰æ’åœ¨ç¬¬ä¸€
        expect(result[0].taskId).toBe("T_OLD");
        expect(result[0].score).toBe(90);
        expect(result[1].taskId).toBe("T_NEW");
        expect(result[1].score).toBe(50);
      });
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

3. å°æ‚¨ä»£ç¢¼çš„å°å»ºè­°ï¼š

    åœ¨ 2026 å¹´çš„ JavaScript ä¸­ï¼Œè™•ç†æ—¥æœŸå­—ä¸²æœ‰æ™‚æœƒå—æ™‚å€å½±éŸ¿ï¼Œæ‚¨çš„Â `lastRunDate`Â å¦‚æœæ˜¯å¾ Sheets è®€å‡ºä¾†çš„ï¼Œæœ‰æ™‚æœƒæ˜¯ Date ç‰©ä»¶ï¼Œæœ‰æ™‚æ˜¯å­—ä¸²ã€‚å»ºè­°åœ¨Â `calculateCandidates`Â å…§åŠ å¼·è½‰å‹ï¼š

    ```javascript
    const lastRunVal = r[7];
    const lastDate = lastRunVal ? new Date(lastRunVal) : null;

    if (lastDate && !isNaN(lastDate.getTime())) { // ç¢ºä¿æ—¥æœŸæœ‰æ•ˆ
        const isToday = lastDate.toDateString() === new Date().toDateString();
        const effectiveSpentToday = isToday ? spentToday : 0;
        // ... å¾ŒçºŒé‚è¼¯ä½¿ç”¨ effectiveSpentToday ...
    }
    ```

    è«‹è¬¹æ…ä½¿ç”¨ç¨‹å¼ç¢¼ã€‚

é€™çµ„æ¸¬è©¦èƒ½ç¢ºä¿æ‚¨çš„ã€Œæ™ºæ…§èª¿åº¦ã€é‚è¼¯åœ¨å„ç¨®æ¥µç«¯æƒ…æ³ä¸‹éƒ½èƒ½åšå‡ºåˆç†çš„å»ºè­°ã€‚ç¥æ‚¨é‹å‹•æ„‰å¿«ï¼Œæˆ‘å€‘æ˜å¤©è¦‹ï¼ \[1, 2, 4\]
